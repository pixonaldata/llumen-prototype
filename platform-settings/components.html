<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Components - Platform Settings - Crimson</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <link rel="stylesheet" href="../css/styles.css">
    
    <style>
        /* Drag and Drop Styles */
        .draggable-row {
            cursor: move;
            transition: all 0.2s ease;
        }
        
        .draggable-row.dragging {
            opacity: 0.5;
        }
        
        .drop-zone {
            position: relative;
        }
        
        /* .drop-zone.drag-over {
            border-top: 2px solid #ef4444;
        } */
        
        .drop-zone.drag-over::before {
            content: '';
            position: absolute;
            top: -5px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #ef4444;
        }
        
        .non-draggable {
            cursor: default;
        }
        
        .non-draggable:hover {
            background-color: transparent;
        }
        
        .drag-handle {
            cursor: move;
            color: #9ca3af;
            transition: color 0.2s ease;
        }
        
        .drag-handle:hover {
            color: #ef4444;
        }

        .key-value-row.readonly .drag-handle,
        .key-value-row.readonly .toggle-switch-container,
        .key-value-row.readonly .delete-button-container {
            display: none;
        }

        /* ===== CUSTOM TOOLTIP STYLES ===== */
        .validation-tooltip {
            position: absolute;
            background-color: #080808;
            color: #fff;
            padding: 0.5rem 0.75rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            max-width: 200px;
            white-space: normal;
            word-wrap: break-word;
            z-index: 60;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-in-out;
            text-align: center;
        }

        .validation-tooltip.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div id="crimson-app" class="bg-gray-900">
        <header class="bg-gray-800 py-4 px-4 md:px-8 flex items-center justify-between shadow-lg sticky top-0 z-30">
            <!-- Left-aligned group: Logo, divider, client logo, and navigation -->
            <div class="flex items-center">
                <a href="../index.html">
                    <div class="w-9 h-9 flex items-center justify-center rounded-lg overflow-hidden">
                        <svg viewBox="0 0 32 32" class="w-full h-full">
                            <circle cx="16" cy="16" r="16" fill="#dc2626" /> <circle cx="16" cy="16" r="8" fill="#ffffff" />
                        </svg>
                    </div>
                </a>
                <div class="h-9 border-l border-gray-600 ml-4"></div> <!-- Added ml-4 for spacing -->
                <a href="../index.html">
                    <div class="flex items-center justify-center px-3 py-1 rounded-lg bg-[#1a1a1a] text-white text-sm font-semibold h-9 ml-4"> <!-- Added ml-4 for spacing -->
                        <span>Client Logo</span>
                    </div>
                </a>
                <!-- New Navigation Menu - now directly next to client logo with controlled spacing -->
                <!-- <nav class="flex items-center ml-4">
                    <a href="index.html" class="px-3 py-2 rounded-md text-sm font-bold text-white transition duration-200">My Workspaces</a>
                    <a href="explore.html" class="px-3 py-2 rounded-md text-sm text-gray-400 hover:text-white transition duration-200">Explore</a>
                </nav> -->
                <div class="flex items-center bg-gray-700 rounded-lg w-[20rem] ml-4">
                    <svg class="w-5 h-5 text-gray-400 ml-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <input type="text" placeholder="Search..." class="bg-transparent text-white pl-2 pr-4 py-2 w-full focus:outline-none placeholder-gray-400 text-sm">
                </div>
            </div>

            <!-- Right-aligned group of icons and user dropdown -->
            <div class="flex items-center">
                <!-- Create Dropdown -->
                <div class="relative mr-4">
                    <button id="create-dropdown-button" class="flex items-center bg-gray-700 hover:bg-gray-600 text-white transition duration-200 focus:outline-none px-3 pl-2.5 py-2 rounded-md">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        <span class="text-sm font-medium">Create</span>
                    </button>
                    <div id="create-dropdown-menu" class="options-dropdown-menu hidden">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150" onclick="openCreateContentModal('Briefing'); return false;">Briefing</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150" onclick="openCreateContentModal('Story'); return false;">Story</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150" onclick="openCreateContentModal('Dashboard'); return false;">Dashboard</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150" onclick="openCreateContentModal('Whiteboard'); return false;">Whiteboard</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Workspace</a>
                    </div>
                </div>

                <!-- Replaced original search button with the search container -->
                <div id="search-container" class="relative flex items-center mr-3 hidden">
                    <button id="search-icon-button" class="w-8 h-8 flex items-center justify-center text-gray-300 hover:text-red-400 rounded-full transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-red-500 z-10">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </button>
                    <div id="search-input-wrapper" class="absolute right-0 flex items-center bg-gray-700 rounded-full overflow-hidden transition-all duration-300 ease-in-out">
                        <svg class="w-5 h-5 text-gray-400 ml-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        <input type="text" id="header-search-input" placeholder="Search..." class="bg-transparent text-white pl-2 pr-4 py-2 w-full focus:outline-none placeholder-gray-400 text-sm">
                    </div>
                </div>

                <!-- Notification Icon Button with margin-left for spacing from search -->
                <button class="notifications-button round-button mr-4">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                </button>
                
                <!-- User Dropdown with specific margins -->
                <div class="relative">
                    <button id="user-dropdown-button" class="user-dropdown-button round-button bg-gray-600 hover:bg-gray-500">
                        <span class="">J</span>
                    </button>
                    <div id="user-dropdown-menu" class="options-dropdown-menu hidden">
                        <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Account Settings</a>
                        <a href="../platform-settings/overview.html" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Platform Settings</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Help</a>
                        <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Logout</a>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Layout with Sidebar and Content -->
        <div class="flex flex-1">
            <!-- Vertical Sidebar Navigation -->
            <aside class="w-56 bg-gray-800 border-r border-gray-700 sidebar-nav">
                <div class="px-4 py-5">
                    <h1 class="text-xl font-bold text-white mb-5">Platform Settings</h1>
                    
                    <!-- Navigation Menu -->
                    <nav class="space-y-3">
                        <a href="overview.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200 mb-0">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">admin_panel_settings</span>
                                Overview
                            </div>
                        </a>
                        
                        <a href="components.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200 active">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">grid_view</span>
                                Components
                            </div>
                        </a>
                        
                        <a href="filters.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">filter_list</span>
                                Filters
                            </div>
                        </a>

                        <a href="data-sources.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">storage</span>
                                Data Sources
                            </div>
                        </a>
                        
                        <a href="global-variables.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">tune</span>
                                Global Variables
                            </div>
                        </a>
                        
                        <a href="workspaces.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">workspaces</span>
                                Workspaces
                            </div>
                        </a>
                        
                        <a href="users.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">group</span>
                                Users
                            </div>
                        </a>
                        
                        <a href="security.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">security</span>
                                Security
                            </div>
                        </a>
                        
                        <a href="reporting.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">analytics</span>
                                Reporting
                            </div>
                        </a>
                        
                        <a href="billing.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">receipt_long</span>
                                Billing
                            </div>
                        </a>
                        
                        <a href="theme.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">palette</span>
                                Theme
                            </div>
                        </a>
                            
                        <a href="organization.html" class="platform-nav-item w-full text-left px-4 py-2 text-sm text-gray-300 hover:text-white transition duration-200">
                            <div class="flex items-center">
                                <span class="material-symbols-outlined mr-3 text-lg">business</span>
                                Organization
                            </div>
                        </a>
                    </nav>
                </div>
            </aside>

            <!-- Main Content Area -->
            <main class="flex-1 main-content-area">
                <!-- Components Tab Content -->
                <div id="components-content" class="tab-content" style="height: calc(100vh - 68px);">
                    <div class="flex w-full">
                        <!-- Main Content Area -->
                        <div class="flex-1 min-w-0 flex justify-center" style="margin-right: 256px;">
                            <div class="p-10 max-w-7xl w-full">
                                <h2 class="text-2xl font-bold text-white mb-5">Component Management</h2>
                                
                                <!-- Component Table -->
                                <div class="bg-gray-800 rounded-lg overflow-hidden">
                                    <div class="px-6 py-4 border-b border-gray-700">
                                        <div class="flex items-center justify-between">
                                            <div class="flex items-center">
                                                <button id="create-component-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-md transition duration-200 text-sm flex items-center">
                                                    <span class="material-symbols-outlined mr-1" style="font-size: 20px;">add</span>
                                                    Create Component
                                                </button>
                                            </div>
                                            <div class="flex items-center">
                                                <div class="relative">
                                                    <input type="text" id="components-search-input" placeholder="Search components..." class="bg-gray-700 text-white rounded-md p-2 pl-3 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" style="width: 300px; padding-right: 3rem;" />
                                                    <button id="components-search-clear" type="button" class="absolute right-11 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-200 focus:outline-none" style="display: none;" data-tooltip="Clear Search">
                                                        <span class="material-symbols-outlined" style="font-size: 24px;">close</span>
                                                    </button>
                                                    <span class="material-symbols-outlined absolute right-3 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none">search</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Filters Row -->
                                    <div class="px-6 py-4 border-b border-gray-700">
                                        <div class="flex flex-wrap gap-4 justify-between">
                                            <div class="flex flex-wrap gap-4">
                                                <!-- Category Filter -->
                                                <div class="relative">
                                                    <button id="category-filter-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-md transition duration-200 text-sm flex items-center">
                                                        <span class="mr-1">Category</span>
                                                        <span class="material-symbols-outlined" style="font-size: 18px;">expand_more</span>
                                                        <span id="category-clear-btn" class="ml-2 text-red-400 hover:text-red-300 transition duration-200 hidden cursor-pointer flex items-center" title="Clear Category Filter">
                                                            <span class="material-symbols-outlined" style="font-size: 18px;">cancel</span>
                                                        </span>
                                                    </button>
                                                    <div id="category-filter-dropdown" class="options-dropdown-menu hidden w-34 left">
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="Sales" class="mr-2"> Sales
                                                        </label>
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="Marketing" class="mr-2"> Marketing
                                                        </label>
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="Finance" class="mr-2"> Finance
                                                        </label>
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="Operations" class="mr-2"> Operations
                                                        </label>
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="HR" class="mr-2"> HR
                                                        </label>
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="IT" class="mr-2"> IT
                                                        </label>
                                                    </div>
                                                </div>

                                                <!-- Type Filter -->
                                                <div class="relative">
                                                    <button id="type-filter-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-md transition duration-200 text-sm flex items-center">
                                                        <span class="mr-1">Type</span>
                                                        <span class="material-symbols-outlined" style="font-size: 18px;">expand_more</span>
                                                        <span id="type-clear-btn" class="ml-2 text-red-400 hover:text-red-300 transition duration-200 hidden cursor-pointer flex items-center" title="Clear Type Filter">
                                                            <span class="material-symbols-outlined" style="font-size: 18px;">cancel</span>
                                                        </span>
                                                    </button>
                                                    <div id="type-filter-dropdown" class="options-dropdown-menu hidden w-34 left">
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="Chart" class="mr-2"> Chart
                                                        </label>
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="KPI" class="mr-2"> KPI
                                                        </label>
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="Map" class="mr-2"> Map
                                                        </label>
                                                    </div>
                                                </div>

                                                <!-- Status Filter -->
                                                <div class="relative">
                                                    <button id="component-status-filter-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1.5 rounded-md transition duration-200 text-sm flex items-center">
                                                        <span class="mr-1">Status</span>
                                                        <span class="material-symbols-outlined" style="font-size: 18px;">expand_more</span>
                                                        <span id="component-status-clear-btn" class="ml-2 text-red-400 hover:text-red-300 transition duration-200 hidden cursor-pointer flex items-center" title="Clear Status Filter">
                                                            <span class="material-symbols-outlined" style="font-size: 18px;">cancel</span>
                                                        </span>
                                                    </button>
                                                    <div id="component-status-filter-dropdown" class="options-dropdown-menu hidden w-34 left">
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="Active" class="mr-2"> Active
                                                        </label>
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="Pending Review" class="mr-2"> Pending Review
                                                        </label>
                                                        <label class="flex items-center px-2 py-1 text-sm text-gray-300 hover:bg-gray-600 rounded cursor-pointer">
                                                            <input type="checkbox" value="Archived" class="mr-2"> Archived
                                                        </label>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Clear All Filters Button -->
                                            <button id="clear-all-component-filters-btn" class="text-red-400 hover:text-red-300 transition duration-200 text-sm flex items-center hidden">
                                                <span class="material-symbols-outlined mr-1 text-sm">clear_all</span>
                                                Clear All Filters
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="overflow-x-auto">
                                        <table id="components-table" class="w-full">
                                            <thead class="border-b border-gray-700">
                                                <tr>
                                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap w-full">Component</th>
                                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap">Category</th>
                                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap">Type</th>
                                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap">Status</th>
                                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap">Last Updated</th>
                                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap w-1"></th>
                                                </tr>
                                            </thead>
                                            <tbody class="bg-gray-800 divide-y divide-gray-700">
                                                <tr class="hover:bg-gray-700 transition duration-200 cursor-pointer">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div class="h-10 w-10 rounded-md bg-gray-600 flex items-center justify-center">
                                                                <span class="text-white font-semibold text-sm">SG</span>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-white">Sales Growth</div>
                                                                <div class="text-sm text-gray-400">sales-growth-v1</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Sales</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Chart</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-900 text-green-300">Active</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                        2 hours ago
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        <div class="relative">
                                                            <button class="options-dropdown-button" onclick="event.stopPropagation(); toggleDropdown('component-dropdown-1')">
                                                                <span class="material-symbols-outlined text-lg">more_vert</span>
                                                            </button>
                                                            <div id="component-dropdown-1" class="options-dropdown-menu hidden mt-0">
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Duplicate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Deactivate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-red-400 transition duration-150">Delete</a>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="hover:bg-gray-700 transition duration-200 cursor-pointer">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div class="h-10 w-10 rounded-md bg-gray-600 flex items-center justify-center">
                                                                <span class="text-white font-semibold text-sm">ST</span>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-white">Sales Team Performance</div>
                                                                <div class="text-sm text-gray-400">sales-team-perf-v2</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Sales</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Chart</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-900 text-green-300">Active</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                        1 day ago
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        <div class="relative">
                                                            <button class="options-dropdown-button" onclick="event.stopPropagation(); toggleDropdown('component-dropdown-2')">
                                                                <span class="material-symbols-outlined text-lg">more_vert</span>
                                                            </button>
                                                            <div id="component-dropdown-2" class="options-dropdown-menu hidden mt-0">
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Duplicate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Deactivate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-red-400 transition duration-150">Delete</a>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="hover:bg-gray-700 transition duration-200 cursor-pointer">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div class="h-10 w-10 rounded-md bg-gray-600 flex items-center justify-center">
                                                                <span class="text-white font-semibold text-sm">LQ</span>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-white">Lead Quality Metrics</div>
                                                                <div class="text-sm text-gray-400">lead-quality-v1</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Sales</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">KPI</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-900 text-yellow-300">Pending Review</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                        3 days ago
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        <div class="relative">
                                                            <button class="options-dropdown-button" onclick="event.stopPropagation(); toggleDropdown('component-dropdown-3')">
                                                                <span class="material-symbols-outlined text-lg">more_vert</span>
                                                            </button>
                                                            <div id="component-dropdown-3" class="options-dropdown-menu hidden mt-0">
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Duplicate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Deactivate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-red-400 transition duration-150">Delete</a>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="hover:bg-gray-700 transition duration-200 cursor-pointer">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div class="h-10 w-10 rounded-md bg-gray-600 flex items-center justify-center">
                                                                <span class="text-white font-semibold text-sm">CP</span>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-white">Campaign Performance</div>
                                                                <div class="text-sm text-gray-400">campaign-perf-v1</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Marketing</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">KPI</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-900 text-green-300">Active</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                        5 hours ago
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        <div class="relative">
                                                            <button class="options-dropdown-button" onclick="event.stopPropagation(); toggleDropdown('component-dropdown-4')">
                                                                <span class="material-symbols-outlined text-lg">more_vert</span>
                                                            </button>
                                                            <div id="component-dropdown-4" class="options-dropdown-menu hidden mt-0">
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Duplicate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Deactivate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-red-400 transition duration-150">Delete</a>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="hover:bg-gray-700 transition duration-200 cursor-pointer">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div class="h-10 w-10 rounded-md bg-gray-600 flex items-center justify-center">
                                                                <span class="text-white font-semibold text-sm">EM</span>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-white">Email Marketing Analytics</div>
                                                                <div class="text-sm text-gray-400">email-marketing-v2</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Marketing</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Chart</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-900 text-red-300">Inactive</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                        1 week ago
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        <div class="relative">
                                                            <button class="options-dropdown-button" onclick="event.stopPropagation(); toggleDropdown('component-dropdown-5')">
                                                                <span class="material-symbols-outlined text-lg">more_vert</span>
                                                            </button>
                                                            <div id="component-dropdown-5" class="options-dropdown-menu hidden mt-0">
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Duplicate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Activate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-red-400 transition duration-150">Delete</a>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                                <tr class="hover:bg-gray-700 transition duration-200 cursor-pointer">
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <div class="flex items-center">
                                                            <div class="h-10 w-10 rounded-md bg-gray-600 flex items-center justify-center">
                                                                <span class="text-white font-semibold text-sm">GM</span>
                                                            </div>
                                                            <div class="ml-4">
                                                                <div class="text-sm font-medium text-white">Geographic Market Analysis</div>
                                                                <div class="text-sm text-gray-400">geo-market-v1</div>
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Sales</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="text-sm text-gray-300">Map</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap">
                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-900 text-green-300">Active</span>
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">
                                                        1 day ago
                                                    </td>
                                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                        <div class="relative">
                                                            <button class="options-dropdown-button" onclick="event.stopPropagation(); toggleDropdown('component-dropdown-6')">
                                                                <span class="material-symbols-outlined text-lg">more_vert</span>
                                                            </button>
                                                            <div id="component-dropdown-6" class="options-dropdown-menu hidden mt-0">
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Duplicate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Deactivate</a>
                                                                <a href="#" class="block px-4 py-2 text-sm text-red-400 transition duration-150">Delete</a>
                                                            </div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                    
                                    <!-- No matches found message -->
                                    <div id="no-component-matches-message" class="hidden px-6 py-8 text-center">
                                        <div class="flex flex-col items-center">
                                            <span class="material-symbols-outlined text-gray-400 text-4xl mb-3">grid_view</span>
                                            <h3 class="text-lg font-medium text-gray-300 mb-2">No components found</h3>
                                            <p class="text-gray-400 text-sm">Try adjusting your search terms or filters</p>
                                        </div>
                                    </div>
                                </div>



    <!-- Component Details Modal -->
                                <div id="component-modal" class="fixed inset-0 p-10 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
                                    <div class="bg-gray-900 rounded-lg shadow-xl w-11/12 h-full max-w-[1520px] flex flex-col">
                                        <!-- Modal Header -->
                                        <div class="py-4 px-6 border-b border-gray-700">
                                            <div class="flex items-center justify-between">
                                                <div class="flex items-center">
                                                    <h2 class="text-xl font-semibold text-white mr-4">Sales Growth</h2>
                                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-900 text-green-300">Active</span>
                                                </div>
                                                <div class="flex items-center space-x-4">
                                                    <button onclick="openEditComponentModal()" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200 text-sm flex items-center">
                                                        <span class="material-symbols-outlined mr-2" style="font-size: 18px;">edit</span>
                                                        Edit Component
                                                    </button>
                                                    <!-- Component Dropdown -->
                                                    <div class="relative">
                                                        <button id="component-actions-dropdown-btn" class="options-dropdown-button">
                                                            <span class="material-symbols-outlined text-lg">more_vert</span>
                                                        </button>
                                                        <div id="component-actions-dropdown" class="options-dropdown-menu hidden">
                                                            <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Duplicate</a>
                                                            <a href="#" class="block px-4 py-2 text-sm text-gray-200 transition duration-150">Deactivate</a>
                                                            <a href="#" class="block px-4 py-2 text-sm text-red-400 transition duration-150">Delete</a>
                                                        </div>
                                                    </div>
                                                    <!-- Close Button -->
                                                    <button id="close-component-modal" class="text-gray-400 hover:text-white transition duration-200 flex items-center">
                                                        <span class="material-symbols-outlined text-xl">close</span>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Modal Content -->
                                        <div class="flex flex-1 overflow-hidden">
                                            <!-- Left Column - Component Data -->
                                            <div class="w-7/12 flex flex-col border-r border-gray-700">
                                                <!-- Fixed Content (Description, Metadata, Tabs) -->
                                                <div class="flex-shrink-0">
                                                    <!-- Description -->
                                                    <div class="py-4 px-6">
                                                        <div class="text-sm">
                                                            <div class="text-gray-500 mb-1">Description</div>
                                                            <div class="text-gray-300">Visualizes Year-Over-Year growth in sales since 2012.</div>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Metadata -->
                                                    <div class="pb-4 px-6">
                                                        <div class="flex items-start justify-between">
                                                            <div class="grid grid-cols-3 gap-4 text-sm flex-1">
                                                            <div>
                                                                <div class="text-gray-500 mb-1">Category</div>
                                                                <div class="text-gray-300">Sales</div>
                                                            </div>
                                                            <div>
                                                                <div class="text-gray-500 mb-1">Type</div>
                                                                    <div class="text-gray-300">Chart <span class="text-gray-500">(Line)</span></div>
                                                            </div>
                                                            <div>
                                                                <div class="text-gray-500 mb-1">Update Frequency</div>
                                                                <div class="text-gray-300">Every Year</div>
                                                            </div>
                                                                <div class="metadata-extra hidden">
                                                                <div class="text-gray-500 mb-1">Created</div>
                                                                <div class="text-gray-300">May 15, 2024 <span class="text-gray-500">(John Doe)</span></div>
                                                            </div>
                                                                <div class="metadata-extra hidden">
                                                                <div class="text-gray-500 mb-1">Last Updated</div>
                                                                <div class="text-gray-300">Aug 23, 2024 <span class="text-gray-500">(John Doe)</span></div>
                                                            </div>
                                                            </div>
                                                            <button id="expand-metadata-btn" class="flex items-center h-11 ml-4 p-2 text-gray-400 hover:text-white transition duration-200">
                                                                <span class="material-symbols-outlined text-[24px]">expand_more</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Navigation Tabs -->
                                                    <div class="border-b border-gray-700 px-6 mt-2">
                                                        <nav class="flex space-x-6">
                                                            <button class="internal-tab-item pb-2 px-1 border-b-2 border-red-500 text-white font-medium text-sm" data-tab="data-source">Data Source</button>
                                                            <button class="internal-tab-item pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-tab="mapping-customization">Mapping & Customization</button>
                                                            <button class="internal-tab-item pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-tab="filters">Filters</button>
                                                            <button class="internal-tab-item pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-tab="usage-analytics">Usage Analytics</button>
                                                            <button class="internal-tab-item pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-tab="permissions">Access</button>
                                                        </nav>
                                                    </div>
                                                </div>
                                                
                                                <!-- Scrollable Tab Content Container -->
                                                <div class="flex-1 overflow-y-auto">
                                                    <!-- Data Source Tab -->
                                                    <div id="data-source-tab" class="component-tab-content">
                                                        <div class="px-6 pt-4">

                                                            <h4 class="text-sm font-medium text-white mb-4">API Request</h4>

                                                            <div class="flex items-center justify-between bg-gray-800 border border-gray-600 rounded-md px-3 py-2">
                                                                <div class="flex items-center">
                                                                    <div class="h-10 w-10 rounded-md bg-gray-600 flex items-center justify-center mr-4">
                                                                        <span class="material-symbols-outlined" style="font-size: 20px;">api</span>
                                                                </div>
                                                                        <div>
                                                                        <div class="flex items-center space-x-2">
                                                                            <div class="text-sm font-medium text-white">Get Current Weather</div>
                                                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-900 text-green-300">GET</span>
                                                            </div>
                                                                        <div class="text-xs text-gray-400 mt-1">Retrieve current weather conditions</div>
                                                                        <div class="flex items-center space-x-2 text-gray-400">
                                                                            <div class="flex items-center">
                                                                                <span class="material-symbols-outlined text-[16px] mr-1">folder</span>
                                                                                <span class="text-xs">Weather Services</span>
                                                            </div>
                                                                            <div>  </div>
                                                            <div class="flex items-center">
                                                                                <span class="material-symbols-outlined text-[16px] mr-1">link</span>
                                                                                <span class="text-xs">https://weather.secureclient.com/api/v1/current</span>
                                                            </div>
                                                        </div>
                                                            </div>
                                                        </div>
                                                            <div>
                                                                    <button class="see-details-btn w-7 h-7 flex items-center justify-center text-gray-400 hover:text-white p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-red-400" data-collection-id="weather-services">
                                                                        <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
                                                                    </button>
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                        <div class="mt-6">

                                                            <div class="border-b border-gray-700 mb-4"></div>
                                                            
                                                            <!-- Request and Response Section -->

                                                            <!-- Request Section -->
                                                            
                                                            <!-- Request Tabs Navigation -->
                                                            <div class="px-6">
                                                                <div class="mb-4">
                                                                    <h3 class="font-medium text-gray-300">Request</h3>
                                                                            </div>
                                                                <nav class="flex space-x-6 border-b border-gray-700">
                                                                    <button class="test-request-tab pb-2 px-1 border-b-2 font-medium text-sm border-red-500 text-white" data-test-request-tab="params">
                                                                        Parameters
                                                                    </button>
                                                                    <button class="test-request-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-test-request-tab="auth">
                                                                        Authentication
                                                                    </button>
                                                                    <button class="test-request-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-test-request-tab="headers">
                                                                        Headers
                                                                    </button>
                                                                    <button class="test-request-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-test-request-tab="body">
                                                                        Body
                                                                    </button>
                                                                    <button class="test-request-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-test-request-tab="script">
                                                                        Scripts
                                                                    </button>
                                                                </nav>
                                                                            </div>
                                                        
                                                            <!-- Request Configuration Tabs -->
                                                            <div class="flex-1 overflow-y-auto p-6">
                                                                
                                                                <!-- Parameters Tab Content -->
                                                                <div class="test-request-tab-content" data-test-request-tab="params">
                                                                    <div class="space-y-4">
                                                                        <!-- Query Params -->
                                                            <div>
                                                                            <div class="flex items-center justify-between mb-2">
                                                                                <h3 class="text-sm text-gray-500">Query Params</h3>
                                                                            </div>
                                                                            <div class="space-y-2 border border-gray-700 p-3 rounded-md">
                                                                                <div class="flex items-center space-x-2" data-index="0">
                                                                                    <div class="flex-1 text-sm text-gray-500">Key</div>
                                                                                    <div class="flex-1 text-sm text-gray-500">Value</div>
                                                                        </div>
                                                                                <div class="flex items-center space-x-2 key-value-row readonly" data-index="0">
                                                                                    <input type="text" placeholder="Key" value="location" class="flex-1 bg-gray-800 text-gray-400 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" disabled="">
                                                                                    <input type="text" placeholder="Value" value="New York" class="flex-1 bg-gray-800 text-gray-400 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" disabled="">
                                                                    </div>
                                                                                <div class="flex items-center space-x-2 key-value-row readonly" data-index="1">
                                                                                    <input type="text" placeholder="Key" value="units" class="flex-1 bg-gray-800 text-gray-400 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" disabled="">
                                                                                    <input type="text" placeholder="Value" value="metric" class="flex-1 bg-gray-800 text-gray-400 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" disabled="">
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                    
                                                                        <!-- Path Variables -->
                                                                        <div class="hidden">
                                                                            <div class="flex items-center justify-between mb-2">
                                                                                <h3 class="text-sm text-gray-500">Path Variables</h3>
                                                                            </div>
                                                                            <div class="space-y-2 border border-gray-700 p-3 rounded-md">
                                                                                <div class="text-sm text-gray-600">None added</div>
                                                                            </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                <!-- Authentication Tab Content -->
                                                                <div class="test-request-tab-content hidden" data-test-request-tab="auth">
                                                                    <div class="space-y-4">
                                                                        <div>
                                                                            <label class="block text-sm text-gray-500 mb-2">Type</label>
                                                                            <div class="relative">
                                                                                <select class="w-full bg-gray-800 text-gray-400 rounded-md px-3 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none opacity-100" disabled="">
                                                                                    <option value="inherit" selected="">Inherit from Collection</option>
                                                                                    <option value="none">No Authentication</option>
                                                                                    <option value="basic">Basic Authentication</option>
                                                                                    <option value="apikey">API Key</option>
                                                                                    <option value="bearer">Bearer Token</option>
                                                                                    <option value="oauth2">OAuth 2.0</option>
                                                                                </select>
                                                                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none hidden">
                                                                                    <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                        <div class="text-sm text-gray-400">
                                                                            Currently inheriting API Key authentication from Weather Services collection.
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                
                                                                <!-- Headers Tab Content -->
                                                                <div class="test-request-tab-content hidden" data-test-request-tab="headers">
                                                                    <div class="space-y-2 border border-gray-700 p-3 rounded-md">
                                                                        <div class="space-y-2">
                                                                            <div class="flex items-center space-x-2" data-index="0">
                                                                                <div class="flex-1 text-sm text-gray-500">Key</div>
                                                                                <div class="flex-1 text-sm text-gray-500">Value</div>
                                                                        </div>
                                                                            <div class="flex items-center space-x-2 key-value-row readonly" data-index="0">
                                                                                <input type="text" placeholder="Key" value="User-Agent" class="flex-1 bg-gray-800 text-gray-400 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" disabled="">
                                                                                <input type="text" placeholder="Value" value="Llumen-API-Client/1.0" class="flex-1 bg-gray-800 text-gray-400 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" disabled="">
                                                                    </div>
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                    
                                                                <!-- Body Tab Content -->
                                                                <div class="test-request-tab-content hidden" data-test-request-tab="body">
                                                                    <div class="space-y-4">
                                                                        <div>
                                                                            <div class="relative inline-flex">
                                                                                <select class="w-full bg-gray-800 text-gray-400 rounded-md px-3 py-2 pr-8 text-sm focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none opacity-100" disabled="">
                                                                                    <option value="none">None</option>
                                                                                    <option value="form-data" selected="">Form Data</option>
                                                                                    <option value="x-www-form-urlencoded">x-www-form-urlencoded</option>
                                                                                    <option value="raw">Raw</option>
                                                                                    <option value="binary">Binary</option>
                                                                                </select>
                                                                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none hidden">
                                                                                    <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                        <div class="space-y-2 border border-gray-700 p-3 rounded-md">
                                                                            <div class="space-y-2">
                                                                                <div class="flex items-center space-x-2" data-index="0">
                                                                                    <div class="flex-1 text-sm text-gray-500">Key</div>
                                                                                    <div class="flex-1 text-sm text-gray-500">Value</div>
                                                                        </div>
                                                                                <div class="flex items-center space-x-2 key-value-row readonly" data-index="0">
                                                                                    <div class="flex-1 flex items-center space-x-2">
                                                                                        <input type="text" placeholder="Key" value="location" class="flex-1 bg-gray-800 text-gray-400 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" disabled="">
                                                                                        <div class="relative">
                                                                                            <select class="w-full bg-gray-800 text-gray-400 rounded-md px-3 py-2 pr-12 text-sm focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none opacity-100" disabled="">
                                                                                                <option value="text" selected="">Text</option>
                                                                                                <option value="file">File</option>
                                                                                            </select>
                                                                                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none hidden">
                                                                                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                                    </div>
                                                                            </div>
                                                                            </div>
                                                                                    <div class="flex-1 flex items-center space-x-2">
                                                                                        <input type="text" placeholder="Value" value="New York" class="flex-1 bg-gray-800 text-gray-400 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm" disabled="">
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                <!-- Pre-Request Script Tab Content -->
                                                                <div class="test-request-tab-content hidden" data-test-request-tab="script">
                                                                    <div class="flex border border-gray-700 rounded-lg h-full overflow-hidden" style="min-height: 240px;">
                                                                        <!-- Script Property Tabs -->
                                                                        <div class="flex flex-col w-52 p-3 bg-gray-800 border-r border-gray-700">
                                                                            <div class="flex-1 space-y-2">
                                                                                <div class="request-script-inner-tab flex items-center py-2 px-3 rounded-lg transition duration-200 cursor-pointer bg-blue-600 text-white" data-request-script-inner-tab="pre-request">
                                                                                    <span class="text-sm font-medium">Pre-Request</span>
                                                                            </div>
                                                                                <div class="request-script-inner-tab flex items-center py-2 px-3 rounded-lg cursor-pointer transition duration-200 bg-gray-700 text-gray-300 hover:bg-gray-600" data-request-script-inner-tab="post-request">
                                                                                    <span class="text-sm font-medium">Post-Request</span>
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                
                                                                        <!-- Script Tab Content -->
                                                                        <div class="flex-1 p-4 overflow-auto">
                                                                            <!-- Pre-Request Script Content -->
                                                                            <div class="request-script-inner-tab-content" data-request-script-inner-tab="pre-request">
                                                                                <div class="flex">
                                                                                    <textarea class="w-full h-64 bg-gray-800 text-gray-400 rounded-md p-4 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm font-mono resize-none" placeholder="// Access to 'llumen' object available in Llumen sandbox environment
                                    // Example:
                                    // llumen.setVariable('timestamp', Date.now());
                                    // llumen.log('Pre-request script executed');" disabled="">// Set dynamic location based on user input
                                    llumen.setVariable('location', 'New York');
                                     
                                    // Log request details
                                    llumen.log('Making weather request for: ' + llumen.getVariable('location'));</textarea>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                            <!-- Post-Request Script Content -->
                                                                            <div class="request-script-inner-tab-content hidden" data-request-script-inner-tab="post-request">
                                                                                <div class="flex">
                                                                                    <textarea class="w-full h-64 bg-gray-800 text-gray-400 rounded-md p-4 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm font-mono resize-none" placeholder="// Access to 'llumen' object available in Llumen sandbox environment
                                    // Example:
                                    // llumen.setVariable('responseTime', Date.now() - requestStartTime);
                                    // llumen.log('Post-request script executed');" disabled="">// Process response data
                                    const responseTime = Date.now() - llumen.getVariable('requestStartTime');
                                    llumen.setVariable('responseTime', responseTime);
                                    
                                    // Log response details
                                    llumen.log('Post-request script executed. Response time: ' + responseTime + 'ms');</textarea>
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                            <!-- Response Section -->
                                                            <div class="border-t border-gray-700 h-[40%] flex flex-col overflow-hidden">
                                                                <div class="flex items-center justify-between px-6 py-4">
                                                                    <h3 class="font-medium text-gray-300">Response</h3>
                                                                    
                                                                    <!-- Response Metadata -->
                                                                    <div class="flex items-center space-x-6 text-xs">
                                                                        <div class="flex items-center space-x-1">
                                                                            <span class="text-gray-500">Status:</span>
                                                                            <span class="text-green-400 font-medium">200 OK</span>
                                                                            </div>
                                                                        <div class="flex items-center space-x-1">
                                                                            <span class="text-gray-500">Time:</span>
                                                                            <span class="text-gray-300">245ms</span>
                                                                            </div>
                                                                        <div class="flex items-center space-x-1">
                                                                            <span class="text-gray-500">Size:</span>
                                                                            <span class="text-gray-300">1.2 KB</span>
                                                                            </div>
                                                                            </div>
                                                                            </div>
                                                                
                                                                <!-- Response Body -->
                                                                <div class="px-6 pb-4 flex-1 flex flex-col overflow-hidden">
                                                                    <div class="bg-gray-800 border border-gray-600 rounded-md p-4 flex-1  overflow-y-auto">
<pre class="text-sm text-gray-300 overflow-x-auto"><code>{
    "location": "New York",
    "temperature": 22.5,
    "humidity": 65,
    "description": "Partly cloudy",
    "wind_speed": 12.3,
    "timestamp": "2024-01-15T14:30:00Z"
}</code></pre>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                        
                                                    <!-- Mapping & Customization Tab -->
                                                    <div id="mapping-customization-tab" class="component-tab-content h-full hidden">

                                                        <div class="visualization-config p-6 pt-4">

                                                            <div>

                                                                <h4 class="text-sm font-medium text-white mb-4">Mapping &amp; Customization</h4>

                                                                <div class="space-y-4">
                                                                    <div class="flex border border-gray-700 rounded-lg h-full overflow-hidden" style="min-height: 400px;">
                                                                <div class="flex flex-col w-52 p-3 bg-gray-800 border-r border-gray-700">
                                                                    <div class="flex-1 space-y-2">
                                                                        <div class="component-visual-property-tab flex items-center py-2 px-3 bg-blue-600 text-white rounded-lg transition duration-200 cursor-pointer" data-visual-tab="y-axis">
                                                                            <span class="text-sm font-medium">Y-Axis</span>
                                                                        </div>
                                                                        <div class="component-visual-property-tab flex items-center py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg cursor-pointer transition duration-200" data-visual-tab="series">
                                                                            <span class="text-sm font-medium">Series</span>
                                                                        </div>
                                                                        <div class="component-visual-property-tab flex items-center py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg cursor-pointer transition duration-200" data-visual-tab="legend">
                                                                            <span class="text-sm font-medium">Legend</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                <div class="flex-1 p-4 overflow-auto">
                                                                    <div id="y-axis-tab-content" class="component-visual-tab-content space-y-6">

                                                                        <div>
                                                                            <div class="text-sm text-gray-500 mb-2">Data Field</div>
                                                                            <div>
                                                                                <div class="relative">
                                                                                    <select class="w-full bg-gray-800 text-gray-400 opacity-100 transition duration-200 rounded-md px-3 py-2 text-sm text-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none" disabled>
                                                                                        <option value="">Select data field</option>
                                                                                        <option value="category">category</option>
                                                                                        <option value="region">region</option>
                                                                                        <option value="date">date</option>
                                                                                        <option value="grid_id">grid_id</option>
                                                                                    </select>
                                                                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none hidden">
                                                                                        <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                                                        </div>
                                                                                    </div>
                                                                            </div>
                                                                        </div>

                                                                        <div class="border-t border-gray-700"></div>

                                                                        <div class="space-y-4">
                                                                            <div>
                                                                                <div class="text-sm text-gray-500 mb-2">Axis Order</div>
                                                                                <div class="space-y-3">
                                                                                    <div class="flex items-center space-x-3">
                                                                                        <label class="toggle-switch opacity-30">
                                                                                            <input type="checkbox" disabled="">
                                                                                            <span class="toggle-slider cursor-default"></span>
                                                                                        </label>
                                                                                        <span class="text-sm text-gray-300">Reverse Order</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>

                                                                        <div>
                                                                                <div class="text-sm text-gray-500 mb-2">Gridlines</div>
                                                                                <div class="space-y-3">
                                                                                    <div class="flex items-center space-x-3">
                                                                                        <label class="toggle-switch opacity-30">
                                                                                            <input type="checkbox" disabled="">
                                                                                            <span class="toggle-slider cursor-default"></span>
                                                                                        </label>
                                                                                        <span class="text-sm text-gray-300">Major Gridlines</span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>
                                                                            </div>

                                                                        </div>
                                                                        
                                                                    <div id="series-tab-content" class="component-visual-tab-content space-y-6 hidden">
                                                                
                                                                                <div class="relative">
                                                                            <div class="flex items-center justify-between">
                                                                                <div class="text-sm text-gray-500 mb-2">Series Fields</div>
                                                                                        </div>
                                                                            <div class="space-y-2 mb-3">
                                                                                <div class="series-item flex items-center justify-between bg-gray-800 rounded-md px-3 py-2">
                                                                                    <span class="text-sm text-gray-400 flex-1">Area Size (km)</span>
                                                                                    </div>
                                                                                <div class="series-item flex items-center justify-between bg-gray-800 rounded-md px-3 py-2">
                                                                                    <span class="text-sm text-gray-400 flex-1">Population Density</span>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <div class="border-t border-gray-700"></div>

                                                                        <div class="space-y-4">

                                                                                    <div>
                                                                                <div class="text-sm text-gray-500 mb-2">Color Palette</div>
                                                                                <div class="relative">
                                                                                    <div class="w-full bg-gray-800 text-gray-400 rounded-md px-3 py-2 text-sm text-gray-400 flex items-center justify-between">
                                                                                        <div class="flex items-center space-x-3">
                                                                                            <div class="w-8 h-4 rounded bg-gradient-to-r from-teal-400 via-orange-400 to-pink-400"></div>
                                                                                            <span>Default</span>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                            </div>

                                                                                                <div>
                                                                                <div class="grid grid-cols-2 gap-4">
                                                                                    <div>
                                                                                        <div class="text-sm text-gray-500 mb-2">
                                                                                            Minimum Value
                                                                                                </div>
                                                                                        <input type="number" class="w-full bg-gray-800 rounded-md px-3 py-2 text-sm text-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="0" disabled>
                                                                                            </div>
                                                                                    <div>
                                                                                        <div class="text-sm text-gray-500 mb-2">
                                                                                            Maximum Value
                                                                                        </div>
                                                                                        <input type="number" class="w-full bg-gray-800 rounded-md px-3 py-2 text-sm text-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="100" disabled>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            
                                                                            <div>
                                                                                <div class="text-sm text-gray-500 mb-2">Scale Factor</div>
                                                                                <div class="relative">
                                                                                    <select class="w-full bg-gray-800 text-gray-400 rounded-md px-3 py-2 pr-8 text-sm text-gray-400 opacity-100 focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none" disabled>
                                                                                        <option value="1">1x (No scaling)</option>
                                                                                        <option value="0.001">0.001x (Thousands)</option>
                                                                                        <option value="0.01">0.01x (Hundreds)</option>
                                                                                        <option value="0.1">0.1x (Tens)</option>
                                                                                        <option value="10">10x</option>
                                                                                        <option value="100">100x</option>
                                                                                        <option value="1000">1000x</option>
                                                                                    </select>
                                                                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none hidden">
                                                                                        <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                                        </div>
                                                                                </div>
                                                                    </div>

                                                                        <div>
                                                                                <div class="text-sm text-gray-500 mb-2">Number Format</div>
                                                                                <div class="relative">
                                                                                    <select class="w-full bg-gray-800 text-gray-400 rounded-md px-3 py-2 pr-8 text-sm text-gray-400 opacity-100 focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none" disabled>
                                                                                        <option value="number">Number (1,234.56)</option>
                                                                                        <option value="currency">Currency ($1,234.56)</option>
                                                                                        <option value="percentage">Percentage (123.46%)</option>
                                                                                        <option value="decimal">Decimal (1234.56)</option>
                                                                                        <option value="integer">Integer (1235)</option>
                                                                                        <option value="scientific">Scientific (1.23e+3)</option>
                                                                                    </select>
                                                                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none hidden">
                                                                                        <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                                                        </div>
                                                                                    </div>
                                                                                </div>

                                                                        </div>

                                                                        <div class="border-t border-gray-700"></div>

                                                                        <div class="space-y-4">

                                                                            <div>
                                                                                <div class="text-sm text-gray-500 mb-2">Gridlines &amp; Ticks</div>
                                                                                <div class="space-y-3">
                                                                                    <div class="flex items-center space-x-3">
                                                                                        <label class="toggle-switch opacity-30">
                                                                                            <input type="checkbox" disabled>
                                                                                            <span class="toggle-slider cursor-default"></span>
                                                                                        </label>
                                                                                        <span class="text-sm text-gray-300">Major Gridlines</span>
                                                                                        </div>
                                                                                    <div class="flex items-center space-x-3">
                                                                                        <label class="toggle-switch opacity-30">
                                                                                            <input type="checkbox" disabled="">
                                                                                            <span class="toggle-slider cursor-default"></span>
                                                                                        </label>
                                                                                        <span class="text-sm text-gray-300">Minor Gridlines</span>
                                                                                    </div>
                                                                                    <div class="flex items-center space-x-3">
                                                                                        <label class="toggle-switch opacity-30">
                                                                                            <input type="checkbox" disabled="">
                                                                                            <span class="toggle-slider cursor-default"></span>
                                                                                        </label>
                                                                                        <span class="text-sm text-gray-300">Major Ticks</span>
                                                                                    </div>
                                                                                    <div class="flex items-center space-x-3">
                                                                                        <label class="toggle-switch opacity-30">
                                                                                            <input type="checkbox" disabled="">
                                                                                            <span class="toggle-slider cursor-default"></span>
                                                                                        </label>
                                                                                        <span class="text-sm text-gray-300">Minor Ticks</span>
                                                                                    </div>
                                                                                </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                            <div id="legend-tab-content" class="component-visual-tab-content space-y-6 hidden">
                                                                            <div class="max-w-md">
                                                                                    <div class="flex items-center space-x-3">
                                                                                        <label class="toggle-switch opacity-30">
                                                                                            <input type="checkbox" checked="" disabled>
                                                                                            <span class="toggle-slider"></span>
                                                                                        </label>
                                                                                        <span class="legend-label-text text-sm text-gray-300 hover:text-gray-200">
                                                                                            Show Legend
                                                                                        </span>
                                                                                        </div>
                                                                                </div>
                                                                            
                                                                                <div style="display: block;">
                                                                                    <div class="text-sm text-gray-500 mb-2">Legend Position</div>
                                                                                    <div class="relative">
                                                                                        <select class="w-full bg-gray-800 text-gray-400 rounded-md px-3 py-2 pr-8 text-sm text-gray-400 opacity-100 focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none" disabled>
                                                                                            <option value="auto">Auto</option>
                                                                                            <option value="top">Top</option>
                                                                                            <option value="bottom">Bottom</option>
                                                                                            <option value="left">Left</option>
                                                                                            <option value="right">Right</option>
                                                                                        </select>
                                                                                        <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none hidden">
                                                                                            <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                                                                </div>
                                                                                            </div>
                                                                                        </div>
                                                        
                                                    <!-- Filters Tab -->
                                                    <div id="filters-tab" class="component-tab-content h-full hidden">
                                                        <div class="p-6 pt-4">
                                                            <div class="space-y-6">
                                                                <!-- Create the Add Filter field structure -->
                                                                <div class="relative">

                                                                    <h4 class="text-sm font-semibold text-white mb-4">Filters</h4>
                                                        
                                                                    <!-- Filter list container -->
                                                                    <div class="space-y-2 mb-3">
                                                                        <div class="filter-item flex items-center justify-between bg-gray-800 border border-gray-600 rounded-md px-3 py-2">
                                                                            <div class="flex items-center space-x-3 flex-1">
                                                                                <div class="h-8 w-8 rounded-md bg-gray-600 flex items-center justify-center">
                                                                                    <span class="material-symbols-outlined text-white text-lg">date_range</span>
                                                                                        </div>
                                                                                <div class="flex-1">
                                                                                        <div class="flex items-center">
                                                                                        <div class="mr-3">
                                                                                            <div class="text-sm font-medium text-white">Date Range Filter</div>
                                                                                            <div class="text-xs text-gray-400">date_range_filter</div>
                                                                                        </div>
                                                                                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-600 text-gray-300">DateRange</span>
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="flex items-center space-x-2 ml-4 relative">
                                                                                <label class="text-xs text-gray-400 whitespace-nowrap">Map to:</label>
                                                                                <select class="bg-gray-700 text-gray-400 opacity-100 rounded-md px-2 py-1 pr-8 text-xs focus:outline-none focus:ring-1 focus:ring-red-500 appearance-none" style="min-width: 120px;" disabled>
                                                                                    <option value="">Select field</option>
                                                                                    <option value="date" selected>Date</option>
                                                                                    <option value="time">Time</option>
                                                                                    <option value="timestamp">Timestamp</option>
                                                                                    <option value="category">Category</option>
                                                                                    <option value="region">Region</option>
                                                                                    <option value="grid_id">Grid ID</option>
                                                                                    <option value="longitude">Longitude</option>
                                                                                    <option value="latitude">Latitude</option>
                                                                                    <option value="population_count">Population Count</option>
                                                                                    <option value="area_size_km2">Area Size (km)</option>
                                                                                    <option value="population_density">Population Density</option>
                                                                                    <option value="sales">Sales</option>
                                                                                    <option value="revenue">Revenue</option>
                                                                                    <option value="quantity">Quantity</option>
                                                                                    <option value="end_longitude">End Longitude</option>
                                                                                    <option value="end_latitude">End Latitude</option>
                                                                                    <option value="distance">Distance</option>
                                                                                </select>
                                                                                <div class="absolute inset-y-0 right-0 flex items-center pr-1 pointer-events-none hidden">
                                                                                    <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                                        </div>
                                                                    </div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                    </div>
                                                    
                                                    <!-- Usage Analytics Tab -->
                                                    <div id="usage-analytics-tab" class="component-tab-content hidden">

                                                        <div class="p-6 pt-4">

                                                            <h4 class="text-sm font-semibold text-white mb-4">Usage Analytics</h4>

                                                        <div class="space-y-4">
                                                            <!-- Key Metrics -->
                                                            <div class="grid grid-cols-2 gap-4">
                                                                <div class="bg-gray-800 border border-gray-600 rounded-md p-4">
                                                                    <div class="text-sm text-gray-400">Usage Over Time</div>
                                                                        <div class="text-lg font-medium text-white">3.4K</div>
                                                                </div>
                                                                <div class="bg-gray-800 border border-gray-600 rounded-md p-4">
                                                                    <div class="text-sm text-gray-400">No. of Users</div>
                                                                        <div class="text-lg font-medium text-white">244</div>
                                                                </div>
                                                                <div class="bg-gray-800 border border-gray-600 rounded-md p-4">
                                                                    <div class="text-sm text-gray-400">No. of Edits</div>
                                                                        <div class="text-lg font-medium text-white">12</div>
                                                                </div>
                                                                <div class="bg-gray-800 border border-gray-600 rounded-md p-4">
                                                                    <div class="text-sm text-gray-400">Run Time</div>
                                                                        <div class="text-lg font-medium text-white">120 Days</div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Charts -->
                                                                <div class="grid grid-cols-2 gap-4">
                                                                <!-- Usage Breakdown Chart -->
                                                                <div class="bg-gray-800 border border-gray-600 rounded-md p-4">
                                                                        <h3 class="text-sm font-medium text-gray-400 mb-4">Usage Breakdown</h3>
                                                                    <div class="h-28 flex items-end justify-between">
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 30%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 45%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 60%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 80%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 50%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 70%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 90%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 40%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 65%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 35%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 55%"></div>
                                                                        <div class="w-4 bg-teal-400 rounded-t" style="height: 75%"></div>
                                                                    </div>
                                                                    <div class="flex justify-between text-xs text-gray-400 mt-2">
                                                                        <span>Jan</span>
                                                                        <span>Feb</span>
                                                                        <span>Mar</span>
                                                                        <span>Apr</span>
                                                                        <span>May</span>
                                                                        <span>Jun</span>
                                                                        <span>Jul</span>
                                                                        <span>Aug</span>
                                                                        <span>Sep</span>
                                                                        <span>Oct</span>
                                                                        <span>Nov</span>
                                                                        <span>Dec</span>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- Volume Profile Chart -->
                                                                <div class="bg-gray-800 border border-gray-600 rounded-md p-4">
                                                                        <h3 class="text-sm font-medium text-gray-400 mb-4">Volume Profile</h3>
                                                                    <div class="h-[136px] relative">
                                                                        <svg class="w-full h-full" viewBox="0 0 200 100">
                                                                            <path d="M0,80 L50,20 L100,70 L150,30 L200,60" stroke="#14b8a6" stroke-width="2" fill="none"/>
                                                                            <circle cx="50" cy="20" r="2" fill="#14b8a6"/>
                                                                            <circle cx="100" cy="70" r="2" fill="#14b8a6"/>
                                                                            <circle cx="150" cy="30" r="2" fill="#14b8a6"/>
                                                                            <circle cx="200" cy="60" r="2" fill="#14b8a6"/>
                                                                        </svg>
                                                                        <div class="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-gray-400">
                                                                            <span>12:00 am</span>
                                                                            <span>6:00 am</span>
                                                                            <span>12:00 pm</span>
                                                                            <span>6:00 pm</span>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            </div>

                                                        </div>
                                                    </div>
                                                    
                                                    <!-- Permissions Tab -->
                                                    <div id="permissions-tab" class="component-tab-content hidden">

                                                        <div class="p-6 pt-4">

                                                            <h4 class="text-sm font-semibold text-white mb-4">Access</h4>

                                                            <!-- Add People/Workspaces Input and Invite Button -->
                                                            <div class="flex items-center space-x-3 mb-6">
                                                                <div class="flex-1">
                                                                    <input type="text" placeholder="Add workspaces or people" class="w-full px-3 py-1.5 h-9 bg-gray-800 border border-gray-600 rounded-md text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
                                                                </div>
                                                                <button class="flex items-center space-x-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded-md transition-colors duration-200">
                                                                    <span class="material-symbols-outlined text-[20px]">add</span>
                                                                    <span>Invite</span>
                                                                </button>
                                                            </div>

                                                            <div class="space-y-4">
                                                                <!-- Planning Section -->
                                                                <div>
                                                                    <h3 class="text-sm font-medium text-gray-300 mb-3">Planning</h3>
                                                                    <div class="space-y-3">
                                                                        <div class="flex items-center justify-between p-3 bg-gray-800 border border-gray-600 rounded-md">
                                                                            <div class="flex items-center space-x-3">
                                                                                <img class="h-8 w-8 rounded-full" src="https://placehold.co/32x32/555/fff?text=JD" alt="">
                                                                                <div>
                                                                                    <div class="text-sm font-medium text-white flex items-center space-x-2">
                                                                                        <span>John Doe</span>
                                                                                            <span class="text-xs bg-gray-900 text-gray-300 px-2 py-1 rounded-full">Admin</span>
                                                                                    </div>
                                                                                    <div class="text-xs text-gray-400">john.doe@company.com</div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="flex items-center space-x-2">
                                                                                <span class="text-sm text-gray-400">Full access</span>
                                                                                <span class="material-symbols-outlined text-gray-400 text-[20px]">expand_more</span>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <div class="flex items-center justify-between p-3 bg-gray-800 border border-gray-600 rounded-md">
                                                                            <div class="flex items-center space-x-3">
                                                                                <img class="h-8 w-8 rounded-full" src="https://placehold.co/32x32/555/fff?text=JS" alt="">
                                                                                <div>
                                                                                    <div class="text-sm font-medium text-white">Jane Smith</div>
                                                                                    <div class="text-xs text-gray-400">jane.smith@company.com</div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="flex items-center space-x-2">
                                                                                <span class="text-sm text-gray-400">Limited access</span>
                                                                                <span class="material-symbols-outlined text-gray-400 text-[20px]">expand_more</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- Chairman Office Section -->
                                                                <div>
                                                                    <h3 class="text-sm font-medium text-gray-300 mb-3">Chairman Office</h3>
                                                                    <div class="space-y-3">
                                                                        <div class="flex items-center justify-between p-3 bg-gray-800 border border-gray-600 rounded-md">
                                                                            <div class="flex items-center space-x-3">
                                                                                <img class="h-8 w-8 rounded-full" src="https://placehold.co/32x32/555/fff?text=MB" alt="">
                                                                                <div>
                                                                                    <div class="text-sm font-medium text-white">Mike Brown</div>
                                                                                    <div class="text-xs text-gray-400">mike.brown@company.com</div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="flex items-center space-x-2">
                                                                                <span class="text-sm text-gray-400">Limited access</span>
                                                                                <span class="material-symbols-outlined text-gray-400 text-[20px]">expand_more</span>
                                                                            </div>
                                                                        </div>
                                                                        
                                                                        <div class="flex items-center justify-between p-3 bg-gray-800 border border-gray-600 rounded-md">
                                                                            <div class="flex items-center space-x-3">
                                                                                <img class="h-8 w-8 rounded-full" src="https://placehold.co/32x32/555/fff?text=SW" alt="">
                                                                                <div>
                                                                                    <div class="text-sm font-medium text-white">Sarah Wilson</div>
                                                                                    <div class="text-xs text-gray-400">sarah.wilson@company.com</div>
                                                                                </div>
                                                                            </div>
                                                                            <div class="flex items-center space-x-2">
                                                                                <span class="text-sm text-gray-400">View only</span>
                                                                                <span class="material-symbols-outlined text-gray-400 text-[20px]">expand_more</span>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                        </div>

                                                    </div>

                                                </div>
                                            </div>

                                            <!-- Right Column - Component Preview -->
                                            <div class="w-5/12 bg-gray-800 p-6">
                                                <h3 class="text-md font-semibold text-white mb-4">Component Preview</h3>
                                                <div class="bg-gray-700 rounded-lg p-4">
                                                    <div class="h-48 relative">
                                                        <svg class="w-full h-full" viewBox="0 0 200 100">
                                                            <path d="M0,80 L50,20 L100,70 L150,30 L200,60" stroke="#14b8a6" stroke-width="2" fill="none"/>
                                                            <circle cx="50" cy="20" r="2" fill="#14b8a6"/>
                                                            <circle cx="100" cy="70" r="2" fill="#14b8a6"/>
                                                            <circle cx="150" cy="30" r="2" fill="#14b8a6"/>
                                                            <circle cx="200" cy="60" r="2" fill="#14b8a6"/>
                                                        </svg>
                                                        <div class="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-gray-400">
                                                            <span>12:00 am</span>
                                                            <span>6:00 am</span>
                                                            <span>12:00 pm</span>
                                                            <span>6:00 pm</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                        </div>
                                        
                                    </div>
                                </div><!-- CLOSING Components Details Modal -->

                            </div>
                        </div>
                
                        <!-- Right Column - Component Statistics -->
                        <div class="w-64 bg-gray-800 border-l border-gray-700 h-full fixed right-0 top-0 overflow-y-auto" style="height: calc(100vh - 68px); margin-top: 68px;">
                            <div class="p-4">
                                <h3 class="text-md font-semibold text-white mb-4">Quick Stats</h3>
                                <div class="space-y-4">
                            <!-- Total Components -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 flex items-center justify-center bg-blue-600 rounded-lg">
                                        <span class="material-symbols-outlined text-white text-xl">grid_view</span>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-400">Total Components</p>
                                        <p class="text-lg font-bold text-white">67</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Active Components -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 flex items-center justify-center bg-green-600 rounded-lg">
                                        <span class="material-symbols-outlined text-white text-xl">check_circle</span>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-400">Active Components</p>
                                        <p class="text-lg font-bold text-white">54</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Pending Review -->
                            <div class="bg-gray-700 rounded-lg p-4">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 flex items-center justify-center bg-yellow-600 rounded-lg">
                                        <span class="material-symbols-outlined text-white text-xl">schedule</span>
                                    </div>
                                    <div class="ml-4">
                                        <p class="text-sm font-medium text-gray-400">Pending Review</p>
                                        <p class="text-lg font-bold text-white">13</p>
                                    </div>
                                </div>
                            </div>
                        </div><!-- CLOSING Right Column - Component Statistics -->

                    </div><!-- CLOSING <div class="flex w-full"> -->
                </div><!-- CLOSING Components Tab Content -->
                    </div>
                </div>

            </main>
        </div>

    </div>

    <!-- Create Content Modal -->
    <div id="create-content-modal" class="fixed inset-0 bg-black p-10 bg-opacity-50 flex justify-center items-start z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-xl w-11/12 max-h-full max-w-[680px] flex flex-col">
            <!-- Modal Header -->
            <div class="py-4 px-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 id="create-content-modal-title" class="text-xl font-semibold text-white">Create</h2>
                    <button id="close-create-content-modal" class="flex items-center text-gray-400 hover:text-white transition duration-200">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div id="create-content-modal-content" class="flex-1 overflow-y-auto p-6">
                <p id="create-content-modal-description" class="text-gray-300 font-semibold mb-6">Select a Workspace to proceed</p>
                
                <!-- Private Section -->
                <div>
                    <a href="#" id="private-workspace-link" class="block w-full bg-gray-800 hover:bg-gray-700 border border-gray-600 rounded-lg p-3 transition duration-200 text-white flex items-center">
                        <span class="material-symbols-outlined mr-3" style="font-size: 20px;">lock</span>
                        <span class="text-sm font-medium">Private</span>
                    </a>
                </div>

                <!-- Workspaces Section -->
                <div>
                    <div class="border-t border-gray-700 my-4"></div>
                    <div id="workspaces-list" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <!-- Workspace links will be dynamically generated here -->
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-700">
                <div class="flex items-center justify-end space-x-3">
                    <button type="button" id="cancel-create-content" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    </div>

    <button id="ai-chat-button" class="fixed bottom-6 right-6 bg-red-600 hover:bg-red-700 text-white p-3 rounded-full shadow-lg transition duration-300 transform hover:scale-110 focus:outline-none focus:ring-2 focus:ring-red-400 z-50">
        <!-- Chat Bubble Icon SVG -->
         <img src="../ai-icon.svg" alt="AI Chat Icon" class="w-6 h-6" />
        <!-- <svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z"/>
        </svg> -->
    </button>

    <div id="ai-chat-window" class="fixed bg-gray-800 rounded-xl shadow-2xl flex overflow-hidden transition-all duration-300 ease-in-out z-50">
        <div id="chat-content-wrapper" class="flex flex-col flex-shrink-0 w-80 h-full">
            <div class="bg-gray-700 p-3 flex items-center justify-between">
                <h3 class="text-white font-semibold text-lg">Lumen AI Agent</h3>
                <div class="flex space-x-2">
                    <button id="expand-chat-button" class="text-gray-300 hover:text-white p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><polyline points="15 3 21 3 21 9"></polyline><polyline points="9 21 3 21 3 15"></polyline><path d="M21 3 14 10"></path><path d="M3 21 10 14"></path></svg>
                    </button>
                    <button id="close-chat-button" class="text-gray-300 hover:text-white p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-gray-600">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                    </button>
                </div>
            </div>
            <div class="flex-grow p-3 overflow-y-auto space-y-3" id="chat-messages">
                <div class="flex justify-start">
                    <div class="bg-gray-600 text-white p-2 rounded-lg max-w-[80%]">
                        Hello! I'm Lumen. How can I help you today?
                    </div>
                </div>
                <div class="flex justify-end">
                    <div class="bg-blue-600 text-white p-2 rounded-lg max-w-[80%]">
                        Show me the latest Q2 Finance story.
                    </div>
                </div>
            </div>
            <div class="p-3 border-t border-gray-700 flex items-center">
                <input type="text" id="chat-input" placeholder="Type your message..." class="flex-grow bg-gray-700 text-white rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm placeholder-gray-400">
                <button id="send-chat-button" class="ml-2 bg-red-600 hover:bg-red-700 text-white p-2 rounded-full transition duration-200 focus:outline-none focus:ring-2 focus:ring-red-400" disabled>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                </button>
            </div>
        </div>

        <div id="ai-panel-separator" class="hidden"></div>

        <div id="ai-interactive-panel" class="relative flex-shrink-0 h-full overflow-hidden transition-all duration-300 ease-in-out bg-gray-900 rounded-xl shadow-inner">
            <div class="panel-header p-3 flex items-center justify-between rounded-tr-xl">
                <h4 id="interactive-panel-title" class="text-white font-semibold text-md">Component View</h4>
                <button id="close-interactive-panel-button" class="text-gray-300 hover:text-white p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-gray-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M10 4H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h5"/><path d="m17 8-4 4 4 4"/><path d="M13 20V4"/></svg>
                </button>
            </div>
            <div id="interactive-panel-content" class="flex-grow p-3 text-gray-300 flex items-center justify-center text-center">
                <p>Interactive content will appear here.</p>
            </div>
        </div>
    </div>

    <script src="../js/ai-chat.js"></script>
    <script src="../js/create-content-modal.js"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {

            // Search functionality
            const searchIconButton = document.getElementById('search-icon-button');
            const searchInputWrapper = document.getElementById('search-input-wrapper');
            const headerSearchInput = document.getElementById('header-search-input');

            searchIconButton.addEventListener('click', () => {
                searchInputWrapper.classList.toggle('is-active');
                if (searchInputWrapper.classList.contains('is-active')) {
                    headerSearchInput.focus();
                }
            });

            // Utility for toggling dropdowns with mutual exclusivity
            function setupDropdown(buttonId, menuId, otherMenuId) {
                const button = document.getElementById(buttonId);
                const menu = document.getElementById(menuId);
                const otherMenu = otherMenuId ? document.getElementById(otherMenuId) : null;

                if (button && menu) {
                    button.addEventListener('click', (event) => {
                        event.stopPropagation(); // Prevent document click from immediately closing
                        const wasHidden = menu.classList.contains('hidden');
                        
                        // Close the other dropdown if it exists
                        if (otherMenu && !otherMenu.classList.contains('hidden')) {
                            otherMenu.classList.add('hidden');
                        }
                        
                        // Toggle this dropdown
                        if (wasHidden) {
                            menu.classList.remove('hidden');
                        } else {
                            menu.classList.add('hidden');
                        }
                    });

                    // Close dropdown if clicked outside
                    document.addEventListener('click', (event) => {
                        if (!button.contains(event.target) && !menu.contains(event.target)) {
                            menu.classList.add('hidden');
                        }
                    });
                }
            }

            // Setup User Dropdown (with reference to Create dropdown)
            setupDropdown('user-dropdown-button', 'user-dropdown-menu', 'create-dropdown-menu');

            // Setup Create Dropdown (with reference to User dropdown)
            setupDropdown('create-dropdown-button', 'create-dropdown-menu', 'user-dropdown-menu');

            // Close search when clicking outside
            document.addEventListener('click', (event) => {
                if (!searchIconButton.contains(event.target) && !searchInputWrapper.contains(event.target)) {
                    searchInputWrapper.classList.remove('is-active');
                }
            });

            // Close dropdowns when clicking outside
            document.addEventListener('click', (event) => {
                if (!event.target.closest('[id^="dropdown-"]') && !event.target.closest('button[onclick*="toggleDropdown"]')) {
                    document.querySelectorAll('[id^="dropdown-"]').forEach(dropdown => {
                        dropdown.classList.add('hidden');
                    });
                }
            });

            // Close component dropdowns when clicking outside
            document.addEventListener('click', (event) => {
                if (!event.target.closest('[id^="component-dropdown-"]') && !event.target.closest('button[onclick*="toggleDropdown"]') && !event.target.closest('a[onclick*="openComponentModal"]')) {
                    document.querySelectorAll('[id^="component-dropdown-"]').forEach(dropdown => {
                        dropdown.classList.add('hidden');
                    });
                }
            });
            
            // Close filter dropdowns when clicking outside
            document.addEventListener('click', (event) => {
                if (!event.target.closest('[id^="filter-dropdown-"]') && !event.target.closest('button[onclick*="toggleDropdown"]') && !event.target.closest('a[onclick*="openFilterModal"]')) {
                    document.querySelectorAll('[id^="filter-dropdown-"]').forEach(dropdown => {
                        dropdown.classList.add('hidden');
                    });
                }
            });

            // Handle checkbox changes
            document.querySelectorAll('#role-filter-dropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateFilterState('role', checkbox.value, checkbox.checked);
                    updateFilterButton('role-filter-btn', filterStates.role);
                });
            });

            document.querySelectorAll('#workspace-filter-dropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateFilterState('workspace', checkbox.value, checkbox.checked);
                    updateFilterButton('workspace-filter-btn', filterStates.workspace);
                });
            });

            document.querySelectorAll('#status-filter-dropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateFilterState('status', checkbox.value, checkbox.checked);
                    updateFilterButton('status-filter-btn', filterStates.status);
                });
            });

            function updateFilterState(filterType, value, checked) {
                if (checked) {
                    if (!filterStates[filterType].includes(value)) {
                        filterStates[filterType].push(value);
                    }
                } else {
                    filterStates[filterType] = filterStates[filterType].filter(item => item !== value);
                }
            }

            function updateFilterButton(buttonId, selectedValues) {
                const button = document.getElementById(buttonId);
                const buttonText = button.querySelector('span:first-child');
                const filterType = buttonId.split('-')[0];
                const clearBtn = document.getElementById(filterType + '-clear-btn');
                
                if (selectedValues.length === 0) {
                    buttonText.textContent = filterType.charAt(0).toUpperCase() + filterType.slice(1);
                    clearBtn.classList.add('hidden');
                } else {
                    buttonText.textContent = selectedValues.join(', ');
                    clearBtn.classList.remove('hidden');
                }
                
                // Update "Clear All Filters" button visibility
                updateClearAllFiltersButton();
            }

            function updateClearAllFiltersButton() {
                const clearAllBtn = document.getElementById('clear-all-filters-btn');
                const hasAnyFilters = filterStates.role.length > 0 || filterStates.workspace.length > 0 || filterStates.status.length > 0;
                
                if (hasAnyFilters) {
                    clearAllBtn.classList.remove('hidden');
                } else {
                    clearAllBtn.classList.add('hidden');
                }
            }

            

            function clearFilter(filterType) {
                // Clear the filter state
                filterStates[filterType] = [];
                
                // Uncheck all checkboxes in the dropdown
                document.querySelectorAll(`#${filterType}-filter-dropdown input[type="checkbox"]`).forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Update the button text
                updateFilterButton(`${filterType}-filter-btn`, []);
                
                // Close the dropdown
                const dropdown = document.getElementById(`${filterType}-filter-dropdown`);
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
            }

            function clearAllFilters() {
                // Clear all filter states
                Object.keys(filterStates).forEach(filterType => {
                    filterStates[filterType] = [];
                    
                    // Uncheck all checkboxes in each dropdown
                    document.querySelectorAll(`#${filterType}-filter-dropdown input[type="checkbox"]`).forEach(checkbox => {
                        checkbox.checked = false;
                    });
                    
                    // Update each button text
                    updateFilterButton(`${filterType}-filter-btn`, []);
                });
                
                // Close all filter dropdowns
                filterDropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        dropdown.classList.add('hidden');
                    }
                });
            }

            // Close component filter dropdowns when clicking outside
            document.addEventListener('click', (event) => {
                // Don't close if clicking on checkboxes or their labels inside component filter dropdowns
                if (event.target.type === 'checkbox' || event.target.closest('label')) {
                    return;
                }
                
                if (!event.target.closest('[id^="category-filter-"]') && !event.target.closest('[id^="type-filter-"]') && !event.target.closest('[id^="component-status-filter-"]') && !event.target.closest('button[id*="filter"]')) {
                    componentFilterDropdowns.forEach(dropdownId => {
                        const dropdown = document.getElementById(dropdownId);
                        if (dropdown) {
                            dropdown.classList.add('hidden');
                        }
                    });
                }
            });

            // Components search functionality
            const componentsSearchInput = document.getElementById('components-search-input');
            const componentsSearchClear = document.getElementById('components-search-clear');
            
            if (componentsSearchInput && componentsSearchClear) {
                componentsSearchInput.addEventListener('input', (event) => {
                    const searchTerm = event.target.value.toLowerCase();
                    filterComponents();
                    
                    // Show/hide clear button based on input value
                    if (searchTerm.length > 0) {
                        componentsSearchClear.style.display = 'flex';
                    } else {
                        componentsSearchClear.style.display = 'none';
                    }
                });

                // Clear button functionality
                componentsSearchClear.addEventListener('click', () => {
                    componentsSearchInput.value = '';
                    componentsSearchClear.style.display = 'none';
                    filterComponents();
                    componentsSearchInput.focus();
                });
            }

            function filterComponents() {
                const searchTerm = componentsSearchInput ? componentsSearchInput.value.toLowerCase() : '';
                const rows = document.querySelectorAll('#components-content tbody tr');
                const noMatchesMessage = document.getElementById('no-component-matches-message');
                let visibleCount = 0;
                
                rows.forEach(row => {
                    const componentText = row.textContent.toLowerCase();
                    const matchesSearch = searchTerm === '' || componentText.includes(searchTerm);
                    
                    // Additional filter logic can be added here
                    row.style.display = matchesSearch ? '' : 'none';
                    if (matchesSearch) visibleCount++;
                });
                
                // Show/hide no matches message
                if (searchTerm.length > 0 && visibleCount === 0) {
                    noMatchesMessage.classList.remove('hidden');
                } else {
                    noMatchesMessage.classList.add('hidden');
                }
            }

            // Components filter functionality
            const componentFilterButtons = ['category-filter-btn', 'type-filter-btn', 'component-status-filter-btn'];
            const componentFilterDropdowns = ['category-filter-dropdown', 'type-filter-dropdown', 'component-status-filter-dropdown'];

            // Initialize component filter states
            const componentFilterStates = {
                category: [],
                type: [],
                status: []
            };

            // Toggle component filter dropdowns
            componentFilterButtons.forEach((btnId, index) => {
                const button = document.getElementById(btnId);
                if (button) {
                    const dropdown = document.getElementById(componentFilterDropdowns[index]);
                    
                    button.addEventListener('click', (event) => {
                        event.stopPropagation();
                        
                        // Close other dropdowns
                        componentFilterDropdowns.forEach((dropdownId, i) => {
                            if (i !== index) {
                                const otherDropdown = document.getElementById(dropdownId);
                                if (otherDropdown) {
                                    otherDropdown.classList.add('hidden');
                                }
                            }
                        });
                        
                        dropdown.classList.toggle('hidden');
                    });
                }
            });

            // Handle component filter checkbox changes
            document.querySelectorAll('#category-filter-dropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateComponentFilterState('category', checkbox.value, checkbox.checked);
                    updateComponentFilterButton('category-filter-btn', componentFilterStates.category);
                });
            });

            document.querySelectorAll('#type-filter-dropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateComponentFilterState('type', checkbox.value, checkbox.checked);
                    updateComponentFilterButton('type-filter-btn', componentFilterStates.type);
                });
            });

            document.querySelectorAll('#component-status-filter-dropdown input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateComponentFilterState('status', checkbox.value, checkbox.checked);
                    updateComponentFilterButton('component-status-filter-btn', componentFilterStates.status);
                });
            });

            function updateComponentFilterState(filterType, value, checked) {
                if (checked) {
                    if (!componentFilterStates[filterType].includes(value)) {
                        componentFilterStates[filterType].push(value);
                    }
                } else {
                    componentFilterStates[filterType] = componentFilterStates[filterType].filter(item => item !== value);
                }
            }

            function updateComponentFilterButton(buttonId, selectedValues) {
                const button = document.getElementById(buttonId);
                if (!button) return;
                
                const buttonText = button.querySelector('span:first-child');
                
                // Handle different filter types with proper clear button IDs
                let clearBtnId;
                let defaultText;
                
                if (buttonId === 'category-filter-btn') {
                    clearBtnId = 'category-clear-btn';
                    defaultText = 'Category';
                } else if (buttonId === 'type-filter-btn') {
                    clearBtnId = 'type-clear-btn';
                    defaultText = 'Type';
                } else if (buttonId === 'component-status-filter-btn') {
                    clearBtnId = 'component-status-clear-btn';
                    defaultText = 'Status';
                }
                
                const clearBtn = document.getElementById(clearBtnId);
                
                if (selectedValues.length === 0) {
                    buttonText.textContent = defaultText;
                    if (clearBtn) clearBtn.classList.add('hidden');
                } else {
                    buttonText.textContent = selectedValues.join(', ');
                    if (clearBtn) clearBtn.classList.remove('hidden');
                }
                
                // Update "Clear All Filters" button visibility
                updateComponentClearAllFiltersButton();
            }

            function updateComponentClearAllFiltersButton() {
                const clearAllBtn = document.getElementById('clear-all-component-filters-btn');
                if (!clearAllBtn) return;
                
                const hasAnyFilters = componentFilterStates.category.length > 0 || componentFilterStates.type.length > 0 || componentFilterStates.status.length > 0;
                
                if (hasAnyFilters) {
                    clearAllBtn.classList.remove('hidden');
                } else {
                    clearAllBtn.classList.add('hidden');
                }
            }

            // Clear individual component filter buttons
            const categoryClearBtn = document.getElementById('category-clear-btn');
            if (categoryClearBtn) {
                categoryClearBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    clearComponentFilter('category');
                });
            }

            const typeClearBtn = document.getElementById('type-clear-btn');
            if (typeClearBtn) {
                typeClearBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    clearComponentFilter('type');
                });
            }

            const componentStatusClearBtn = document.getElementById('component-status-clear-btn');
            if (componentStatusClearBtn) {
                componentStatusClearBtn.addEventListener('click', (event) => {
                    event.stopPropagation();
                    clearComponentFilter('status');
                });
            }

            // Clear all component filters button
            const clearAllComponentFiltersBtn = document.getElementById('clear-all-component-filters-btn');
            if (clearAllComponentFiltersBtn) {
                clearAllComponentFiltersBtn.addEventListener('click', () => {
                    clearAllComponentFilters();
                });
            }

            function clearComponentFilter(filterType) {
                // Clear the filter state
                componentFilterStates[filterType] = [];
                
                // Uncheck all checkboxes in the dropdown
                let dropdownId;
                let buttonId;
                
                if (filterType === 'category') {
                    dropdownId = 'category-filter-dropdown';
                    buttonId = 'category-filter-btn';
                } else if (filterType === 'type') {
                    dropdownId = 'type-filter-dropdown';
                    buttonId = 'type-filter-btn';
                } else if (filterType === 'status') {
                    dropdownId = 'component-status-filter-dropdown';
                    buttonId = 'component-status-filter-btn';
                }
                
                document.querySelectorAll(`#${dropdownId} input[type="checkbox"]`).forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Update the button text
                updateComponentFilterButton(buttonId, []);
                
                // Close the dropdown
                const dropdown = document.getElementById(dropdownId);
                if (dropdown) {
                    dropdown.classList.add('hidden');
                }
            }

            function clearAllComponentFilters() {
                // Clear all filter states
                componentFilterStates.category = [];
                componentFilterStates.type = [];
                componentFilterStates.status = [];
                
                // Uncheck all checkboxes in each dropdown
                document.querySelectorAll('#category-filter-dropdown input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                document.querySelectorAll('#type-filter-dropdown input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                document.querySelectorAll('#component-status-filter-dropdown input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
                
                // Update each button text
                updateComponentFilterButton('category-filter-btn', []);
                updateComponentFilterButton('type-filter-btn', []);
                updateComponentFilterButton('component-status-filter-btn', []);
                
                // Close all component filter dropdowns
                componentFilterDropdowns.forEach(dropdownId => {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) {
                        dropdown.classList.add('hidden');
                    }
                });
            }

            // Component Modal Functionality
            const componentModal = document.getElementById('component-modal');
            const closeComponentModal = document.getElementById('close-component-modal');
            const componentTableRows = document.querySelectorAll('#components-table tbody tr');


            // Add event listeners for Edit Component links
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('edit-component-link')) {
                    event.preventDefault();
                    event.stopPropagation();
                    openComponentModal();
                }
            });

            // Open modal when clicking on component table rows
            componentTableRows.forEach(row => {
                row.addEventListener('click', (event) => {
                    // Don't open modal if clicking on dropdown button
                    if (event.target.closest('.options-dropdown-button')) {
                        return;
                    }
                    openComponentModal();
                });
            });

            // Close modal
            closeComponentModal.addEventListener('click', () => {
                componentModal.classList.add('hidden');
                document.body.style.overflow = ''; // Restore scrolling
                
                // Reset tab initialization flags so they can be re-initialized next time
                componentModalTabsInitialized = false;
                componentVisualTabsInitialized = false;
            });

            // Close modal when clicking outside
            componentModal.addEventListener('click', (event) => {
                if (event.target === componentModal) {
                    componentModal.classList.add('hidden');
                    document.body.style.overflow = '';
                    
                    // Reset tab initialization flags so they can be re-initialized next time
                    componentModalTabsInitialized = false;
                    componentVisualTabsInitialized = false;
                }
            });

            // Metadata expand/collapse functionality
            const expandMetadataBtn = document.getElementById('expand-metadata-btn');
            if (expandMetadataBtn) {
                expandMetadataBtn.addEventListener('click', function() {
                    const extraMetadata = document.querySelectorAll('.metadata-extra');
                    const icon = this.querySelector('.material-symbols-outlined');
                    
                    if (extraMetadata[0] && extraMetadata[0].classList.contains('hidden')) {
                        // Expand metadata
                        extraMetadata.forEach(item => item.classList.remove('hidden'));
                        icon.textContent = 'expand_less';
                    } else {
                        // Collapse metadata
                        extraMetadata.forEach(item => item.classList.add('hidden'));
                        icon.textContent = 'expand_more';
                    }
                });
            }


            // Results Tab Switching (within Data Source tab)
            const resultsTabs = document.querySelectorAll('.results-tab');
            const resultsTabContents = document.querySelectorAll('.results-tab-content');
            
            resultsTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetResultsTab = tab.getAttribute('data-results-tab');
                    
                    // Reset all tabs to inactive state
                    resultsTabs.forEach(t => {
                        t.classList.remove('bg-blue-600', 'text-white');
                        t.classList.add('bg-gray-700', 'text-gray-400', 'hover:bg-gray-600');
                        t.classList.remove('rounded-l-md', 'border-r', 'border-gray-600');
                        t.classList.add('rounded-r-md');
                    });
                    
                    // Set the clicked tab to active state
                    tab.classList.add('bg-blue-600', 'text-white');
                    tab.classList.remove('bg-gray-700', 'text-gray-400', 'hover:bg-gray-600');
                    
                    // Handle border styling for button group based on which tab is active
                    if (targetResultsTab === 'query-result') {
                        // Query Result is active - it should be left rounded with border
                        tab.classList.add('rounded-l-md', 'border-r', 'border-gray-600');
                        tab.classList.remove('rounded-r-md');
                        
                        // Datapoints Summary should be right rounded without border
                        const datapointsTab = document.querySelector('[data-results-tab="datapoints-summary"]');
                        if (datapointsTab) {
                            datapointsTab.classList.add('rounded-r-md');
                            datapointsTab.classList.remove('rounded-l-md', 'border-r', 'border-gray-600');
                        }
                    } else {
                        // Datapoints Summary is active - it should be right rounded without border
                        tab.classList.add('rounded-r-md');
                        tab.classList.remove('rounded-l-md', 'border-r', 'border-gray-600');
                        
                        // Query Result should be left rounded with border
                        const queryTab = document.querySelector('[data-results-tab="query-result"]');
                        if (queryTab) {
                            queryTab.classList.add('rounded-l-md', 'border-r', 'border-gray-600');
                            queryTab.classList.remove('rounded-r-md');
                        }
                    }
                    
                    // Hide all results tab content
                    resultsTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target results tab content
                    const targetContent = document.getElementById(targetResultsTab + '-content');
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });

        });

        // Global dropdown functionality for user table
        function toggleDropdown(dropdownId) {
            // Close all other dropdowns (user, component, and filter dropdowns)
            document.querySelectorAll('[id^="dropdown-"], [id^="component-dropdown-"], [id^="filter-dropdown-"]').forEach(dropdown => {
                if (dropdown.id !== dropdownId) {
                    dropdown.classList.add('hidden');
                }
            });
            
            // Get the dropdown and button
            const dropdown = document.getElementById(dropdownId);
            const button = window.event ? window.event.target.closest('button') : event.target.closest('button');
            
            if (!dropdown) {
                return;
            }
            
            // Toggle the clicked dropdown
            dropdown.classList.toggle('hidden');
            
            if (!dropdown.classList.contains('hidden')) {
                // Ensure dropdown is appended to body if not already
                if (dropdown.parentElement !== document.body) {
                    document.body.appendChild(dropdown);
                }
                
                // Position the dropdown relative to the button
                const buttonRect = button.getBoundingClientRect();
                dropdown.style.position = 'fixed';
                dropdown.style.top = (buttonRect.bottom + 8) + 'px';
                dropdown.style.right = (window.innerWidth - buttonRect.right) + 'px';
            }
        }

        // Single-selection dropdown functionality for Data Binding tab
        document.addEventListener('DOMContentLoaded', function() {
            // Color tab dropdowns
            const colorRateOfChangeBtn = document.getElementById('color-rate-of-change-btn');
            const colorRateOfChangeDropdown = document.getElementById('color-rate-of-change-dropdown');
            const colorRateOfChangeSelected = document.getElementById('color-rate-of-change-selected');

            if (colorRateOfChangeBtn && colorRateOfChangeDropdown) {
                colorRateOfChangeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // Close all other dropdowns first
                    document.querySelectorAll('[id$="-dropdown"]').forEach(dropdown => {
                        if (dropdown !== colorRateOfChangeDropdown) {
                            dropdown.classList.add('hidden');
                        }
                    });
                    colorRateOfChangeDropdown.classList.toggle('hidden');
                });

                // Handle option selection
                colorRateOfChangeDropdown.querySelectorAll('[data-value]').forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        colorRateOfChangeSelected.textContent = value;
                        colorRateOfChangeDropdown.classList.add('hidden');
                    });
                });
            }

            const colorDataFieldBtn = document.getElementById('color-data-field-btn');
            const colorDataFieldDropdown = document.getElementById('color-data-field-dropdown');
            const colorDataFieldSelected = document.getElementById('color-data-field-selected');

            if (colorDataFieldBtn && colorDataFieldDropdown) {
                colorDataFieldBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // Close all other dropdowns first
                    document.querySelectorAll('[id$="-dropdown"]').forEach(dropdown => {
                        if (dropdown !== colorDataFieldDropdown) {
                            dropdown.classList.add('hidden');
                        }
                    });
                    colorDataFieldDropdown.classList.toggle('hidden');
                });

                // Handle option selection
                colorDataFieldDropdown.querySelectorAll('[data-value]').forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        colorDataFieldSelected.textContent = value;
                        colorDataFieldDropdown.classList.add('hidden');
                    });
                });
            }

            // Height tab dropdowns
            const heightRateOfChangeBtn = document.getElementById('height-rate-of-change-btn');
            const heightRateOfChangeDropdown = document.getElementById('height-rate-of-change-dropdown');
            const heightRateOfChangeSelected = document.getElementById('height-rate-of-change-selected');

            if (heightRateOfChangeBtn && heightRateOfChangeDropdown) {
                heightRateOfChangeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // Close all other dropdowns first
                    document.querySelectorAll('[id$="-dropdown"]').forEach(dropdown => {
                        if (dropdown !== heightRateOfChangeDropdown) {
                            dropdown.classList.add('hidden');
                        }
                    });
                    heightRateOfChangeDropdown.classList.toggle('hidden');
                });

                // Handle option selection
                heightRateOfChangeDropdown.querySelectorAll('[data-value]').forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        heightRateOfChangeSelected.textContent = value;
                        heightRateOfChangeDropdown.classList.add('hidden');
                    });
                });
            }

            const heightDataFieldBtn = document.getElementById('height-data-field-btn');
            const heightDataFieldDropdown = document.getElementById('height-data-field-dropdown');
            const heightDataFieldSelected = document.getElementById('height-data-field-selected');

            if (heightDataFieldBtn && heightDataFieldDropdown) {
                heightDataFieldBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    // Close all other dropdowns first
                    document.querySelectorAll('[id$="-dropdown"]').forEach(dropdown => {
                        if (dropdown !== heightDataFieldDropdown) {
                            dropdown.classList.add('hidden');
                        }
                    });
                    heightDataFieldDropdown.classList.toggle('hidden');
                });

                // Handle option selection
                heightDataFieldDropdown.querySelectorAll('[data-value]').forEach(option => {
                    option.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        heightDataFieldSelected.textContent = value;
                        heightDataFieldDropdown.classList.add('hidden');
                    });
                });
            }

            // Close dropdowns when clicking outside
            document.addEventListener('click', function(e) {
                const allDropdowns = document.querySelectorAll('[id$="-dropdown"]');
                const allButtons = document.querySelectorAll('[id$="-btn"]');
                
                let clickedInsideDropdown = false;
                let clickedInsideButton = false;
                
                allDropdowns.forEach(dropdown => {
                    if (dropdown.contains(e.target)) {
                        clickedInsideDropdown = true;
                    }
                });
                
                allButtons.forEach(button => {
                    if (button.contains(e.target)) {
                        clickedInsideButton = true;
                    }
                });
                
                if (!clickedInsideDropdown && !clickedInsideButton) {
                    allDropdowns.forEach(dropdown => {
                        dropdown.classList.add('hidden');
                    });
                }
            });

        });

        // Global variables for shared functionality
        let selectedDataSourceType = null;
        let selectedAiModel = null;
        let selectedDatabase = null;
        
        // Component Details Modal Visual Property Tab Switching
        let componentVisualTabsInitialized = false;
        function initializeComponentVisualPropertyTabs() {
            if (componentVisualTabsInitialized) return;
            componentVisualTabsInitialized = true;
            
            const visualPropertyTabs = document.querySelectorAll('#component-modal .component-visual-property-tab');
            const visualTabContents = document.querySelectorAll('#component-modal .component-visual-tab-content');

            visualPropertyTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetVisualTab = tab.getAttribute('data-visual-tab');
                    
                    // Update tab styling
                    visualPropertyTabs.forEach(t => {
                        t.classList.remove('bg-blue-600', 'text-white');
                        t.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    });
                    tab.classList.add('bg-blue-600', 'text-white');
                    tab.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    
                    // Hide all visual tab content
                    visualTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target visual tab content
                    const targetContent = document.getElementById(targetVisualTab + '-tab-content');
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }
        
        // Component Modal Tab Switching
        let componentModalTabsInitialized = false;
        function initializeComponentModalTabs() {
            if (componentModalTabsInitialized) return;
            componentModalTabsInitialized = true;
            
            const componentModalTabs = document.querySelectorAll('#component-modal .internal-tab-item[data-tab]');
            const componentTabContents = document.querySelectorAll('.component-tab-content');

            componentModalTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-tab');
                    // Update tab styling to match internal tab style
                    componentModalTabs.forEach(t => {
                        t.classList.remove('border-red-500', 'text-white');
                        t.classList.add('border-transparent', 'text-gray-400');
                    });
                    tab.classList.add('border-red-500', 'text-white');
                    tab.classList.remove('border-transparent', 'text-gray-400');
                    
                    // Show target content
                    componentTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    // Handle the tab name conversions
                    let tabId;
                    if (targetTab === 'data-source') {
                        tabId = 'data-source-tab';
                    } else if (targetTab === 'mapping-customization') {
                        tabId = 'mapping-customization-tab';
                    } else if (targetTab === 'filters') {
                        tabId = 'filters-tab';
                    } else {
                        tabId = targetTab + '-tab';
                    }
                    const targetElement = document.getElementById(tabId);
                    if (targetElement) {
                        targetElement.classList.remove('hidden');
                    }
                });
            });
        }
        
        // Global function to open component modal
        function openComponentModal() {
            const componentModal = document.getElementById('component-modal');
            
            // Check if modal exists
            if (!componentModal) {
                return;
            }
            
            // Close all component dropdowns first
            document.querySelectorAll('[id^="component-dropdown-"]').forEach(dropdown => {
                dropdown.classList.add('hidden');
            });
            
            // Open modal immediately
            componentModal.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
            
            // Reset modal tabs to show Data Source tab by default
            const componentModalTabs = document.querySelectorAll('#component-modal .internal-tab-item[data-tab]');
            const componentTabContents = document.querySelectorAll('.component-tab-content');
            
            // Reset all tabs to inactive state
            componentModalTabs.forEach(tab => {
                tab.classList.remove('border-red-500', 'text-white');
                tab.classList.add('border-transparent', 'text-gray-400');
            });
            
            // Hide all tab contents
            componentTabContents.forEach(content => {
                content.classList.add('hidden');
            });
            
            // Activate Data Source tab
            const dataSourceTab = document.querySelector('#component-modal .internal-tab-item[data-tab="data-source"]');
            const dataSourceTabContent = document.getElementById('data-source-tab');
            
            if (dataSourceTab && dataSourceTabContent) {
                dataSourceTab.classList.add('border-red-500', 'text-white');
                dataSourceTab.classList.remove('border-transparent', 'text-gray-400');
                dataSourceTabContent.classList.remove('hidden');
            }
            
            // Initialize component action dropdown (3-dot menu)
            initializeComponentActionDropdown();
            
            // Initialize main component modal tabs (Data Source, Mapping & Customization, Filters, etc.)
            initializeComponentModalTabs();
            
            // Initialize Data Source tab request tabs (Parameters, Authentication, Headers, Body, Scripts)
            initializeDataSourceRequestTabs();
            
            // Initialize Data Source tab script inner tabs (Pre-Request, Post-Request)
            initializeDataSourceScriptInnerTabs();
            
            // Initialize component visual property tabs (Y-Axis, Series, Legend)
            initializeComponentVisualPropertyTabs();
            
            // Update mapping validation icons
            updateMappingValidationIcons();
        }
        let selectedApi = null;
        let tempSelectedAiModel = null;
        let tempSelectedDatabase = null;
        let tempSelectedApi = null;
        let databases = [
            { id: 'mysql-prod', name: 'Production MySQL', type: 'mysql', host: 'mysql.prod.company.com', port: '3306', dbname: 'production_db', username: 'app_user', description: 'Production database for live application', lastUpdated: '1 hour ago' },
            { id: 'postgres-analytics', name: 'Analytics PostgreSQL', type: 'postgresql', host: 'analytics.company.com', port: '5432', dbname: 'analytics_db', username: 'analytics_user', description: 'Analytics and reporting database', lastUpdated: '3 hours ago' },
            { id: 'sqlserver-warehouse', name: 'Data Warehouse', type: 'sqlserver', host: 'warehouse.company.com', port: '1433', dbname: 'warehouse_db', username: 'warehouse_user', description: 'Data warehouse for business intelligence', lastUpdated: '6 hours ago' },
            { id: 'oracle-finance', name: 'Finance Oracle', type: 'oracle', host: 'finance.company.com', port: '1521', dbname: 'finance_db', username: 'finance_user', description: 'Financial data and transactions', lastUpdated: '2 hours ago' },
            { id: 'sqlite-local', name: 'Local Development', type: 'sqlite', host: 'localhost', port: '', dbname: 'dev.db', username: '', description: 'Local development database', lastUpdated: '30 mins ago' }
        ];
        let apiCollections = [
            {
                id: 'weather-services',
                name: 'Weather Services',
                description: 'Real-time weather data and forecasts',
                status: 'Active',
                lastUpdated: '2 hours ago',
                requests: [
                    { id: 'get-current-weather', name: 'Get Current Weather', url: 'https://weather.secureclient.com/api/v1/current', method: 'GET', auth: 'api-key', description: 'Retrieve current weather conditions', status: 'Active', lastUpdated: '1 hour ago' },
                    { id: 'get-weather-forecast', name: 'Get Weather Forecast', url: 'https://weather.secureclient.com/api/v1/forecast', method: 'POST', auth: 'api-key', description: 'Get 7-day weather forecast for location', status: 'Active', lastUpdated: '45 mins ago' }
                ]
            },
            {
                id: 'traffic-services',
                name: 'Traffic Services',
                description: 'Real-time traffic data and route optimization',
                status: 'Active',
                lastUpdated: '1 day ago',
                requests: [
                    { id: 'get-traffic-flow', name: 'Get Traffic Flow', url: 'https://traffic.secureclient.com/api/v1/flow', method: 'POST', auth: 'bearer', description: 'Retrieve real-time traffic flow data', status: 'Active', lastUpdated: '3 hours ago' }
                ]
            },
            {
                id: 'customer-services',
                name: 'Customer Services',
                description: 'Customer data and account management',
                status: 'Active',
                lastUpdated: '4 hours ago',
                requests: [
                    { id: 'customer-portal-api', name: 'Customer Portal API', url: 'https://api.customerportal.company.com/v1', method: 'GET', auth: 'bearer', description: 'Internal customer data and account information', status: 'Active', lastUpdated: '2 hours ago' },
                    { id: 'hr-system-api', name: 'HR System API', url: 'https://api.hr.company.com/employees', method: 'GET', auth: 'bearer', description: 'Employee data and organizational structure', status: 'Active', lastUpdated: '1 day ago' }
                ]
            },
            {
                id: 'business-services',
                name: 'Business Services',
                description: 'Business operations and reporting',
                status: 'Active',
                lastUpdated: '6 hours ago',
                requests: [
                    { id: 'inventory-management-api', name: 'Inventory Management API', url: 'https://api.inventory.company.com/v2', method: 'POST', auth: 'api-key', description: 'Real-time inventory tracking and stock management', status: 'Active', lastUpdated: '30 mins ago' },
                    { id: 'financial-reporting-api', name: 'Financial Reporting API', url: 'https://api.finance.company.com/reports', method: 'GET', auth: 'api-key', description: 'Financial data and reporting metrics', status: 'Active', lastUpdated: '1 hour ago' },
                    { id: 'logistics-tracking-api', name: 'Logistics Tracking API', url: 'https://api.logistics.company.com/tracking', method: 'POST', auth: 'none', description: 'Shipment tracking and delivery status updates', status: 'Active', lastUpdated: '15 mins ago' }
                ]
            }
        ];
        
        // Flatten all requests for backward compatibility
        let apis = [];
        apiCollections.forEach(collection => {
            collection.requests.forEach(request => {
                apis.push({
                    ...request,
                    collectionId: collection.id,
                    collectionName: collection.name
                });
            });
        });
        let filteredDatabases = [...databases];
        let filteredApis = [...apis];
        let aiModels = [
            { id: 'energy-demand-forecast', name: 'Energy Demand Forecast', description: 'Predicts energy consumption based on weather patterns and historical usage data', provider: 'utility', type: 'predictive' },
            { id: 'customer-feedback-nlp', name: 'Customer Feedback Analyzer', description: 'Categorizes and analyzes customer feedback for sentiment and topic classification', provider: 'retail', type: 'nlp' },
            { id: 'traffic-policy-simulator', name: 'Traffic Policy Simulator', description: 'Simulates traffic flow changes and congestion impact of new traffic policies', provider: 'municipal', type: 'simulation' },
            { id: 'inventory-optimization', name: 'Inventory Optimization Model', description: 'Optimizes inventory levels based on demand forecasting and supply chain constraints', provider: 'logistics', type: 'optimization' },
            { id: 'fraud-detection-finance', name: 'Financial Fraud Detector', description: 'Detects fraudulent transactions using pattern recognition and behavioral analysis', provider: 'finance', type: 'anomaly' },
            { id: 'crop-yield-predictor', name: 'Crop Yield Predictor', description: 'Predicts crop yields based on soil conditions, weather data, and farming practices', provider: 'agriculture', type: 'predictive' },
            { id: 'patient-diagnosis-assistant', name: 'Medical Diagnosis Assistant', description: 'Assists in medical diagnosis by analyzing patient symptoms and medical history', provider: 'healthcare', type: 'diagnostic' },
            { id: 'supply-chain-optimizer', name: 'Supply Chain Optimizer', description: 'Optimizes supply chain routes and inventory distribution across multiple locations', provider: 'manufacturing', type: 'optimization' },
            { id: 'real-estate-valuation', name: 'Real Estate Valuation Model', description: 'Estimates property values based on market trends, location data, and property features', provider: 'real-estate', type: 'predictive' },
            { id: 'quality-control-inspector', name: 'Quality Control Inspector', description: 'Automated quality inspection using computer vision to detect manufacturing defects', provider: 'manufacturing', type: 'computer-vision' },
            { id: 'customer-churn-predictor', name: 'Customer Churn Predictor', description: 'Predicts customer churn likelihood based on usage patterns and service interactions', provider: 'telecom', type: 'predictive' },
            { id: 'energy-grid-optimizer', name: 'Smart Grid Optimizer', description: 'Optimizes energy distribution across the grid based on demand and renewable energy availability', provider: 'utility', type: 'optimization' },
            { id: 'logistics-route-planner', name: 'Logistics Route Planner', description: 'Plans optimal delivery routes considering traffic, weather, and delivery constraints', provider: 'logistics', type: 'optimization' },
            { id: 'market-trend-analyzer', name: 'Market Trend Analyzer', description: 'Analyzes market trends and provides investment recommendations based on historical data', provider: 'finance', type: 'analytics' },
            { id: 'maintenance-predictor', name: 'Predictive Maintenance Model', description: 'Predicts equipment maintenance needs based on sensor data and operational patterns', provider: 'manufacturing', type: 'predictive' },
            { id: 'risk-assessment-model', name: 'Risk Assessment Model', description: 'Assesses risk levels for insurance policies based on demographic and behavioral data', provider: 'insurance', type: 'predictive' }
        ];
        let filteredAiModels = [...aiModels];
        let currentStep = 1;
        
        // Visualization step variables
        let selectedVisualizationType = null;
        let selectedChartSubtype = null;
        let selectedMapLayerSubtype = null;
        let selectedKpiSubtype = null;
        
        // Data mapping variables
        let selectedXAxisField = null;
        let selectedYAxisField = null;
        let selectedValueField = null;
        let selectedKpiField = null;
        let selectedSeriesFields = [];
        let selectedFilterFields = [];
        let selectedYAxisFields = [];
        let selectedLabelField = null;

        // Global functions for shared functionality
        function updateSelectedDatabaseDisplay() {
            if (selectedDatabase) {
                const db = databases.find(d => d.id === selectedDatabase);
                if (db) {
                    const nameElement = document.getElementById('selected-database-name');
                    const detailsElement = document.getElementById('selected-database-details');
                    const iconElement = document.getElementById('selected-database-icon');
                    const databaseSelectionContainer = document.getElementById('database-selection-container');
                    const selectedDatabaseDisplay = document.getElementById('selected-database-display');
                    
                    if (nameElement) nameElement.textContent = db.name;
                    if (detailsElement) detailsElement.textContent = `${db.host}:${db.port} - ${db.dbname}`;
                    if (iconElement) iconElement.textContent = 'storage';
                    
                    if (databaseSelectionContainer && selectedDatabaseDisplay) {
                        databaseSelectionContainer.classList.add('hidden');
                        selectedDatabaseDisplay.classList.remove('hidden');
                    }
                }
            } else {
                const databaseSelectionContainer = document.getElementById('database-selection-container');
                const selectedDatabaseDisplay = document.getElementById('selected-database-display');
                if (databaseSelectionContainer && selectedDatabaseDisplay) {
                    databaseSelectionContainer.classList.remove('hidden');
                    selectedDatabaseDisplay.classList.add('hidden');
                }
            }
        }

        function updateSelectedApiDisplay() {
            if (selectedApi) {
                const api = apis.find(a => a.id === selectedApi);
                if (api) {
                    const nameElement = document.getElementById('selected-api-name');
                    const detailsElement = document.getElementById('selected-api-details');
                    const iconElement = document.getElementById('selected-api-icon');
                    const apiSelectionContainer = document.getElementById('api-selection-container');
                    const selectedApiDisplay = document.getElementById('selected-api-display');
                    const apiParametersField = document.getElementById('api-parameters-field');
                    
                    if (nameElement) nameElement.textContent = api.name;
                    if (detailsElement) detailsElement.textContent = `Collection: ${api.collectionName}`;
                    if (iconElement) iconElement.textContent = 'api';
                    
                    if (apiSelectionContainer && selectedApiDisplay) {
                        apiSelectionContainer.classList.add('hidden');
                        selectedApiDisplay.classList.remove('hidden');
                    }
                    
                    // Immediately show API parameters field
                    if (apiParametersField) {
                        apiParametersField.classList.remove('hidden');
                        // Initialize API configuration tabs and drag and drop
                        setTimeout(() => {
                            initializeComponentApiRequestTabs();
                            initializeComponentApiScriptInnerTabs();
                            initializeComponentApiDragAndDrop('#test-request-params-content .space-y-2');
                            initializeComponentApiDragAndDrop('#test-request-headers-content .space-y-2');
                            initializeComponentApiDragAndDrop('#test-request-body-content .space-y-2');
                        }, 100);
                    }
                }
            } else {
                const apiSelectionContainer = document.getElementById('api-selection-container');
                const selectedApiDisplay = document.getElementById('selected-api-display');
                const apiParametersField = document.getElementById('api-parameters-field');
                if (apiSelectionContainer && selectedApiDisplay) {
                    apiSelectionContainer.classList.remove('hidden');
                    selectedApiDisplay.classList.add('hidden');
                }
                if (apiParametersField) {
                    apiParametersField.classList.add('hidden');
                }
            }
        }

        function showDatabaseConnectionStatus() {
            const statusContainer = document.getElementById('database-connection-status');
            const loadingStatus = document.getElementById('database-loading-status');
            const successStatus = document.getElementById('database-success-status');
            const queryField = document.getElementById('database-query-field');
            
            if (statusContainer && loadingStatus && successStatus) {
                // Show loading status
                statusContainer.classList.remove('hidden');
                loadingStatus.classList.remove('hidden');
                successStatus.classList.add('hidden');
                
                // After 3 seconds, show success status and query field
                setTimeout(() => {
                    loadingStatus.classList.add('hidden');
                    successStatus.classList.remove('hidden');
                    
                    // Show query field
                    if (queryField) {
                        queryField.classList.remove('hidden');
                        // Initialize the database results tabs
                        initializeDatabaseResultsTabs();
                    }
                }, 3000);
            }
        }


        // API Results Tab Switching (within API Parameters field)
        function initializeApiResultsTabs() {
            const apiResultsTabs = document.querySelectorAll('.api-results-tab');
            const apiResultsTabContents = document.querySelectorAll('.api-results-tab-content');
            
            apiResultsTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetApiResultsTab = tab.getAttribute('data-api-results-tab');
                    
                    // Reset all API results tabs to inactive state
                    apiResultsTabs.forEach(t => {
                        t.classList.remove('bg-blue-600', 'text-white');
                        t.classList.add('bg-gray-700', 'text-gray-400', 'hover:bg-gray-600');
                        t.classList.remove('rounded-l-md', 'border-r', 'border-gray-600');
                        t.classList.add('rounded-r-md');
                    });
                    
                    // Set the clicked tab to active state
                    tab.classList.add('bg-blue-600', 'text-white');
                    tab.classList.remove('bg-gray-700', 'text-gray-400', 'hover:bg-gray-600');
                    
                    // Handle border styling for button group based on which tab is active
                    if (targetApiResultsTab === 'api-call-result') {
                        // API Call Result is active - it should be left rounded with border
                        tab.classList.add('rounded-l-md', 'border-r', 'border-gray-600');
                        tab.classList.remove('rounded-r-md');
                        
                        // API Datapoints Summary should be right rounded without border
                        const apiDatapointsTab = document.querySelector('[data-api-results-tab="api-datapoints-summary"]');
                        if (apiDatapointsTab) {
                            apiDatapointsTab.classList.add('rounded-r-md');
                            apiDatapointsTab.classList.remove('rounded-l-md', 'border-r', 'border-gray-600');
                        }
                    } else {
                        // API Datapoints Summary is active - it should be right rounded without border
                        tab.classList.add('rounded-r-md');
                        tab.classList.remove('rounded-l-md', 'border-r', 'border-gray-600');
                        
                        // API Call Result should be left rounded with border
                        const apiCallTab = document.querySelector('[data-api-results-tab="api-call-result"]');
                        if (apiCallTab) {
                            apiCallTab.classList.add('rounded-l-md', 'border-r', 'border-gray-600');
                            apiCallTab.classList.remove('rounded-r-md');
                        }
                    }
                    
                    // Hide all API results tab content
                    apiResultsTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target API results tab content
                    const targetContent = document.getElementById(targetApiResultsTab + '-content');
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Database Results Tab Switching (within Database Query field)
        function initializeDatabaseResultsTabs() {
            const databaseResultsTabs = document.querySelectorAll('.database-results-tab');
            const databaseResultsTabContents = document.querySelectorAll('.database-results-tab-content');
            
            databaseResultsTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetDatabaseResultsTab = tab.getAttribute('data-database-results-tab');
                    
                    // Reset all database results tabs to inactive state
                    databaseResultsTabs.forEach(t => {
                        t.classList.remove('bg-blue-600', 'text-white');
                        t.classList.add('bg-gray-700', 'text-gray-400', 'hover:bg-gray-600');
                        t.classList.remove('rounded-l-md', 'border-r', 'border-gray-600');
                        t.classList.add('rounded-r-md');
                    });
                    
                    // Set the clicked tab to active state
                    tab.classList.add('bg-blue-600', 'text-white');
                    tab.classList.remove('bg-gray-700', 'text-gray-400', 'hover:bg-gray-600');
                    
                    // Handle border styling for button group based on which tab is active
                    if (targetDatabaseResultsTab === 'database-query-result') {
                        // Database Query Result is active - it should be left rounded with border
                        tab.classList.add('rounded-l-md', 'border-r', 'border-gray-600');
                        tab.classList.remove('rounded-r-md');
                        
                        // Database Datapoints Summary should be right rounded without border
                        const databaseDatapointsTab = document.querySelector('[data-database-results-tab="database-datapoints-summary"]');
                        if (databaseDatapointsTab) {
                            databaseDatapointsTab.classList.add('rounded-r-md');
                            databaseDatapointsTab.classList.remove('rounded-l-md', 'border-r', 'border-gray-600');
                        }
                    } else {
                        // Database Datapoints Summary is active - it should be right rounded without border
                        tab.classList.add('rounded-r-md');
                        tab.classList.remove('rounded-l-md', 'border-r', 'border-gray-600');
                        
                        // Database Query Result should be left rounded with border
                        const databaseQueryTab = document.querySelector('[data-database-results-tab="database-query-result"]');
                        if (databaseQueryTab) {
                            databaseQueryTab.classList.add('rounded-l-md', 'border-r', 'border-gray-600');
                            databaseQueryTab.classList.remove('rounded-r-md');
                        }
                    }
                    
                    // Hide all database results tab content
                    databaseResultsTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target database results tab content
                    const targetContent = document.getElementById(targetDatabaseResultsTab + '-content');
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Component Query Language Tab Switching (SQL/Python)
        let componentQueryLanguageTabsInitialized = false;
        function initializeComponentQueryLanguageTabs() {
            if (componentQueryLanguageTabsInitialized) return;
            componentQueryLanguageTabsInitialized = true;
            
            const componentQueryLanguageTabs = document.querySelectorAll('.query-language-tab');
            const componentQueryLanguageTabContents = document.querySelectorAll('.query-language-tab-content');
            
            componentQueryLanguageTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetLanguageTab = tab.getAttribute('data-query-language-tab');
                    
                    // Reset all query language tabs to inactive state
                    componentQueryLanguageTabs.forEach(t => {
                        t.classList.remove('border-red-500', 'text-white');
                        t.classList.add('border-transparent', 'text-gray-400');
                    });
                    
                    // Set the clicked tab to active state
                    tab.classList.add('border-red-500', 'text-white');
                    tab.classList.remove('border-transparent', 'text-gray-400');
                    
                    // Hide all query language tab content
                    componentQueryLanguageTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target query language tab content
                    const targetContent = document.getElementById(targetLanguageTab + '-query-content');
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Component Query Results Tab Switching (Query Results/Datapoints Summary)
        let componentQueryResultsTabsInitialized = false;
        function initializeComponentQueryResultsTabs() {
            if (componentQueryResultsTabsInitialized) return;
            componentQueryResultsTabsInitialized = true;
            
            const componentQueryResultsTabs = document.querySelectorAll('.test-query-results-tab');
            const componentQueryResultsTabContents = document.querySelectorAll('.test-query-results-tab-content');
            
            componentQueryResultsTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetResultsTab = tab.getAttribute('data-test-query-results-tab');
                    
                    // Reset all query results tabs to inactive state
                    componentQueryResultsTabs.forEach(t => {
                        t.classList.remove('border-red-500', 'text-white');
                        t.classList.add('border-transparent', 'text-gray-400');
                    });
                    
                    // Set the clicked tab to active state
                    tab.classList.add('border-red-500', 'text-white');
                    tab.classList.remove('border-transparent', 'text-gray-400');
                    
                    // Hide all query results tab content
                    componentQueryResultsTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target query results tab content
                    const targetContent = document.getElementById(targetResultsTab + '-content');
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Component API Request Tab Switching (Parameters, Authentication, Headers, Body, Scripts)
        let componentApiRequestTabsInitialized = false;
        function initializeComponentApiRequestTabs() {
            if (componentApiRequestTabsInitialized) return;
            componentApiRequestTabsInitialized = true;
            
            const componentApiRequestTabs = document.querySelectorAll('.create-test-request-tab');
            const componentApiRequestTabContents = document.querySelectorAll('.create-test-request-tab-content');
            
            // Show the first tab content by default
            if (componentApiRequestTabContents.length > 0) {
                componentApiRequestTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                componentApiRequestTabContents[0].classList.remove('hidden');
            }
            
            // Set the first tab as active by default
            if (componentApiRequestTabs.length > 0) {
                componentApiRequestTabs.forEach(t => {
                    t.classList.remove('border-red-500', 'text-white');
                    t.classList.add('border-transparent', 'text-gray-400');
                });
                componentApiRequestTabs[0].classList.remove('border-transparent', 'text-gray-400');
                componentApiRequestTabs[0].classList.add('border-red-500', 'text-white');
            }
            
            componentApiRequestTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetApiRequestTab = tab.getAttribute('data-create-test-request-tab');
                    
                    // Reset all API request tabs to inactive state
                    componentApiRequestTabs.forEach(t => {
                        t.classList.remove('border-red-500', 'text-white');
                        t.classList.add('border-transparent', 'text-gray-400');
                    });
                    
                    // Set clicked tab to active state
                    tab.classList.remove('border-transparent', 'text-gray-400');
                    tab.classList.add('border-red-500', 'text-white');
                    
                    // Hide all API request tab contents
                    componentApiRequestTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target API request tab content
                    const targetContent = document.querySelector(`.create-test-request-tab-content[data-create-test-request-tab="${targetApiRequestTab}"]`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Component API Script Inner Tab Switching (Pre-Request, Post-Request)
        let componentApiScriptInnerTabsInitialized = false;
        function initializeComponentApiScriptInnerTabs() {
            if (componentApiScriptInnerTabsInitialized) return;
            componentApiScriptInnerTabsInitialized = true;
            
            const componentApiScriptInnerTabs = document.querySelectorAll('.test-script-inner-tab');
            const componentApiScriptInnerTabContents = document.querySelectorAll('.test-script-inner-tab-content');
            
            // Show the first inner tab content by default
            if (componentApiScriptInnerTabContents.length > 0) {
                componentApiScriptInnerTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                componentApiScriptInnerTabContents[0].classList.remove('hidden');
            }
            
            // Set the first inner tab as active by default
            if (componentApiScriptInnerTabs.length > 0) {
                componentApiScriptInnerTabs.forEach(t => {
                    t.classList.remove('bg-blue-600', 'text-white');
                    t.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                });
                componentApiScriptInnerTabs[0].classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                componentApiScriptInnerTabs[0].classList.add('bg-blue-600', 'text-white');
            }
            
            componentApiScriptInnerTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetApiScriptInnerTab = tab.getAttribute('data-test-script-inner-tab');
                    
                    // Reset all API script inner tabs to inactive state
                    componentApiScriptInnerTabs.forEach(t => {
                        t.classList.remove('bg-blue-600', 'text-white');
                        t.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    });
                    
                    // Set clicked tab to active state
                    tab.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    tab.classList.add('bg-blue-600', 'text-white');
                    
                    // Hide all API script inner tab contents
                    componentApiScriptInnerTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target API script inner tab content
                    const targetContent = document.getElementById(`test-script-${targetApiScriptInnerTab}-content`);
                    if (targetContent) {
                        targetContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Data Source Tab Request Tab Switching (Parameters, Authentication, Headers, Body, Scripts)
        let dataSourceRequestTabsInitialized = false;
        function initializeDataSourceRequestTabs() {
            if (dataSourceRequestTabsInitialized) return;
            dataSourceRequestTabsInitialized = true;
            
            const dataSourceRequestTabs = document.querySelectorAll('#data-source-tab .test-request-tab');
            const dataSourceRequestTabContents = document.querySelectorAll('#data-source-tab .test-request-tab-content');
            
            // Show the first tab content by default
            if (dataSourceRequestTabContents.length > 0) {
                dataSourceRequestTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                dataSourceRequestTabContents[0].classList.remove('hidden');
            }
            
            // Set the first tab as active by default
            if (dataSourceRequestTabs.length > 0) {
                dataSourceRequestTabs.forEach(t => {
                    t.classList.remove('border-red-500', 'text-white');
                    t.classList.add('border-transparent', 'text-gray-400');
                });
                dataSourceRequestTabs[0].classList.add('border-red-500', 'text-white');
                dataSourceRequestTabs[0].classList.remove('border-transparent', 'text-gray-400');
            }
            
            dataSourceRequestTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetTab = tab.getAttribute('data-test-request-tab');
                    
                    // Reset all tabs to inactive state
                    dataSourceRequestTabs.forEach(t => {
                        t.classList.remove('border-red-500', 'text-white');
                        t.classList.add('border-transparent', 'text-gray-400');
                    });
                    
                    // Set clicked tab as active
                    tab.classList.add('border-red-500', 'text-white');
                    tab.classList.remove('border-transparent', 'text-gray-400');
                    
                    // Hide all tab contents
                    dataSourceRequestTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target tab content
                    const targetTabContent = document.querySelector(`#data-source-tab .test-request-tab-content[data-test-request-tab="${targetTab}"]`);
                    if (targetTabContent) {
                        targetTabContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Data Source Tab Script Inner Tab Switching (Pre-Request, Post-Request)
        let dataSourceScriptInnerTabsInitialized = false;
        function initializeDataSourceScriptInnerTabs() {
            if (dataSourceScriptInnerTabsInitialized) return;
            dataSourceScriptInnerTabsInitialized = true;
            
            const dataSourceScriptInnerTabs = document.querySelectorAll('#data-source-tab .request-script-inner-tab');
            const dataSourceScriptInnerTabContents = document.querySelectorAll('#data-source-tab .request-script-inner-tab-content');
            
            // Show the first inner tab content by default
            if (dataSourceScriptInnerTabContents.length > 0) {
                dataSourceScriptInnerTabContents.forEach(content => {
                    content.classList.add('hidden');
                });
                dataSourceScriptInnerTabContents[0].classList.remove('hidden');
            }
            
            // Set the first inner tab as active by default
            if (dataSourceScriptInnerTabs.length > 0) {
                dataSourceScriptInnerTabs.forEach(t => {
                    t.classList.remove('bg-blue-600', 'text-white');
                    t.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                });
                dataSourceScriptInnerTabs[0].classList.add('bg-blue-600', 'text-white');
                dataSourceScriptInnerTabs[0].classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
            }
            
            dataSourceScriptInnerTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const targetInnerTab = tab.getAttribute('data-request-script-inner-tab');
                    
                    // Reset all inner tabs to inactive state
                    dataSourceScriptInnerTabs.forEach(t => {
                        t.classList.remove('bg-blue-600', 'text-white');
                        t.classList.add('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    });
                    
                    // Set clicked inner tab as active
                    tab.classList.add('bg-blue-600', 'text-white');
                    tab.classList.remove('bg-gray-700', 'text-gray-300', 'hover:bg-gray-600');
                    
                    // Hide all inner tab contents
                    dataSourceScriptInnerTabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    
                    // Show target inner tab content
                    const targetInnerTabContent = document.querySelector(`#data-source-tab .request-script-inner-tab-content[data-request-script-inner-tab="${targetInnerTab}"]`);
                    if (targetInnerTabContent) {
                        targetInnerTabContent.classList.remove('hidden');
                    }
                });
            });
        }

        // Component API Drag and Drop Functionality
        function initializeComponentApiDragAndDrop(containerSelector) {
            const container = document.querySelector(containerSelector);
            if (!container) return;
            
            const rows = container.querySelectorAll('.draggable-row');
            
            rows.forEach(row => {
                // Check if drag handle already exists
                if (row.querySelector('.drag-handle')) {
                    return; // Skip this row if it already has a drag handle
                }
                
                // Add drag handle
                const dragHandle = document.createElement('div');
                dragHandle.className = 'drag-handle w-6 h-8 flex items-center';
                dragHandle.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">drag_indicator</span>';
                
                // Insert drag handle as the first element inside the draggable-row div
                row.insertBefore(dragHandle, row.firstElementChild);
                
                // Make row draggable
                row.draggable = true;
                
                // Drag start
                row.addEventListener('dragstart', (e) => {
                    row.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/html', row.outerHTML);
                    e.dataTransfer.setData('text/plain', row.dataset.index || '');
                });
                
                // Drag end
                row.addEventListener('dragend', (e) => {
                    row.classList.remove('dragging');
                    // Remove all drag-over classes
                    container.querySelectorAll('.drop-zone').forEach(zone => {
                        zone.classList.remove('drag-over');
                    });
                });
                
                // Drag over
                row.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    
                    // Don't allow dropping on the last empty row
                    if (row.classList.contains('non-draggable')) {
                        return;
                    }
                    
                    row.classList.add('drag-over');
                });
                
                // Drag leave
                row.addEventListener('dragleave', (e) => {
                    row.classList.remove('drag-over');
                });
                
                // Drop
                row.addEventListener('drop', (e) => {
                    e.preventDefault();
                    row.classList.remove('drag-over');
                    
                    // Don't allow dropping on the last empty row
                    if (row.classList.contains('non-draggable')) {
                        return;
                    }
                    
                    const draggedRow = container.querySelector('.dragging');
                    if (draggedRow && draggedRow !== row) {
                        // Get the current index of the dragged row and target row
                        const draggedIndex = parseInt(draggedRow.dataset.index);
                        const targetIndex = parseInt(row.dataset.index);
                        
                        // Remove the dragged row from its current position
                        draggedRow.remove();
                        
                        // Insert the dragged row at the correct position
                        if (draggedIndex < targetIndex) {
                            // Dragging down: insert after the target row
                            row.parentNode.insertBefore(draggedRow, row.nextSibling);
                        } else {
                            // Dragging up: insert before the target row
                            row.parentNode.insertBefore(draggedRow, row);
                        }
                        
                        // Update indices for all rows
                        const allRows = container.querySelectorAll('.draggable-row');
                        allRows.forEach((r, index) => {
                            r.dataset.index = index;
                        });
                    }
                });
            });
        }

        // Global validation function
        function validateStep2() {
            // Get the current data source configuration based on selected type
            
            if (!selectedDataSourceType) {
                // No data source type selected
                const nextStepBtn = document.getElementById('next-step-btn');
                if (nextStepBtn) {
                    nextStepBtn.disabled = true;
                    nextStepBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                return;
            }

            let isStep2Valid = false;

            if (selectedDataSourceType === 'database') {
                // For database, check if a database is selected
                isStep2Valid = selectedDatabase !== null && selectedDatabase !== '';
            } else if (selectedDataSourceType === 'api') {
                // For API, check if an API is selected
                isStep2Valid = selectedApi !== null && selectedApi !== '';
            } else if (selectedDataSourceType === 'file') {
                // For file upload, we'll consider it valid if a file is selected
                // Since this is a drag & drop area, we'll set it as valid by default
                // In a real implementation, you'd check if a file is actually uploaded
                isStep2Valid = true;
            } else if (selectedDataSourceType === 'ai-model') {
                // For AI model, check if a model is selected
                isStep2Valid = selectedAiModel !== null && selectedAiModel !== '';
            }
            
            // Update Next button state only if we're on step 2
            const nextStepBtn = document.getElementById('next-step-btn');
            if (nextStepBtn) {
                nextStepBtn.disabled = !isStep2Valid;
                nextStepBtn.classList.toggle('opacity-50', !isStep2Valid);
                nextStepBtn.classList.toggle('cursor-not-allowed', !isStep2Valid);
            }
        }

        function validateStep3() {
            // Get the current visualization configuration based on selected type
            
            if (!selectedVisualizationType) {
                // No visualization type selected
                const nextStepBtn = document.getElementById('next-step-btn');
                if (nextStepBtn) {
                    nextStepBtn.disabled = true;
                    nextStepBtn.classList.add('opacity-50', 'cursor-not-allowed');
                }
                return;
            }

            let isStep3Valid = false;

            if (selectedVisualizationType === 'chart') {
                // For chart, check if a subtype is selected
                isStep3Valid = selectedChartSubtype !== null && selectedChartSubtype !== '';
            } else if (selectedVisualizationType === 'map-layer') {
                // For map layer, check if a subtype is selected
                isStep3Valid = selectedMapLayerSubtype !== null && selectedMapLayerSubtype !== '';
            } else if (selectedVisualizationType === 'kpi') {
                // For KPI, no subtype needed, so it's valid if the type is selected
                isStep3Valid = true;
            }
            
            // Also check if data mapping is complete
            if (isStep3Valid) {
                isStep3Valid = validateStep3DataMapping();
            }
            
            // Update Next button state only if we're on step 3
            const nextStepBtn = document.getElementById('next-step-btn');
            if (nextStepBtn) {
                nextStepBtn.disabled = !isStep3Valid;
                nextStepBtn.classList.toggle('opacity-50', !isStep3Valid);
                nextStepBtn.classList.toggle('cursor-not-allowed', !isStep3Valid);
            }
            
            // Update mapping validation icons
            updateMappingValidationIcons();
        }

        // Global validation functions
        function validateStep1Fields() {
            const componentName = document.getElementById('component-name');
            const componentDescription = document.getElementById('component-description');
            const componentCategory = document.getElementById('component-category');
            
            if (componentName && componentDescription && componentCategory) {
                const isNameValid = componentName.value.trim() !== '';
                const isDescriptionValid = componentDescription.value.trim() !== '';
                const isCategoryValid = componentCategory.value !== '';
                
                return isNameValid && isDescriptionValid && isCategoryValid;
            }
            return false;
        }

        function validateStep2Fields() {
            // Check if a data source type is selected
            
            if (!selectedDataSourceType) {
                return false;
            }

            // Validate based on selected type
            if (selectedDataSourceType === 'database') {
                return selectedDatabase !== null;
            } else if (selectedDataSourceType === 'api') {
                return selectedApi !== null;
            } else if (selectedDataSourceType === 'file-upload') {
                // For file upload, we'll consider it valid if a file is selected
                // Since this is a drag & drop area, we'll set it as valid by default
                return true;
            } else if (selectedDataSourceType === 'ai-model') {
                // For AI model, check if a model is selected
                const isValid = selectedAiModel !== null && selectedAiModel !== '';
                return isValid;
            }
            
            return false;
        }

        function validateStep3Fields() {
            // Check if a visualization type is selected
            if (!selectedVisualizationType) {
                return false;
            }

            // Validate based on selected type
            if (selectedVisualizationType === 'chart') {
                return selectedChartSubtype !== null && selectedChartSubtype !== '';
            } else if (selectedVisualizationType === 'map-layer') {
                return selectedMapLayerSubtype !== null && selectedMapLayerSubtype !== '';
            } else if (selectedVisualizationType === 'kpi') {
                // KPI doesn't need a subtype, so it's valid if the type is selected
                return true;
            }
            
            return false;
        }

        function validateStep3DataMapping() {
            // Check if data mapping fields are selected based on visualization type
            if (selectedVisualizationType === 'chart') {
                if (selectedChartSubtype === 'horizontal-bar') {
                    return selectedYAxisField !== null && selectedYAxisField !== '' && 
                           selectedSeriesFields.length > 0;
                } else if (selectedChartSubtype === 'vertical-bar') {
                    return selectedXAxisField !== null && selectedXAxisField !== '' && 
                           selectedSeriesFields.length > 0;
                } else if (selectedChartSubtype === 'line' || selectedChartSubtype === 'area' || selectedChartSubtype === 'scatter-plot') {
                    return selectedXAxisField !== null && selectedXAxisField !== '' && 
                           selectedSeriesFields.length > 0;
                } else if (selectedChartSubtype === 'donut' || selectedChartSubtype === 'radial') {
                    return selectedLabelField !== null && selectedLabelField !== '' && 
                           selectedValueField !== null && selectedValueField !== '';
                }
            } else if (selectedVisualizationType === 'map-layer') {
                return selectedXAxisField !== null && selectedXAxisField !== '' && 
                       selectedYAxisField !== null && selectedYAxisField !== '';
            } else if (selectedVisualizationType === 'kpi') {
                return selectedKpiField !== null && selectedKpiField !== '';
            }
            return false;
        }

        // Custom tooltip functionality
        let validationTooltipElement = null;
        let validationTooltipTimeout = null;

        function showValidationTooltip(button, text) {
            hideValidationTooltip();

            if (!text) return;

            validationTooltipElement = document.createElement('div');
            validationTooltipElement.className = 'validation-tooltip';
            validationTooltipElement.textContent = text;
            document.body.appendChild(validationTooltipElement);

            const rect = button.getBoundingClientRect();
            const scrollX = window.scrollX || window.pageXOffset;
            const scrollY = window.scrollY || window.pageYOffset;

            // Position tooltip above the button, centered
            const tooltipX = rect.left + scrollX + (rect.width / 2) - (validationTooltipElement.offsetWidth / 2);
            const tooltipY = rect.top + scrollY - validationTooltipElement.offsetHeight - 8;

            validationTooltipElement.style.left = tooltipX + 'px';
            validationTooltipElement.style.top = tooltipY + 'px';

            // Show tooltip with animation
            setTimeout(() => {
                if (validationTooltipElement) {
                    validationTooltipElement.classList.add('show');
                }
            }, 10);
        }

        function hideValidationTooltip() {
            if (validationTooltipElement) {
                validationTooltipElement.classList.remove('show');
                setTimeout(() => {
                    if (validationTooltipElement) {
                        validationTooltipElement.remove();
                        validationTooltipElement = null;
                    }
                }, 200);
            }
        }

        function setupValidationTooltips() {
            // Add tooltip event listeners to validation icons
            const validationIcons = document.querySelectorAll('[id*="validation-icon"]');
            
            validationIcons.forEach(icon => {
                // Remove existing listeners
                icon.removeEventListener('mouseenter', icon._tooltipMouseEnter);
                icon.removeEventListener('mouseleave', icon._tooltipMouseLeave);
                
                // Create new event handlers
                icon._tooltipMouseEnter = function() {
                    if (validationTooltipTimeout) {
                        clearTimeout(validationTooltipTimeout);
                    }
                    
                    validationTooltipTimeout = setTimeout(() => {
                        const tooltipText = this.getAttribute('data-tooltip');
                        if (tooltipText) {
                            showValidationTooltip(this, tooltipText);
                        }
                    }, 500); // 500ms delay
                };
                
                icon._tooltipMouseLeave = function() {
                    if (validationTooltipTimeout) {
                        clearTimeout(validationTooltipTimeout);
                        validationTooltipTimeout = null;
                    }
                    hideValidationTooltip();
                };
                
                // Add event listeners
                icon.addEventListener('mouseenter', icon._tooltipMouseEnter);
                icon.addEventListener('mouseleave', icon._tooltipMouseLeave);
            });
        }

        function updateMappingValidationIcons() {
            // Update Create Component modal icons
            const createHorizontalYAxisIcon = document.getElementById('create-horizontal-y-axis-validation-icon');
            const createHorizontalSeriesIcon = document.getElementById('create-horizontal-series-validation-icon');
            const createVerticalXAxisIcon = document.getElementById('create-vertical-x-axis-validation-icon');
            const createVerticalSeriesIcon = document.getElementById('create-vertical-series-validation-icon');
            const createLineXAxisIcon = document.getElementById('create-line-x-axis-validation-icon');
            const createLineSeriesIcon = document.getElementById('create-line-series-validation-icon');
            
            // Function to update a single icon
            function updateIcon(icon, isValid, isRequired) {
                if (!icon) return;
                
                if (!isRequired) {
                    // No validation needed for this chart type
                    icon.textContent = '';
                    icon.className = 'material-symbols-outlined text-[20px]';
                    icon.removeAttribute('data-tooltip');
                } else if (isValid) {
                    icon.textContent = 'check_circle';
                    icon.className = 'material-symbols-outlined text-[20px] text-green-400';
                    icon.setAttribute('data-tooltip', 'All required fields are filled');
                } else {
                    icon.textContent = 'error';
                    icon.className = 'material-symbols-outlined text-[20px] text-red-400';
                    icon.setAttribute('data-tooltip', 'There are required fields that are empty');
                }
            }
            
            // Only show validation for charts
            if (selectedVisualizationType !== 'chart') {
                updateIcon(createHorizontalYAxisIcon, false, false);
                updateIcon(createHorizontalSeriesIcon, false, false);
                updateIcon(createVerticalXAxisIcon, false, false);
                updateIcon(createVerticalSeriesIcon, false, false);
                updateIcon(createLineXAxisIcon, false, false);
                updateIcon(createLineSeriesIcon, false, false);
                return;
            }
            
            // Check Y-Axis validation (for horizontal bar charts)
            if (selectedChartSubtype === 'horizontal-bar') {
                const yAxisValid = selectedYAxisField && selectedYAxisField !== '';
                updateIcon(createHorizontalYAxisIcon, yAxisValid, true);
                updateIcon(createVerticalXAxisIcon, false, false); // No X-Axis for horizontal bar
                updateIcon(createLineXAxisIcon, false, false); // No X-Axis for horizontal bar
            }
            
            // Check X-Axis validation (for vertical bar, line, area, scatter-plot charts)
            if (selectedChartSubtype === 'vertical-bar') {
                const xAxisValid = selectedXAxisField && selectedXAxisField !== '';
                updateIcon(createHorizontalYAxisIcon, false, false); // No Y-Axis for vertical bar
                updateIcon(createVerticalXAxisIcon, xAxisValid, true); // Create Component modal has separate X-Axis icon
                updateIcon(createLineXAxisIcon, false, false); // Not line chart
            } else if (selectedChartSubtype === 'line' || selectedChartSubtype === 'area' || selectedChartSubtype === 'scatter-plot') {
                const xAxisValid = selectedXAxisField && selectedXAxisField !== '';
                updateIcon(createHorizontalYAxisIcon, false, false); // No Y-Axis for these charts
                updateIcon(createVerticalXAxisIcon, false, false); // Not vertical bar
                updateIcon(createLineXAxisIcon, xAxisValid, true); // Create Component modal has separate X-Axis icon
            }
            
            // Check Series validation (for all chart types except donut/radial)
            if (selectedChartSubtype !== 'donut' && selectedChartSubtype !== 'radial') {
                const seriesValid = selectedSeriesFields.length > 0;
                
                // Update the appropriate series icon based on chart type
                if (selectedChartSubtype === 'horizontal-bar') {
                    updateIcon(createHorizontalSeriesIcon, seriesValid, true);
                } else if (selectedChartSubtype === 'vertical-bar') {
                    updateIcon(createVerticalSeriesIcon, seriesValid, true);
                } else if (selectedChartSubtype === 'line' || selectedChartSubtype === 'area' || selectedChartSubtype === 'scatter-plot') {
                    updateIcon(createLineSeriesIcon, seriesValid, true);
                }
            } else {
                // Donut/radial charts don't need series validation
                updateIcon(createHorizontalSeriesIcon, false, false);
                updateIcon(createVerticalSeriesIcon, false, false);
                updateIcon(createLineSeriesIcon, false, false);
            }
            
            // Setup tooltips for validation icons
            setupValidationTooltips();
        }

        function validateStep4Fields() {
            // Step 4 validation - Filters
            // If no filters are added, it's valid (optional)
            if (selectedFilterFields.length === 0) {
                return true;
            }
            
            // If filters are added, check that all have mappings
            // Only check filter items in the Create Component modal (step 4)
            const filterListContainer = document.getElementById('filter-field-list');
            if (!filterListContainer) {
                return true; // No filter container found, consider valid
            }
            
            const filterItems = filterListContainer.querySelectorAll('.filter-item');
            
            for (let i = 0; i < filterItems.length; i++) {
                const item = filterItems[i];
                const mappedField = item.getAttribute('data-mapped-field');
                if (!mappedField || mappedField === '') {
                    return false;
                }
            }
            
            return true;
        }

        function validateStep5Fields() {
            // Step 5 validation - Access (always valid as it's optional)
            return true;
        }

        // Filter Functions
        function updateFilterDropdown(id) {
            const dropdown = document.getElementById(id + '-dropdown');
            if (!dropdown) return;

            // Clear existing options
            dropdown.innerHTML = '';

            const options = JSON.parse(dropdown.dataset.options || '[]');

            options.forEach(option => {
                const optionDiv = document.createElement('div');
                const isSelected = selectedFilterFields.includes(option.id);
                
                if (isSelected) {
                    optionDiv.className = 'px-4 py-3 text-sm text-gray-500 cursor-not-allowed';
                    optionDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="h-8 w-8 rounded-md bg-gray-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-gray-400 text-lg">${option.icon}</span>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-gray-400">${option.name}</div>
                                    <div class="text-xs text-gray-500">${option.namespace}</div>
                                </div>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-700 text-gray-500">${option.type}</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <span class="text-xs text-gray-500">Already added</span>
                            </div>
                        </div>
                    `;
                } else {
                    optionDiv.className = 'px-4 py-3 hover:bg-gray-700 cursor-pointer text-sm text-white transition duration-200';
                    optionDiv.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center space-x-3">
                                <div class="h-8 w-8 rounded-md bg-gray-600 flex items-center justify-center">
                                    <span class="material-symbols-outlined text-white text-lg">${option.icon}</span>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-white">${option.name}</div>
                                    <div class="text-xs text-gray-400">${option.namespace}</div>
                                </div>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-600 text-gray-300">${option.type}</span>
                            </div>
                        </div>
                    `;
                    optionDiv.addEventListener('click', function() {
                        selectedFilterFields.push(option.id);
                        updateFilterList();
                        updateFilterDropdown(id);
                        toggleFilterDropdown(id);
                        validateStep4Fields();
                        updateWizardState();
                    });
                }
                
                dropdown.appendChild(optionDiv);
            });
        }

        function toggleFilterDropdown(id) {
            const dropdown = document.getElementById(id + '-dropdown');
            const button = document.getElementById(id + '-btn');
            
            if (dropdown.classList.contains('hidden')) {
                // Close any other open dropdowns
                document.querySelectorAll('[id$="-dropdown"]').forEach(d => {
                    if (d !== dropdown) {
                        d.classList.add('hidden');
                    }
                });
                
                // Update dropdown options before showing
                updateFilterDropdown(id);
                
                // Show this dropdown
                dropdown.classList.remove('hidden');
            } else {
                // Hide dropdown
                dropdown.classList.add('hidden');
            }
        }

        function updateFilterList() {
            const listContainer = document.getElementById('filter-field-list');
            const removeAllBtn = document.getElementById('filter-field-remove-all');
            if (!listContainer) return;

            // Store current mapping values before clearing - use field ID as key
            const currentMappings = {};
            const existingItems = listContainer.querySelectorAll('.filter-item');
            existingItems.forEach((item) => {
                const fieldId = item.getAttribute('data-field-id');
                const mappedField = item.getAttribute('data-mapped-field');
                if (fieldId && mappedField && mappedField !== '') {
                    currentMappings[fieldId] = mappedField;
                }
            });

            // Clear existing list
            listContainer.innerHTML = '';

            if (selectedFilterFields.length === 0) {
                // Hide Remove All button
                if (removeAllBtn) {
                    removeAllBtn.classList.add('hidden');
                }
                return;
            }

            // Show Remove All button
            if (removeAllBtn) {
                removeAllBtn.classList.remove('hidden');
            }

            // Create list items
            selectedFilterFields.forEach((field, index) => {
                const listItem = createFilterListItem(field, index);
                
                // Restore mapping value if it exists
                if (currentMappings[field]) {
                    const selectElement = listItem.querySelector('select');
                    if (selectElement) {
                        selectElement.value = currentMappings[field];
                        listItem.setAttribute('data-mapped-field', currentMappings[field]);
                    }
                }
                
                listContainer.appendChild(listItem);
            });

            // Add drag and drop functionality
            makeFilterListSortable(listContainer);
        }

        function createFilterListItem(field, index) {
            // Map filter IDs to their metadata
            const filterMetadata = {
                'date_range_filter': {
                    name: 'Date Range Filter',
                    type: 'DateRange',
                    icon: 'date_range',
                    namespace: 'date_range_filter'
                },
                'location_filter': {
                    name: 'Location Filter',
                    type: 'Lookup',
                    icon: 'location_on',
                    namespace: 'location_filter'
                },
                'category_filter': {
                    name: 'Category Filter',
                    type: 'Dropdown',
                    icon: 'category',
                    namespace: 'category_filter'
                },
                'range_slider_filter': {
                    name: 'Range Slider Filter',
                    type: 'Slider',
                    icon: 'tune',
                    namespace: 'range_slider_filter'
                },
                'user_filter': {
                    name: 'User Filter',
                    type: 'Text',
                    icon: 'person',
                    namespace: 'user_filter'
                }
            };

            const metadata = filterMetadata[field] || { name: field, type: 'Unknown', icon: 'filter_list', namespace: field };

            const itemDiv = document.createElement('div');
            itemDiv.className = 'filter-item flex items-center justify-between bg-gray-800 border border-gray-600 rounded-md px-3 py-2 cursor-move hover:bg-gray-700 transition duration-200';
            itemDiv.setAttribute('data-index', index);
            itemDiv.setAttribute('data-field-id', field);
            itemDiv.setAttribute('draggable', 'true');
            itemDiv.setAttribute('data-mapped-field', '');
            
            const gripIcon = document.createElement('span');
            gripIcon.className = 'material-symbols-outlined text-gray-400 text-sm mr-2 cursor-move';
            gripIcon.textContent = 'drag_indicator';
            
            const filterInfo = document.createElement('div');
            filterInfo.className = 'flex items-center space-x-3 flex-1';
            filterInfo.innerHTML = `
                <div class="h-8 w-8 rounded-md bg-gray-600 flex items-center justify-center">
                    <span class="material-symbols-outlined text-white text-lg">${metadata.icon}</span>
                </div>
                <div class="flex-1">
                    <div class="flex items-center">
                        <div class="mr-3">
                            <div class="text-sm font-medium text-white">${metadata.name}</div>
                            <div class="text-xs text-gray-400">${metadata.namespace}</div>
                        </div>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-600 text-gray-300">${metadata.type}</span>
                    </div>
                </div>
            `;
            
            // Add data field mapping dropdown
            const mappingContainer = document.createElement('div');
            mappingContainer.className = 'flex items-center space-x-2 ml-4 relative';
            
            const mappingLabel = document.createElement('label');
            mappingLabel.className = 'text-xs text-gray-400 whitespace-nowrap';
            mappingLabel.innerHTML = 'Map to: <span class="text-red-400">*</span>';
            
            const mappingSelect = document.createElement('select');
            mappingSelect.className = 'bg-gray-800 border border-gray-600 rounded-md px-2 py-1 pr-8 text-xs text-white focus:outline-none focus:ring-1 focus:ring-red-500 appearance-none';
            mappingSelect.style.minWidth = '120px';
            
            // Add options to the dropdown
            const dataFields = [
                { value: '', label: 'Select field' },
                { value: 'date', label: 'Date' },
                { value: 'time', label: 'Time' },
                { value: 'timestamp', label: 'Timestamp' },
                { value: 'category', label: 'Category' },
                { value: 'region', label: 'Region' },
                { value: 'grid_id', label: 'Grid ID' },
                { value: 'longitude', label: 'Longitude' },
                { value: 'latitude', label: 'Latitude' },
                { value: 'population_count', label: 'Population Count' },
                { value: 'area_size_km2', label: 'Area Size (km)' },
                { value: 'population_density', label: 'Population Density' },
                { value: 'sales', label: 'Sales' },
                { value: 'revenue', label: 'Revenue' },
                { value: 'quantity', label: 'Quantity' },
                { value: 'end_longitude', label: 'End Longitude' },
                { value: 'end_latitude', label: 'End Latitude' },
                { value: 'distance', label: 'Distance' }
            ];
            
            dataFields.forEach(field => {
                const option = document.createElement('option');
                option.value = field.value;
                option.textContent = field.label;
                mappingSelect.appendChild(option);
            });
            
            // Add change event listener to store the mapping
            mappingSelect.addEventListener('change', function() {
                itemDiv.setAttribute('data-mapped-field', this.value);
                validateStep4Fields();
                updateWizardState();
            });
            
            mappingContainer.appendChild(mappingLabel);
            mappingContainer.appendChild(mappingSelect);
            
            // Add chevron icon container
            const chevronContainer = document.createElement('div');
            chevronContainer.className = 'absolute inset-y-0 right-0 flex items-center pr-1 pointer-events-none';
            chevronContainer.innerHTML = '<span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>';
            

            
            // Add the chevron to the mapping container
            mappingContainer.appendChild(chevronContainer);
            
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-red-400 hover:text-red-300 transition duration-200 ml-3';
            removeBtn.innerHTML = '<span class="material-symbols-outlined text-sm">close</span>';
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                selectedFilterFields.splice(index, 1);
                updateFilterList();
                validateStep4Fields();
                updateWizardState();
            });
            
            itemDiv.appendChild(gripIcon);
            itemDiv.appendChild(filterInfo);
            itemDiv.appendChild(mappingContainer);
            itemDiv.appendChild(removeBtn);
            
            return itemDiv;
        }

        function makeFilterListSortable(container) {
            let draggedItem = null;
            let draggedIndex = null;

            container.addEventListener('dragstart', function(e) {
                draggedItem = e.target;
                draggedIndex = parseInt(e.target.getAttribute('data-index'));
                e.target.style.opacity = '0.5';
            });

            container.addEventListener('dragend', function(e) {
                e.target.style.opacity = '';
                draggedItem = null;
                draggedIndex = null;
            });

            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                const afterElement = getDragAfterElement(container, e.clientY);
                if (afterElement == null) {
                    container.appendChild(draggedItem);
                } else {
                    container.insertBefore(draggedItem, afterElement);
                }
            });

            container.addEventListener('drop', function(e) {
                e.preventDefault();
                const dropIndex = parseInt(e.target.closest('.filter-item').getAttribute('data-index'));
                
                if (draggedIndex !== null && dropIndex !== null && draggedIndex !== dropIndex) {
                    const item = selectedFilterFields[draggedIndex];
                    selectedFilterFields.splice(draggedIndex, 1);
                    selectedFilterFields.splice(dropIndex, 0, item);
                    
                    // Update data-index attributes
                    container.querySelectorAll('.filter-item').forEach((item, index) => {
                        item.setAttribute('data-index', index);
                    });
                }
            });
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.filter-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function generateDataMappingFields() {
            const fieldsContainer = document.getElementById('data-mapping-fields');
            if (!fieldsContainer) return;

            // Clear existing fields
            fieldsContainer.innerHTML = '';

            if (selectedVisualizationType === 'chart') {
                generateChartMappingFields(fieldsContainer);
            } else if (selectedVisualizationType === 'map-layer') {
                generateMapLayerMappingFields(fieldsContainer);
            } else if (selectedVisualizationType === 'kpi') {
                generateKpiMappingFields(fieldsContainer);
            }
        }

        function generateChartMappingFields(container) {
            const chartFields = {
                'horizontal-bar': {
                    yAxis: 'Y-Axis',
                    series: 'Series',
                    yOptions: ['category', 'region', 'date', 'grid_id'],
                    seriesOptions: ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue', 'quantity']
                },
                'vertical-bar': {
                    xAxis: 'X-Axis',
                    series: 'Series',
                    xOptions: ['category', 'region', 'date', 'grid_id'],
                    seriesOptions: ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue', 'quantity']
                },
                'line': {
                    xAxis: 'X-Axis',
                    series: 'Series',
                    xOptions: ['date', 'time', 'timestamp', 'category', 'region'],
                    seriesOptions: ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue', 'quantity']
                },
                'area': {
                    xAxis: 'X-Axis',
                    series: 'Series',
                    xOptions: ['date', 'time', 'timestamp', 'category', 'region'],
                    seriesOptions: ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue', 'quantity']
                },
                'scatter-plot': {
                    xAxis: 'X-Axis',
                    series: 'Series',
                    xOptions: ['longitude', 'latitude', 'population_count', 'area_size_km2', 'sales', 'revenue'],
                    seriesOptions: ['latitude', 'longitude', 'population_density', 'quantity', 'sales', 'revenue']
                },
                'donut': {
                    label: 'Label',
                    value: 'Value',
                    labelOptions: ['category', 'region', 'grid_id'],
                    valueOptions: ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue', 'quantity']
                },
                'radial': {
                    label: 'Label',
                    value: 'Value',
                    labelOptions: ['category', 'region', 'grid_id'],
                    valueOptions: ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue', 'quantity']
                }
            };

            const config = chartFields[selectedChartSubtype];
            if (!config) return;

            if (selectedChartSubtype === 'horizontal-bar') {
                // Create tabs structure for Horizontal Bar
                const tabsContainer = document.createElement('div');
                tabsContainer.className = 'flex border border-gray-700 rounded-lg h-full overflow-hidden';
                tabsContainer.style.minHeight = '400px';

                // Visual Property Tabs
                const tabsSidebar = document.createElement('div');
                tabsSidebar.className = 'flex flex-col w-52 p-3 bg-gray-800 border-r border-gray-700';
                
                const tabsList = document.createElement('div');
                tabsList.className = 'flex-1 space-y-2';

                // Y-Axis Tab
                const yAxisTab = document.createElement('div');
                yAxisTab.className = 'create-visual-property-tab flex items-center justify-between py-2 px-3 bg-blue-600 text-white rounded-lg transition duration-200 cursor-pointer';
                yAxisTab.setAttribute('data-visual-tab', 'y-axis');
                yAxisTab.innerHTML = `
                    <span class="text-sm font-medium">Y-Axis</span>
                    <span id="create-horizontal-y-axis-validation-icon" class="material-symbols-outlined text-[20px]" title=""></span>
                `;
                tabsList.appendChild(yAxisTab);

                // Series Tab
                const seriesTab = document.createElement('div');
                seriesTab.className = 'create-visual-property-tab flex items-center justify-between py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg cursor-pointer transition duration-200';
                seriesTab.setAttribute('data-visual-tab', 'series');
                seriesTab.innerHTML = `
                    <span class="text-sm font-medium">Series</span>
                    <span id="create-horizontal-series-validation-icon" class="material-symbols-outlined text-[20px]" title=""></span>
                `;
                tabsList.appendChild(seriesTab);

                // Legend Tab
                const legendTab = document.createElement('div');
                legendTab.className = 'create-visual-property-tab flex items-center py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg cursor-pointer transition duration-200';
                legendTab.setAttribute('data-visual-tab', 'legend');
                legendTab.innerHTML = `
                    <span class="text-sm font-medium">Legend</span>
                `;
                tabsList.appendChild(legendTab);

                tabsSidebar.appendChild(tabsList);
                tabsContainer.appendChild(tabsSidebar);

                // Tab Content Container
                const tabContentContainer = document.createElement('div');
                tabContentContainer.className = 'flex-1 p-4 overflow-auto';

                // Y-Axis Tab Content
                const yAxisContent = document.createElement('div');
                yAxisContent.id = 'y-axis-tab-content';
                yAxisContent.className = 'component-visual-tab-content space-y-6';
                yAxisContent.innerHTML = `
                    <div>
                        <label class="text-sm text-gray-500 block mb-2">Data Field <span class="text-red-400">*</span></label>
                        <div>
                            <div class="relative">
                                <select id="y-axis-data-field-select" class="w-full bg-gray-800 border border-gray-700 hover:bg-gray-700 transition duration-200 rounded-md px-3 py-2 text-sm text-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none" onchange="selectYAxisDataField(this.value)">
                                    <option value="">Select data field</option>
                                    ${config.yOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-700"></div>

                    <div class="space-y-4">
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Axis Order</label>
                        <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                    <span class="text-sm text-gray-300">Reverse Order</span>
                                </div>
                        </div>
                    </div>
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Gridlines</label>
                        <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                    <span class="text-sm text-gray-300">Major Gridlines</span>
                        </div>
                            </div>
                        </div>

                    </div>
                `;
                tabContentContainer.appendChild(yAxisContent);

                // Series Tab Content
                const seriesContent = document.createElement('div');
                seriesContent.id = 'series-tab-content';
                seriesContent.className = 'component-visual-tab-content hidden space-y-6';
                
                // Create the Add Series field structure
                const seriesFieldDiv = document.createElement('div');
                seriesFieldDiv.className = 'relative';
                
                // Header with label and remove all button
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center justify-between mb-3';
                
                const label = document.createElement('label');
                label.className = 'text-sm font-medium text-gray-300';
                label.textContent = 'Series Fields';
                
                const removeAllBtn = document.createElement('button');
                removeAllBtn.type = 'button';
                removeAllBtn.id = 'series-field-remove-all';
                removeAllBtn.className = 'text-red-400 hover:text-red-300 text-xs font-medium transition duration-200 hidden';
                removeAllBtn.textContent = 'Remove All';
                removeAllBtn.addEventListener('click', function() {
                    selectedSeriesFields = [];
                    updateSeriesList();
                    validateStep3();
                    updateWizardState();
                });
                
                headerDiv.appendChild(label);
                headerDiv.appendChild(removeAllBtn);
                seriesFieldDiv.appendChild(headerDiv);
                
                // Series list container
                const listContainer = document.createElement('div');
                listContainer.id = 'series-field-list';
                listContainer.className = 'space-y-2 mb-3';
                seriesFieldDiv.appendChild(listContainer);
                
                // Add Series dropdown button
                const addSeriesBtn = document.createElement('button');
                addSeriesBtn.type = 'button';
                addSeriesBtn.id = 'series-field-btn';
                addSeriesBtn.className = 'bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition duration-200 flex items-center space-x-2 text-sm';
                addSeriesBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">add</span><span>Add Series Field</span>';
                addSeriesBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleSeriesDropdown('series-field');
                });
                
                // Dropdown container
                const dropdownContainer = document.createElement('div');
                dropdownContainer.id = 'series-field-dropdown';
                dropdownContainer.className = 'absolute z-50 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto hidden mt-2';
                dropdownContainer.style.width = '100%';
                dropdownContainer.style.maxWidth = '400px';
                
                // Store options for later use
                dropdownContainer.dataset.options = JSON.stringify(config.seriesOptions);
                
                // Position the dropdown relative to the button
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'relative';
                buttonContainer.appendChild(addSeriesBtn);
                buttonContainer.appendChild(dropdownContainer);
                seriesFieldDiv.appendChild(buttonContainer);
                
                seriesContent.appendChild(seriesFieldDiv);
                
                // Add configuration fields to Series tab
                const configDiv = document.createElement('div');
                configDiv.className = 'space-y-6';
                configDiv.innerHTML = `
                    <div class="border-t border-gray-700"></div>

                    <div class="space-y-4">
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Color Palette</label>
                        <div class="relative">
                            <button id="series-color-palette-btn" class="w-full bg-gray-800 border border-gray-600 hover:bg-gray-700 transition duration-200 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div id="series-color-palette-preview" class="w-8 h-4 rounded bg-gradient-to-r from-teal-400 via-orange-400 to-pink-400"></div>
                                    <span id="series-color-palette-selected">Default</span>
                                </div>
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </button>
                            <div id="series-color-palette-dropdown" class="absolute top-full left-0 mt-2 bg-gray-800 border border-gray-600 rounded-md shadow-lg hidden z-50 min-w-64 w-full">
                                <div class="p-2 space-y-1">
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="default">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-teal-400 via-orange-400 to-pink-400"></div>
                                        <span class="text-sm text-white">Default</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="red">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-red-300 via-red-500 to-red-700"></div>
                                        <span class="text-sm text-white">Red Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="blue">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-blue-300 via-blue-500 to-blue-700"></div>
                                        <span class="text-sm text-white">Blue Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="green">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-green-300 via-green-500 to-green-700"></div>
                                        <span class="text-sm text-white">Green Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="purple">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-purple-300 via-purple-500 to-purple-700"></div>
                                        <span class="text-sm text-white">Purple Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="orange">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-orange-300 via-orange-500 to-orange-700"></div>
                                        <span class="text-sm text-white">Orange Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="teal">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-teal-300 via-teal-500 to-teal-700"></div>
                                        <span class="text-sm text-white">Teal Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="pink">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-pink-300 via-pink-500 to-pink-700"></div>
                                        <span class="text-sm text-white">Pink Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="gray">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-gray-300 via-gray-500 to-gray-700"></div>
                                        <span class="text-sm text-white">Gray Theme</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                        <div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                    <label class="text-sm text-gray-500 block mb-2">Minimum Value</label>
                                <input type="number" id="series-min-value" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="0">
                            </div>
                            <div>
                                    <label class="text-sm text-gray-500 block mb-2">Maximum Value</label>
                                <input type="number" id="series-max-value" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="100">
                            </div>
                        </div>
                    </div>
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Scale Factor</label>
                        <div class="relative">
                            <select id="series-scale-factor" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="1">1x (No scaling)</option>
                                <option value="0.001">0.001x (Thousands)</option>
                                <option value="0.01">0.01x (Hundreds)</option>
                                <option value="0.1">0.1x (Tens)</option>
                                <option value="10">10x</option>
                                <option value="100">100x</option>
                                <option value="1000">1000x</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Number Format</label>
                        <div class="relative">
                            <select id="series-number-format" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="number">Number (1,234.56)</option>
                                <option value="currency">Currency ($1,234.56)</option>
                                <option value="percentage">Percentage (123.46%)</option>
                                <option value="decimal">Decimal (1234.56)</option>
                                <option value="integer">Integer (1235)</option>
                                <option value="scientific">Scientific (1.23e+3)</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                    
                    </div>

                    <div class="space-y-4">
                    
                        <div class="border-t border-gray-700"></div>
                        
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Gridlines & Ticks</label>
                        <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                <span class="text-sm text-gray-300">Major Gridlines</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                <span class="text-sm text-gray-300">Minor Gridlines</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                <span class="text-sm text-gray-300">Major Ticks</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                <span class="text-sm text-gray-300">Minor Ticks</span>
                        </div>
                            </div>
                        </div>

                    </div>
                `;
                seriesContent.appendChild(configDiv);
                tabContentContainer.appendChild(seriesContent);

                // Legend Tab Content
                const legendContent = document.createElement('div');
                legendContent.id = 'legend-tab-content';
                legendContent.className = 'component-visual-tab-content hidden space-y-6';
                legendContent.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-3">
                            <label class="toggle-switch">
                                <input type="checkbox" id="legend-show-legend">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="legend-label-text text-sm text-gray-300 cursor-pointer hover:text-gray-200">Show Legend</span>
                        </div>
                    </div>
                    
                    <div id="legend-position-container" style="display: none;">
                        <label class="text-sm text-gray-500 block mb-2">Legend Position</label>
                        <div class="relative">
                            <select id="legend-position" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="auto">Auto</option>
                                <option value="top">Top</option>
                                <option value="bottom">Bottom</option>
                                <option value="left">Left</option>
                                <option value="right">Right</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                `;
                tabContentContainer.appendChild(legendContent);

                tabsContainer.appendChild(tabContentContainer);
                container.appendChild(tabsContainer);

                // Add event listeners for tab switching
                setTimeout(() => {
                    const tabButtons = tabsContainer.querySelectorAll('.create-visual-property-tab');
                    const tabContents = tabsContainer.querySelectorAll('.component-visual-tab-content');

                    tabButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            const targetTab = button.getAttribute('data-visual-tab');
                            
                            // Update active tab button
                            tabButtons.forEach(btn => {
                                btn.className = btn.className.replace('bg-blue-600 text-white', 'bg-gray-700 hover:bg-gray-600 text-gray-300');
                            });
                            button.className = button.className.replace('bg-gray-700 hover:bg-gray-600 text-gray-300', 'bg-blue-600 text-white');
                            
                            // Show target tab content
                            tabContents.forEach(content => {
                                content.classList.add('hidden');
                            });
                            const targetContent = tabsContainer.querySelector(`#${targetTab}-tab-content`);
                            if (targetContent) {
                                targetContent.classList.remove('hidden');
                            }
                        });
                    });

                    // Initialize the Series list
                    updateSeriesDropdown('series-field');
                    updateSeriesList();

                    // Initialize Color Palette dropdown functionality
                    const colorPaletteBtn = document.getElementById('series-color-palette-btn');
                    const colorPaletteDropdown = document.getElementById('series-color-palette-dropdown');
                    const colorPaletteOptions = document.querySelectorAll('.color-palette-option');

                    if (colorPaletteBtn && colorPaletteDropdown) {
                        colorPaletteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            colorPaletteDropdown.classList.toggle('hidden');
                        });

                        // Handle color palette option selection
                        colorPaletteOptions.forEach(option => {
                            option.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const value = this.getAttribute('data-value');
                                const name = this.querySelector('span').textContent;
                                const preview = this.querySelector('div').cloneNode(true);
                                
                                // Update the button display
                                const selectedSpan = document.getElementById('series-color-palette-selected');
                                const previewDiv = document.getElementById('series-color-palette-preview');
                                
                                if (selectedSpan) selectedSpan.textContent = name;
                                if (previewDiv) {
                                    previewDiv.innerHTML = '';
                                    previewDiv.appendChild(preview);
                                }
                                
                                // Hide dropdown
                                colorPaletteDropdown.classList.add('hidden');
                            });
                        });

                        // Close dropdown when clicking outside
                        document.addEventListener('click', function(e) {
                            if (!colorPaletteBtn.contains(e.target) && !colorPaletteDropdown.contains(e.target)) {
                                colorPaletteDropdown.classList.add('hidden');
                            }
                        });
                    }

                    // Initialize Legend functionality
                    const showLegendToggle = document.getElementById('legend-show-legend');
                    const legendPositionContainer = document.getElementById('legend-position-container');

                    if (showLegendToggle && legendPositionContainer) {
                        // Function to toggle legend state
                        function toggleLegendState() {
                            const isChecked = showLegendToggle.checked;
                            
                            // Show/hide legend position container based on checkbox state
                            if (isChecked) {
                                legendPositionContainer.style.display = 'block';
                            } else {
                                legendPositionContainer.style.display = 'none';
                            }
                        }

                        // Add change event to checkbox
                        showLegendToggle.addEventListener('change', toggleLegendState);

                        // Add click event to the label text
                        const legendLabel = showLegendToggle.closest('.flex').querySelector('.legend-label-text');
                        if (legendLabel) {
                            legendLabel.addEventListener('click', () => {
                                showLegendToggle.checked = !showLegendToggle.checked;
                                toggleLegendState();
                            });
                        }
                        
                        // Initialize the state on page load
                        toggleLegendState();
                    }

                }, 100);

            } else if (selectedChartSubtype === 'vertical-bar') {
                // Create tabs structure for Vertical Bar
                const tabsContainer = document.createElement('div');
                tabsContainer.className = 'flex border border-gray-700 rounded-lg h-full overflow-hidden';
                tabsContainer.style.minHeight = '400px';

                // Visual Property Tabs
                const tabsSidebar = document.createElement('div');
                tabsSidebar.className = 'flex flex-col w-52 p-3 bg-gray-800 border-r border-gray-700';
                
                const tabsList = document.createElement('div');
                tabsList.className = 'flex-1 space-y-2';

                // X-Axis Tab
                const xAxisTab = document.createElement('div');
                xAxisTab.className = 'create-visual-property-tab flex items-center justify-between py-2 px-3 bg-blue-600 text-white rounded-lg transition duration-200 cursor-pointer';
                xAxisTab.setAttribute('data-visual-tab', 'x-axis');
                xAxisTab.innerHTML = `
                    <span class="text-sm font-medium">X-Axis</span>
                    <span id="create-vertical-x-axis-validation-icon" class="material-symbols-outlined text-[20px]" title=""></span>
                `;
                tabsList.appendChild(xAxisTab);

                // Series Tab
                const seriesTab = document.createElement('div');
                seriesTab.className = 'create-visual-property-tab flex items-center justify-between py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg cursor-pointer transition duration-200';
                seriesTab.setAttribute('data-visual-tab', 'series');
                seriesTab.innerHTML = `
                    <span class="text-sm font-medium">Series</span>
                    <span id="create-vertical-series-validation-icon" class="material-symbols-outlined text-[20px]" title=""></span>
                `;
                tabsList.appendChild(seriesTab);

                // Legend Tab
                const legendTab = document.createElement('div');
                legendTab.className = 'create-visual-property-tab flex items-center py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg cursor-pointer transition duration-200';
                legendTab.setAttribute('data-visual-tab', 'legend');
                legendTab.innerHTML = `
                    <span class="text-sm font-medium">Legend</span>
                `;
                tabsList.appendChild(legendTab);

                tabsSidebar.appendChild(tabsList);
                tabsContainer.appendChild(tabsSidebar);

                // Tab Content Container
                const tabContentContainer = document.createElement('div');
                tabContentContainer.className = 'flex-1 p-4 overflow-auto';

                // X-Axis Tab Content
                const xAxisContent = document.createElement('div');
                xAxisContent.id = 'x-axis-tab-content';
                xAxisContent.className = 'component-visual-tab-content space-y-6';
                xAxisContent.innerHTML = `
                    <div>
                        <label class="text-sm text-gray-500 block mb-2">Data Field <span class="text-red-400">*</span></label>
                        <div>
                            <div class="relative">
                                <select id="x-axis-data-field-select" class="w-full bg-gray-800 border border-gray-700 hover:bg-gray-700 transition duration-200 rounded-md px-3 py-2 text-sm text-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none" onchange="selectXAxisDataField(this.value)">
                                    <option value="">Select data field</option>
                                    ${config.xOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-700"></div>

                    <div class="space-y-4">
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Axis Order</label>
                        <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                    <span class="text-sm text-gray-300">Reverse Order</span>
                                </div>
                        </div>
                    </div>
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Gridlines</label>
                        <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                    <span class="text-sm text-gray-300">Major Gridlines</span>
                        </div>
                            </div>
                        </div>

                    </div>
                `;
                tabContentContainer.appendChild(xAxisContent);

                // Series Tab Content
                const seriesContent = document.createElement('div');
                seriesContent.id = 'series-tab-content';
                seriesContent.className = 'component-visual-tab-content hidden space-y-6';
                
                // Create the Add Series field structure
                const seriesFieldDiv = document.createElement('div');
                seriesFieldDiv.className = 'relative';
                
                // Header with label and remove all button
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center justify-between mb-3';
                
                const label = document.createElement('label');
                label.className = 'text-sm font-medium text-gray-300';
                label.textContent = 'Series Fields';
                
                const removeAllBtn = document.createElement('button');
                removeAllBtn.type = 'button';
                removeAllBtn.id = 'series-field-remove-all';
                removeAllBtn.className = 'text-red-400 hover:text-red-300 text-xs font-medium transition duration-200 hidden';
                removeAllBtn.textContent = 'Remove All';
                removeAllBtn.addEventListener('click', function() {
                    selectedSeriesFields = [];
                    updateSeriesList();
                    validateStep3();
                    updateWizardState();
                });
                
                headerDiv.appendChild(label);
                headerDiv.appendChild(removeAllBtn);
                seriesFieldDiv.appendChild(headerDiv);
                
                // Series list container
                const listContainer = document.createElement('div');
                listContainer.id = 'series-field-list';
                listContainer.className = 'space-y-2 mb-3';
                seriesFieldDiv.appendChild(listContainer);
                
                // Add Series dropdown button
                const addSeriesBtn = document.createElement('button');
                addSeriesBtn.type = 'button';
                addSeriesBtn.id = 'series-field-btn';
                addSeriesBtn.className = 'bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition duration-200 flex items-center space-x-2 text-sm';
                addSeriesBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">add</span><span>Add Series Field</span>';
                addSeriesBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleSeriesDropdown('series-field');
                });
                
                // Dropdown container
                const dropdownContainer = document.createElement('div');
                dropdownContainer.id = 'series-field-dropdown';
                dropdownContainer.className = 'absolute z-50 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto hidden mt-2';
                dropdownContainer.style.width = '100%';
                dropdownContainer.style.maxWidth = '400px';
                
                // Store options for later use
                dropdownContainer.dataset.options = JSON.stringify(config.seriesOptions);
                
                // Position the dropdown relative to the button
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'relative';
                buttonContainer.appendChild(addSeriesBtn);
                buttonContainer.appendChild(dropdownContainer);
                seriesFieldDiv.appendChild(buttonContainer);
                
                seriesContent.appendChild(seriesFieldDiv);
                
                // Add configuration fields to Series tab
                const configDiv = document.createElement('div');
                configDiv.className = 'space-y-6';
                configDiv.innerHTML = `
                    <div class="border-t border-gray-700"></div>

                    <div class="space-y-4">
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Color Palette</label>
                        <div class="relative">
                            <button id="series-color-palette-btn" class="w-full bg-gray-800 border border-gray-600 hover:bg-gray-700 transition duration-200 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div id="series-color-palette-preview" class="w-8 h-4 rounded bg-gradient-to-r from-teal-400 via-orange-400 to-pink-400"></div>
                                    <span id="series-color-palette-selected">Default</span>
                                </div>
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </button>
                            <div id="series-color-palette-dropdown" class="absolute top-full left-0 mt-2 bg-gray-800 border border-gray-600 rounded-md shadow-lg hidden z-50 min-w-64 w-full">
                                <div class="p-2 space-y-1">
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="default">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-teal-400 via-orange-400 to-pink-400"></div>
                                        <span class="text-sm text-white">Default</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="red">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-red-300 via-red-500 to-red-700"></div>
                                        <span class="text-sm text-white">Red Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="blue">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-blue-300 via-blue-500 to-blue-700"></div>
                                        <span class="text-sm text-white">Blue Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="green">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-green-300 via-green-500 to-green-700"></div>
                                        <span class="text-sm text-white">Green Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="purple">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-purple-300 via-purple-500 to-purple-700"></div>
                                        <span class="text-sm text-white">Purple Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="orange">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-orange-300 via-orange-500 to-orange-700"></div>
                                        <span class="text-sm text-white">Orange Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="teal">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-teal-300 via-teal-500 to-teal-700"></div>
                                        <span class="text-sm text-white">Teal Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="pink">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-pink-300 via-pink-500 to-pink-700"></div>
                                        <span class="text-sm text-white">Pink Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="gray">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-gray-300 via-gray-500 to-gray-700"></div>
                                        <span class="text-sm text-white">Gray Theme</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                        <div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                    <label class="text-sm text-gray-500 block mb-2">Minimum Value</label>
                                <input type="number" id="series-min-value" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="0">
                            </div>
                            <div>
                                    <label class="text-sm text-gray-500 block mb-2">Maximum Value</label>
                                <input type="number" id="series-max-value" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="100">
                            </div>
                        </div>
                    </div>
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Scale Factor</label>
                        <div class="relative">
                            <select id="series-scale-factor" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="1">1x (No scaling)</option>
                                <option value="0.001">0.001x (Thousands)</option>
                                <option value="0.01">0.01x (Hundreds)</option>
                                <option value="0.1">0.1x (Tens)</option>
                                <option value="10">10x</option>
                                <option value="100">100x</option>
                                <option value="1000">1000x</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Number Format</label>
                        <div class="relative">
                            <select id="series-number-format" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="number">Number (1,234.56)</option>
                                <option value="currency">Currency ($1,234.56)</option>
                                <option value="percentage">Percentage (123.46%)</option>
                                <option value="decimal">Decimal (1234.56)</option>
                                <option value="integer">Integer (1235)</option>
                                <option value="scientific">Scientific (1.23e+3)</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                    
                    </div>
                    
                    <div class="border-t border-gray-700"></div>

                    <div class="space-y-4">
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Gridlines & Ticks</label>
                        <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                                    </label>
                                <span class="text-sm text-gray-300">Major Gridlines</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                <span class="text-sm text-gray-300">Minor Gridlines</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                <span class="text-sm text-gray-300">Major Ticks</span>
                                </div>
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                <span class="text-sm text-gray-300">Minor Ticks</span>
                        </div>
                            </div>
                        </div>

                    </div>
                `;
                seriesContent.appendChild(configDiv);
                tabContentContainer.appendChild(seriesContent);


                // Legend Tab Content
                const legendContent = document.createElement('div');
                legendContent.id = 'legend-tab-content';
                legendContent.className = 'component-visual-tab-content hidden space-y-6';
                legendContent.innerHTML = `
                    <div>
                        <div class="flex items-center space-x-3">
                            <label class="toggle-switch">
                                <input type="checkbox" id="legend-show-legend">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="legend-label-text text-sm text-gray-300 cursor-pointer hover:text-gray-200">Show Legend</span>
                        </div>
                    </div>
                    
                    <div id="legend-position-container" style="display: none;">
                        <label class="text-sm text-gray-500 block mb-2">Legend Position</label>
                        <div class="relative">
                            <select id="legend-position" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="auto">Auto</option>
                                <option value="top">Top</option>
                                <option value="bottom">Bottom</option>
                                <option value="left">Left</option>
                                <option value="right">Right</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                `;
                tabContentContainer.appendChild(legendContent);
                tabsContainer.appendChild(tabContentContainer);
                container.appendChild(tabsContainer);

                // Add event listeners for tab switching
                setTimeout(() => {
                    const tabButtons = tabsContainer.querySelectorAll('.create-visual-property-tab');
                    const tabContents = tabsContainer.querySelectorAll('.component-visual-tab-content');

                    tabButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            const targetTab = button.getAttribute('data-visual-tab');
                            
                            // Update active tab button
                            tabButtons.forEach(btn => {
                                btn.className = btn.className.replace('bg-blue-600 text-white', 'bg-gray-700 hover:bg-gray-600 text-gray-300');
                            });
                            button.className = button.className.replace('bg-gray-700 hover:bg-gray-600 text-gray-300', 'bg-blue-600 text-white');
                            
                            // Show target tab content
                            tabContents.forEach(content => {
                                content.classList.add('hidden');
                            });
                            const targetContent = tabsContainer.querySelector(`#${targetTab}-tab-content`);
                            if (targetContent) {
                                targetContent.classList.remove('hidden');
                            }
                        });
                    });

                    // Initialize the Series list
                    updateSeriesDropdown('series-field');
                    updateSeriesList();

                    // Initialize Color Palette dropdown functionality
                    const colorPaletteBtn = document.getElementById('series-color-palette-btn');
                    const colorPaletteDropdown = document.getElementById('series-color-palette-dropdown');
                    const colorPaletteOptions = document.querySelectorAll('.color-palette-option');

                    if (colorPaletteBtn && colorPaletteDropdown) {
                        colorPaletteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            colorPaletteDropdown.classList.toggle('hidden');
                        });

                        // Handle color palette option selection
                        colorPaletteOptions.forEach(option => {
                            option.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const value = this.getAttribute('data-value');
                                const name = this.querySelector('span').textContent;
                                const preview = this.querySelector('div').cloneNode(true);
                                
                                // Update the button display
                                const selectedSpan = document.getElementById('series-color-palette-selected');
                                const previewDiv = document.getElementById('series-color-palette-preview');
                                
                                if (selectedSpan) selectedSpan.textContent = name;
                                if (previewDiv) {
                                    previewDiv.innerHTML = '';
                                    previewDiv.appendChild(preview);
                                }
                                
                                // Hide dropdown
                                colorPaletteDropdown.classList.add('hidden');
                            });
                        });

                        // Close dropdown when clicking outside
                        document.addEventListener('click', function(e) {
                            if (!colorPaletteBtn.contains(e.target) && !colorPaletteDropdown.contains(e.target)) {
                                colorPaletteDropdown.classList.add('hidden');
                            }
                        });
                    }

                    // Initialize Legend functionality  
                    const showLegendToggle = document.getElementById('legend-show-legend');
                    const legendPositionContainer = document.getElementById('legend-position-container');

                    if (showLegendToggle && legendPositionContainer) {
                        // Function to toggle legend state
                        function toggleLegendState() {
                            const isChecked = showLegendToggle.checked;
                            
                            // Show/hide legend position container based on checkbox state
                            if (isChecked) {
                                legendPositionContainer.style.display = 'block';
                            } else {
                                legendPositionContainer.style.display = 'none';
                            }
                        }

                        // Add change event to checkbox
                        showLegendToggle.addEventListener('change', toggleLegendState);

                        // Add click event to the label text
                        const legendLabel = showLegendToggle.closest('.flex').querySelector('.legend-label-text');
                        if (legendLabel) {
                            legendLabel.addEventListener('click', () => {
                                showLegendToggle.checked = !showLegendToggle.checked;
                                toggleLegendState();
                            });
                        }
                        
                        // Initialize the state on page load
                        toggleLegendState();
                    }
                }, 100);

            } else if (selectedChartSubtype === 'line' || selectedChartSubtype === 'area' || selectedChartSubtype === 'scatter-plot') {
                // Create tabs structure for Line, Area, and Scatter Plot
                const tabsContainer = document.createElement('div');
                tabsContainer.className = 'flex border border-gray-700 rounded-lg h-full overflow-hidden';
                tabsContainer.style.minHeight = '400px';

                // Visual Property Tabs
                const tabsSidebar = document.createElement('div');
                tabsSidebar.className = 'flex flex-col w-52 p-3 bg-gray-800 border-r border-gray-700';
                
                const tabsList = document.createElement('div');
                tabsList.className = 'flex-1 space-y-2';

                // X-Axis Tab
                const xAxisTab = document.createElement('div');
                xAxisTab.className = 'create-visual-property-tab flex items-center justify-between py-2 px-3 bg-blue-600 text-white rounded-lg transition duration-200 cursor-pointer';
                xAxisTab.setAttribute('data-visual-tab', 'x-axis');
                xAxisTab.innerHTML = `
                    <span class="text-sm font-medium">X-Axis</span>
                    <span id="create-line-x-axis-validation-icon" class="material-symbols-outlined text-[20px]" title=""></span>
                `;
                tabsList.appendChild(xAxisTab);

                // Series Tab
                const seriesTab = document.createElement('div');
                seriesTab.className = 'create-visual-property-tab flex items-center justify-between py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg cursor-pointer transition duration-200';
                seriesTab.setAttribute('data-visual-tab', 'series');
                seriesTab.innerHTML = `
                    <span class="text-sm font-medium">Series</span>
                    <span id="create-line-series-validation-icon" class="material-symbols-outlined text-[20px]" title=""></span>
                `;
                tabsList.appendChild(seriesTab);

                // Legend Tab
                const legendTab = document.createElement('div');
                legendTab.className = 'create-visual-property-tab flex items-center py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg cursor-pointer transition duration-200';
                legendTab.setAttribute('data-visual-tab', 'legend');
                legendTab.innerHTML = `
                    <span class="text-sm font-medium">Legend</span>
                `;
                tabsList.appendChild(legendTab);

                tabsSidebar.appendChild(tabsList);
                tabsContainer.appendChild(tabsSidebar);

                // Tab Content Container
                const tabContentContainer = document.createElement('div');
                tabContentContainer.className = 'flex-1 p-4 overflow-auto';

                // X-Axis Tab Content
                const xAxisContent = document.createElement('div');
                xAxisContent.id = 'x-axis-tab-content';
                xAxisContent.className = 'component-visual-tab-content space-y-6';
                xAxisContent.innerHTML = `
                    <div>
                        <label class="text-sm text-gray-500 block mb-2">Data Field <span class="text-red-400">*</span></label>
                    <div>
                            <div class="relative">
                                <select id="x-axis-data-field-select" class="w-full bg-gray-800 border border-gray-700 hover:bg-gray-700 transition duration-200 rounded-md px-3 py-2 text-sm text-gray-300 focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none" onchange="selectXAxisDataField(this.value)">
                                    <option value="">Select data field</option>
                                    ${config.xOptions.map(option => `<option value="${option}">${option}</option>`).join('')}
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                    <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-700"></div>

                    <div class="space-y-4">
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Axis Order</label>
                        <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                        <input type="checkbox">
                                        <span class="toggle-slider"></span>
                            </label>
                                    <span class="text-sm text-gray-300">Reverse Order</span>
                                </div>
                        </div>
                    </div>
                    
                        <div>
                            <label class="text-sm text-gray-500 block mb-2">Gridlines</label>
                        <div class="space-y-3">
                                <div class="flex items-center space-x-3">
                                    <label class="toggle-switch">
                                            <input type="checkbox">
                                            <span class="toggle-slider"></span>
                            </label>
                                    <span class="text-sm text-gray-300">Major Gridlines</span>
                        </div>
                            </div>
                        </div>

                    </div>
                `;
                tabContentContainer.appendChild(xAxisContent);

                // Series Tab Content
                const seriesContent = document.createElement('div');
                seriesContent.id = 'series-tab-content';
                seriesContent.className = 'component-visual-tab-content hidden space-y-6';
                
                // Create the Add Series field structure
                const seriesFieldDiv = document.createElement('div');
                seriesFieldDiv.className = 'relative';
                
                // Header with label and remove all button
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex items-center justify-between mb-3';
                
                const label = document.createElement('label');
                label.className = 'text-sm font-medium text-gray-300';
                label.textContent = 'Series Fields';
                
                const removeAllBtn = document.createElement('button');
                removeAllBtn.type = 'button';
                removeAllBtn.id = 'series-field-remove-all';
                removeAllBtn.className = 'text-red-400 hover:text-red-300 text-xs font-medium transition duration-200 hidden';
                removeAllBtn.textContent = 'Remove All';
                removeAllBtn.addEventListener('click', function() {
                    selectedSeriesFields = [];
                    updateSeriesList();
                    validateStep3();
                    updateWizardState();
                });
                
                headerDiv.appendChild(label);
                headerDiv.appendChild(removeAllBtn);
                seriesFieldDiv.appendChild(headerDiv);
                
                // Series list container
                const listContainer = document.createElement('div');
                listContainer.id = 'series-field-list';
                listContainer.className = 'space-y-2 mb-3';
                seriesFieldDiv.appendChild(listContainer);
                
                // Add Series dropdown button
                const addSeriesBtn = document.createElement('button');
                addSeriesBtn.type = 'button';
                addSeriesBtn.id = 'series-field-btn';
                addSeriesBtn.className = 'bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition duration-200 flex items-center space-x-2 text-sm';
                addSeriesBtn.innerHTML = '<span class="material-symbols-outlined" style="font-size: 20px;">add</span><span>Add Series Field</span>';
                addSeriesBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleSeriesDropdown('series-field');
                });
                
                // Dropdown container
                const dropdownContainer = document.createElement('div');
                dropdownContainer.id = 'series-field-dropdown';
                dropdownContainer.className = 'absolute z-50 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto hidden mt-2';
                dropdownContainer.style.width = '100%';
                dropdownContainer.style.maxWidth = '400px';
                
                // Store options for later use
                dropdownContainer.dataset.options = JSON.stringify(config.seriesOptions);
                
                // Position the dropdown relative to the button
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'relative';
                buttonContainer.appendChild(addSeriesBtn);
                buttonContainer.appendChild(dropdownContainer);
                seriesFieldDiv.appendChild(buttonContainer);
                
                seriesContent.appendChild(seriesFieldDiv);
                
                // Add configuration fields to Series tab
                const configDiv = document.createElement('div');
                configDiv.className = 'space-y-6';
                configDiv.innerHTML = `
                    <div class="border-t border-gray-700 my-6"></div>
                    
                    <div class="max-w-md">
                        <label class="text-sm font-medium text-gray-300 block mb-2">Color Palette</label>
                        <div class="relative">
                            <button id="series-color-palette-btn" class="w-full bg-gray-800 border border-gray-600 hover:bg-gray-700 transition duration-200 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                                    <div id="series-color-palette-preview" class="w-8 h-4 rounded bg-gradient-to-r from-teal-400 via-orange-400 to-pink-400"></div>
                                    <span id="series-color-palette-selected">Default</span>
                                </div>
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </button>
                            <div id="series-color-palette-dropdown" class="absolute top-full left-0 mt-2 bg-gray-800 border border-gray-600 rounded-md shadow-lg hidden z-50 min-w-64 w-full">
                                <div class="p-2 space-y-1">
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="default">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-teal-400 via-orange-400 to-pink-400"></div>
                                        <span class="text-sm text-white">Default</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="red">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-red-300 via-red-500 to-red-700"></div>
                                        <span class="text-sm text-white">Red Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="blue">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-blue-300 via-blue-500 to-blue-700"></div>
                                        <span class="text-sm text-white">Blue Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="green">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-green-300 via-green-500 to-green-700"></div>
                                        <span class="text-sm text-white">Green Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="purple">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-purple-300 via-purple-500 to-purple-700"></div>
                                        <span class="text-sm text-white">Purple Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="orange">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-orange-300 via-orange-500 to-orange-700"></div>
                                        <span class="text-sm text-white">Orange Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="teal">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-teal-300 via-teal-500 to-teal-700"></div>
                                        <span class="text-sm text-white">Teal Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="pink">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-pink-300 via-pink-500 to-pink-700"></div>
                                        <span class="text-sm text-white">Pink Theme</span>
                                    </div>
                                    <div class="color-palette-option flex items-center space-x-3 px-3 py-2 hover:bg-gray-700 rounded cursor-pointer transition duration-200" data-value="gray">
                                        <div class="w-8 h-4 rounded bg-gradient-to-r from-gray-300 via-gray-500 to-gray-700"></div>
                                        <span class="text-sm text-white">Gray Theme</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="max-w-md">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-sm font-medium text-gray-300 block mb-2">Minimum Value</label>
                                <input type="number" id="series-min-value" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="0">
                            </div>
                            <div>
                                <label class="text-sm font-medium text-gray-300 block mb-2">Maximum Value</label>
                                <input type="number" id="series-max-value" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="100">
                            </div>
                        </div>
                    </div>
                    
                    <div class="max-w-md">
                        <label class="text-sm font-medium text-gray-300 block mb-2">Scale Factor</label>
                        <div class="relative">
                            <select id="series-scale-factor" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="1">1x (No scaling)</option>
                                <option value="0.001">0.001x (Thousands)</option>
                                <option value="0.01">0.01x (Hundreds)</option>
                                <option value="0.1">0.1x (Tens)</option>
                                <option value="10">10x</option>
                                <option value="100">100x</option>
                                <option value="1000">1000x</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="max-w-md">
                        <label class="text-sm font-medium text-gray-300 block mb-2">Number Format</label>
                        <div class="relative">
                            <select id="series-number-format" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="number">Number (1,234.56)</option>
                                <option value="currency">Currency ($1,234.56)</option>
                                <option value="percentage">Percentage (123.46%)</option>
                                <option value="decimal">Decimal (1234.56)</option>
                                <option value="integer">Integer (1235)</option>
                                <option value="scientific">Scientific (1.23e+3)</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="border-t border-gray-700 my-6"></div>
                    
                    <div class="max-w-md">
                        <label class="text-sm font-medium text-gray-300 block mb-3">Gridlines & Ticks</label>
                        <div class="space-y-3">
                            <div class="flex items-center space-x-3">
                                <label class="toggle-switch">
                                    <input type="checkbox">
                                    <span class="toggle-slider"></span>
                                </label>
                                <span class="text-sm text-gray-300">Major Gridlines</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label class="toggle-switch">
                                    <input type="checkbox">
                                    <span class="toggle-slider"></span>
                            </label>
                                <span class="text-sm text-gray-300">Minor Gridlines</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label class="toggle-switch">
                                    <input type="checkbox">
                                    <span class="toggle-slider"></span>
                            </label>
                                <span class="text-sm text-gray-300">Major Ticks</span>
                            </div>
                            <div class="flex items-center space-x-3">
                                <label class="toggle-switch">
                                    <input type="checkbox">
                                    <span class="toggle-slider"></span>
                            </label>
                                <span class="text-sm text-gray-300">Minor Ticks</span>
                            </div>
                        </div>
                    </div>
                `;
                seriesContent.appendChild(configDiv);
                tabContentContainer.appendChild(seriesContent);

                // Legend Tab Content
                const legendContent = document.createElement('div');
                legendContent.id = 'legend-tab-content';
                legendContent.className = 'component-visual-tab-content hidden space-y-6';
                legendContent.innerHTML = `
                    <div class="max-w-md">
                        <div class="flex items-center space-x-3">
                            <label class="toggle-switch">
                                <input type="checkbox" id="legend-show-legend">
                                <span class="toggle-slider"></span>
                            </label>
                            <span class="legend-label-text text-sm text-gray-300 cursor-pointer hover:text-gray-200">Show Legend</span>
                        </div>
                    </div>
                    
                    <div class="max-w-md" id="legend-position-container" style="display: none;">
                        <label class="text-sm font-medium text-gray-300 block mb-2">Legend Position</label>
                        <div class="relative">
                            <select id="legend-position" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="auto">Auto</option>
                                <option value="top">Top</option>
                                <option value="bottom">Bottom</option>
                                <option value="left">Left</option>
                                <option value="right">Right</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                `;
                tabContentContainer.appendChild(legendContent);

                tabsContainer.appendChild(tabContentContainer);
                container.appendChild(tabsContainer);

                // Add event listeners for tab switching
                setTimeout(() => {
                    const tabButtons = tabsContainer.querySelectorAll('.create-visual-property-tab');
                    const tabContents = tabsContainer.querySelectorAll('.component-visual-tab-content');

                    tabButtons.forEach(button => {
                        button.addEventListener('click', () => {
                            const targetTab = button.getAttribute('data-visual-tab');
                            
                            // Update active tab button
                            tabButtons.forEach(btn => {
                                btn.className = btn.className.replace('bg-blue-600 text-white', 'bg-gray-700 hover:bg-gray-600 text-gray-300');
                            });
                            button.className = button.className.replace('bg-gray-700 hover:bg-gray-600 text-gray-300', 'bg-blue-600 text-white');
                            
                            // Show target tab content
                            tabContents.forEach(content => {
                                content.classList.add('hidden');
                            });
                            const targetContent = tabsContainer.querySelector(`#${targetTab}-tab-content`);
                            if (targetContent) {
                                targetContent.classList.remove('hidden');
                            }
                        });
                    });

                    // Initialize the Series list
                    updateSeriesDropdown('series-field');
                    updateSeriesList();

                    // Initialize Color Palette dropdown functionality
                    const colorPaletteBtn = document.getElementById('series-color-palette-btn');
                    const colorPaletteDropdown = document.getElementById('series-color-palette-dropdown');
                    const colorPaletteOptions = document.querySelectorAll('.color-palette-option');

                    if (colorPaletteBtn && colorPaletteDropdown) {
                        colorPaletteBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            colorPaletteDropdown.classList.toggle('hidden');
                        });

                        // Handle color palette option selection
                        colorPaletteOptions.forEach(option => {
                            option.addEventListener('click', function(e) {
                                e.stopPropagation();
                                const value = this.getAttribute('data-value');
                                const name = this.querySelector('span').textContent;
                                const preview = this.querySelector('div').cloneNode(true);
                                
                                // Update the button display
                                const selectedSpan = document.getElementById('series-color-palette-selected');
                                const previewDiv = document.getElementById('series-color-palette-preview');
                                
                                if (selectedSpan) selectedSpan.textContent = name;
                                if (previewDiv) {
                                    previewDiv.innerHTML = '';
                                    previewDiv.appendChild(preview);
                                }
                                
                                // Hide dropdown
                                colorPaletteDropdown.classList.add('hidden');
                            });
                        });

                        // Close dropdown when clicking outside
                        document.addEventListener('click', function(e) {
                            if (!colorPaletteBtn.contains(e.target) && !colorPaletteDropdown.contains(e.target)) {
                                colorPaletteDropdown.classList.add('hidden');
                            }
                        });
                    }

                    // Initialize Legend functionality
                    const showLegendToggle = document.getElementById('legend-show-legend');
                    const legendPositionContainer = document.getElementById('legend-position-container');

                    if (showLegendToggle && legendPositionContainer) {
                        // Function to toggle legend state
                        function toggleLegendState() {
                            const isChecked = showLegendToggle.checked;
                            
                            // Show/hide legend position container based on checkbox state
                            if (isChecked) {
                                legendPositionContainer.style.display = 'block';
                            } else {
                                legendPositionContainer.style.display = 'none';
                            }
                        }

                        // Add change event to checkbox
                        showLegendToggle.addEventListener('change', toggleLegendState);

                        // Add click event to the label text
                        const legendLabel = showLegendToggle.closest('.flex').querySelector('.legend-label-text');
                        if (legendLabel) {
                            legendLabel.addEventListener('click', () => {
                                showLegendToggle.checked = !showLegendToggle.checked;
                                toggleLegendState();
                            });
                        }
                        
                        // Initialize the state on page load
                        toggleLegendState();
                    }
                }, 100);

            } else if (selectedChartSubtype === 'donut' || selectedChartSubtype === 'radial') {
                // Label Field
                const labelField = createSelectField('label-field', config.label, config.labelOptions);
                container.appendChild(labelField);

                // Value Field
                const valueField = createSelectField('value-field', config.value, config.valueOptions);
                container.appendChild(valueField);
            }
            
            // Update validation icons after generating chart mapping fields
            updateMappingValidationIcons();
        }

        function generateMapLayerMappingFields(container) {
            const mapFields = {
                'heatmap': {
                    xAxis: 'Longitude',
                    yAxis: 'Latitude',
                    value: 'Intensity',
                    xOptions: ['longitude', 'grid_id'],
                    yOptions: ['latitude', 'grid_id'],
                    valueOptions: ['population_density', 'population_count', 'area_size_km2', 'sales', 'revenue']
                },
                'area': {
                    xAxis: 'Longitude',
                    yAxis: 'Latitude',
                    value: 'Area Value',
                    xOptions: ['longitude', 'grid_id'],
                    yOptions: ['latitude', 'grid_id'],
                    valueOptions: ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue']
                },
                'disc': {
                    xAxis: 'Longitude',
                    yAxis: 'Latitude',
                    value: 'Size',
                    xOptions: ['longitude', 'grid_id'],
                    yOptions: ['latitude', 'grid_id'],
                    valueOptions: ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue']
                },
                'pillar': {
                    xAxis: 'Longitude',
                    yAxis: 'Latitude',
                    value: 'Height',
                    xOptions: ['longitude', 'grid_id'],
                    yOptions: ['latitude', 'grid_id'],
                    valueOptions: ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue']
                },
                'arcs': {
                    xAxis: 'Start Longitude',
                    yAxis: 'Start Latitude',
                    value: 'End Coordinates',
                    xOptions: ['longitude', 'grid_id'],
                    yOptions: ['latitude', 'grid_id'],
                    valueOptions: ['end_longitude', 'end_latitude', 'distance', 'population_count']
                }
            };

            const config = mapFields[selectedMapLayerSubtype];
            if (!config) return;

            // X-Axis Field
            const xAxisField = createSelectField('x-axis-field', config.xAxis, config.xOptions);
            container.appendChild(xAxisField);

            // Y-Axis Field
            const yAxisField = createSelectField('y-axis-field', config.yAxis, config.yOptions);
            container.appendChild(yAxisField);

            // Value Field (for map layers)
            const valueField = createSelectField('value-field', config.value, config.valueOptions);
            container.appendChild(valueField);
        }

        function generateKpiMappingFields(container) {
            const kpiField = createSelectField('kpi-field', 'KPI Value', ['population_count', 'area_size_km2', 'population_density', 'sales', 'revenue', 'quantity']);
            container.appendChild(kpiField);
        }

        function createSelectField(id, label, options) {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'space-y-2';

            const labelElement = document.createElement('label');
            labelElement.className = 'block text-sm font-medium text-gray-300 mb-2';
            labelElement.innerHTML = `${label} <span class="text-red-400">*</span>`;

            const selectDiv = document.createElement('div');
            selectDiv.className = 'relative';

            const select = document.createElement('select');
            select.id = id;
            select.className = 'w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none';

            // Add default option
            const defaultOption = document.createElement('option');
            defaultOption.value = '';
            defaultOption.textContent = `Select ${label.toLowerCase()}`;
            select.appendChild(defaultOption);

            // Add options
            const optionLabels = {
                'date': 'Date',
                'time': 'Time',
                'timestamp': 'Timestamp',
                'category': 'Category',
                'region': 'Region',
                'grid_id': 'Grid ID',
                'longitude': 'Longitude',
                'latitude': 'Latitude',
                'population_count': 'Population Count',
                'area_size_km2': 'Area Size (km)',
                'population_density': 'Population Density',
                'sales': 'Sales',
                'revenue': 'Revenue',
                'quantity': 'Quantity',
                'end_longitude': 'End Longitude',
                'end_latitude': 'End Latitude',
                'distance': 'Distance'
            };

            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = optionLabels[option] || option;
                select.appendChild(optionElement);
            });

            // Add custom arrow
            const arrowDiv = document.createElement('div');
            arrowDiv.className = 'absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none';
            arrowDiv.innerHTML = '<span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>';

            selectDiv.appendChild(select);
            selectDiv.appendChild(arrowDiv);
            fieldDiv.appendChild(labelElement);
            fieldDiv.appendChild(selectDiv);

            // Add event listener
            select.addEventListener('change', function() {
                if (id === 'x-axis-field') {
                    selectedXAxisField = this.value;
                } else if (id === 'y-axis-field') {
                    selectedYAxisField = this.value;
                } else if (id === 'value-field') {
                    selectedValueField = this.value;
                } else if (id === 'kpi-field') {
                    selectedKpiField = this.value;
                } else if (id === 'label-field') {
                    selectedLabelField = this.value;
                }
                validateStep3();
                updateWizardState();
            });

            return fieldDiv;
        }

        function createSeriesField(id, label, options) {
            const fieldDiv = document.createElement('div');
            fieldDiv.className = 'space-y-3';

            // Header with label and Remove All button
            const headerDiv = document.createElement('div');
            headerDiv.className = 'flex items-center justify-between';

            const labelElement = document.createElement('label');
            labelElement.className = 'block text-sm font-medium text-gray-300';
            labelElement.innerHTML = `${label} <span class="text-red-400">*</span>`;

            const removeAllBtn = document.createElement('button');
            removeAllBtn.type = 'button';
            removeAllBtn.id = id + '-remove-all';
            removeAllBtn.className = 'text-red-400 hover:text-red-300 text-sm font-medium transition duration-200 hidden';
            removeAllBtn.textContent = 'Remove All';
            removeAllBtn.addEventListener('click', function() {
                selectedSeriesFields = [];
                updateSeriesList();
                validateStep3();
                updateWizardState();
            });

            headerDiv.appendChild(labelElement);
            headerDiv.appendChild(removeAllBtn);
            fieldDiv.appendChild(headerDiv);

            // Series list container
            const listContainer = document.createElement('div');
            listContainer.id = id + '-list';
            listContainer.className = 'space-y-2';
            fieldDiv.appendChild(listContainer);

            // Add Series dropdown button
            const addSeriesBtn = document.createElement('button');
            addSeriesBtn.type = 'button';
            addSeriesBtn.id = id + '-btn';
            addSeriesBtn.className = 'bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition duration-200 flex items-center space-x-2 text-sm';
            addSeriesBtn.innerHTML = '<span class="material-symbols-outlined">add</span><span>Add Series</span>';
            addSeriesBtn.addEventListener('click', function() {
                toggleSeriesDropdown(id);
            });

            fieldDiv.appendChild(addSeriesBtn);

            // Dropdown container
            const dropdownContainer = document.createElement('div');
            dropdownContainer.id = id + '-dropdown';
            dropdownContainer.className = 'absolute z-50 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto hidden mt-2';
            dropdownContainer.style.width = '100%';
            dropdownContainer.style.maxWidth = '400px';

            // Store options for later use
            dropdownContainer.dataset.options = JSON.stringify(options);

            // Add options to dropdown
            updateSeriesDropdown(id);

            // Position the dropdown relative to the button
            const buttonContainer = document.createElement('div');
            buttonContainer.className = 'relative';
            buttonContainer.appendChild(addSeriesBtn);
            buttonContainer.appendChild(dropdownContainer);
            fieldDiv.appendChild(buttonContainer);

            // Initialize the list
            setTimeout(() => {
                updateSeriesList();
            }, 0);

            return fieldDiv;
        }

        function updateSeriesDropdown(id) {
            const dropdown = document.getElementById(id + '-dropdown');
            if (!dropdown) return;

            // Clear existing options
            dropdown.innerHTML = '';

            const options = JSON.parse(dropdown.dataset.options || '[]');
            const optionLabels = {
                'date': 'Date',
                'time': 'Time',
                'timestamp': 'Timestamp',
                'category': 'Category',
                'region': 'Region',
                'grid_id': 'Grid ID',
                'longitude': 'Longitude',
                'latitude': 'Latitude',
                'population_count': 'Population Count',
                'area_size_km2': 'Area Size (km)',
                'population_density': 'Population Density',
                'sales': 'Sales',
                'revenue': 'Revenue',
                'quantity': 'Quantity',
                'end_longitude': 'End Longitude',
                'end_latitude': 'End Latitude',
                'distance': 'Distance'
            };

            options.forEach(option => {
                const optionDiv = document.createElement('div');
                const isSelected = selectedSeriesFields.includes(option);
                
                if (isSelected) {
                    optionDiv.className = 'px-3 py-2 text-sm text-gray-500 cursor-not-allowed flex items-center justify-between';
                    optionDiv.innerHTML = `
                        <span>${optionLabels[option] || option}</span>
                        <span class="text-xs text-gray-400">Already added</span>
                    `;
                } else {
                    optionDiv.className = 'px-3 py-2 hover:bg-gray-700 cursor-pointer text-sm text-white transition duration-200';
                    optionDiv.textContent = optionLabels[option] || option;
                    optionDiv.addEventListener('click', function() {
                        selectedSeriesFields.push(option);
                        updateSeriesList();
                        updateSeriesDropdown(id);
                        toggleSeriesDropdown(id);
                        validateStep3();
                        updateWizardState();
                    });
                }
                
                dropdown.appendChild(optionDiv);
            });
        }

        function toggleSeriesDropdown(id) {
            const dropdown = document.getElementById(id + '-dropdown');
            const button = document.getElementById(id + '-btn');
            
            if (dropdown.classList.contains('hidden')) {
                // Close any other open dropdowns
                document.querySelectorAll('[id$="-dropdown"]').forEach(d => {
                    if (d !== dropdown) {
                        d.classList.add('hidden');
                    }
                });
                
                // Update dropdown options before showing
                updateSeriesDropdown(id);
                
                // Show this dropdown
                dropdown.classList.remove('hidden');
            } else {
                // Hide dropdown
                dropdown.classList.add('hidden');
            }
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('[id$="-btn"]') && !e.target.closest('[id$="-dropdown"]')) {
                document.querySelectorAll('[id$="-dropdown"]').forEach(dropdown => {
                    dropdown.classList.add('hidden');
                });
            }
        });

        function updateSeriesList() {
            const listContainer = document.getElementById('series-field-list');
            const removeAllBtn = document.getElementById('series-field-remove-all');
            if (!listContainer) return;

            // Clear existing list
            listContainer.innerHTML = '';



            if (selectedSeriesFields.length === 0) {
                // Hide Remove All button
                if (removeAllBtn) {
                    removeAllBtn.classList.add('hidden');
                }
                return;
            }

            // Show Remove All button
            if (removeAllBtn) {
                removeAllBtn.classList.remove('hidden');
            }

            // Create list items
            selectedSeriesFields.forEach((field, index) => {
                const listItem = createSeriesListItem(field, index);
                listContainer.appendChild(listItem);
            });

            // Add drag and drop functionality
            makeListSortable(listContainer);
        }

        function createSeriesListItem(field, index) {
            const optionLabels = {
                'date': 'Date',
                'time': 'Time',
                'timestamp': 'Timestamp',
                'category': 'Category',
                'region': 'Region',
                'grid_id': 'Grid ID',
                'longitude': 'Longitude',
                'latitude': 'Latitude',
                'population_count': 'Population Count',
                'area_size_km2': 'Area Size (km)',
                'population_density': 'Population Density',
                'sales': 'Sales',
                'revenue': 'Revenue',
                'quantity': 'Quantity',
                'end_longitude': 'End Longitude',
                'end_latitude': 'End Latitude',
                'distance': 'Distance'
            };

            const itemDiv = document.createElement('div');
            itemDiv.className = 'series-item flex items-center justify-between bg-gray-800 border border-gray-600 rounded-md px-3 py-2 cursor-move hover:bg-gray-700 transition duration-200';
            itemDiv.draggable = true;
            itemDiv.dataset.index = index;

            const dragHandle = document.createElement('span');
            dragHandle.className = 'material-symbols-outlined text-gray-400 text-sm mr-2 cursor-move';
            dragHandle.textContent = 'drag_indicator';

            const fieldLabel = document.createElement('span');
            fieldLabel.className = 'text-sm text-white flex-1';
            fieldLabel.textContent = optionLabels[field] || field;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-red-400 hover:text-red-300 transition duration-200';
            removeBtn.innerHTML = '<span class="material-symbols-outlined text-sm">close</span>';
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                selectedSeriesFields.splice(index, 1);
                updateSeriesList();
                validateStep3();
                updateWizardState();
            });

            itemDiv.appendChild(dragHandle);
            itemDiv.appendChild(fieldLabel);
            itemDiv.appendChild(removeBtn);

            return itemDiv;
        }

        function makeListSortable(container) {
            let draggedItem = null;
            let draggedIndex = null;

            // Add drag events to each item
            function addDragEvents(item) {
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    draggedIndex = parseInt(this.dataset.index);
                    this.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                    draggedItem = null;
                    draggedIndex = null;
                });

                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (draggedItem && draggedIndex !== null) {
                        const dropIndex = parseInt(this.dataset.index);
                        
                        if (dropIndex !== draggedIndex) {
                            // Reorder the array
                            const item = selectedSeriesFields[draggedIndex];
                            selectedSeriesFields.splice(draggedIndex, 1);
                            selectedSeriesFields.splice(dropIndex, 0, item);
                            
                            // Update the list
                            updateSeriesList();
                            validateStep3();
                            updateWizardState();
                        }
                    }
                });
            }

            // Add drag events to existing items
            container.querySelectorAll('.series-item').forEach(addDragEvents);

            // Add container drop zone for dropping at the end
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            container.addEventListener('drop', function(e) {
                e.preventDefault();
                
                if (draggedItem && draggedIndex !== null) {
                    const items = container.querySelectorAll('.series-item');
                    const lastItem = items[items.length - 1];
                    
                    if (lastItem && e.clientY > lastItem.getBoundingClientRect().bottom) {
                        // Drop at the end
                        const item = selectedSeriesFields[draggedIndex];
                        selectedSeriesFields.splice(draggedIndex, 1);
                        selectedSeriesFields.push(item);
                        
                        // Update the list
                        updateSeriesList();
                        validateStep3();
                        updateWizardState();
                    }
                }
            });
        }

        // Y-Axis field functions
        function updateYAxisDropdown(id) {
            const dropdown = document.getElementById(id + '-dropdown');
            if (!dropdown) return;

            // Clear existing options
            dropdown.innerHTML = '';

            const options = JSON.parse(dropdown.dataset.options || '[]');
            const optionLabels = {
                'date': 'Date',
                'time': 'Time',
                'timestamp': 'Timestamp',
                'category': 'Category',
                'region': 'Region',
                'grid_id': 'Grid ID',
                'longitude': 'Longitude',
                'latitude': 'Latitude',
                'population_count': 'Population Count',
                'area_size_km2': 'Area Size (km)',
                'population_density': 'Population Density',
                'sales': 'Sales',
                'revenue': 'Revenue',
                'quantity': 'Quantity',
                'end_longitude': 'End Longitude',
                'end_latitude': 'End Latitude',
                'distance': 'Distance'
            };

            options.forEach(option => {
                const optionDiv = document.createElement('div');
                const isSelected = selectedYAxisFields.includes(option);
                
                if (isSelected) {
                    optionDiv.className = 'px-3 py-2 text-sm text-gray-500 cursor-not-allowed flex items-center justify-between';
                    optionDiv.innerHTML = `
                        <span>${optionLabels[option] || option}</span>
                        <span class="text-xs text-gray-400">Already added</span>
                    `;
                } else {
                    optionDiv.className = 'px-3 py-2 hover:bg-gray-700 cursor-pointer text-sm text-white transition duration-200';
                    optionDiv.textContent = optionLabels[option] || option;
                    optionDiv.addEventListener('click', function() {
                        selectedYAxisFields.push(option);
                        updateYAxisList();
                        updateYAxisDropdown(id);
                        toggleYAxisDropdown(id);
                        validateStep3();
                        updateWizardState();
                    });
                }
                
                dropdown.appendChild(optionDiv);
            });
        }



        function selectYAxisDataField(value) {
            if (value === '') {
                selectedYAxisField = null;
            } else {
                selectedYAxisField = value;
            }
            
            // Update validation
            validateStep3();
            updateWizardState();
        }



        function selectXAxisDataField(value) {
            if (value === '') {
                selectedXAxisField = null;
            } else {
                selectedXAxisField = value;
            }
            
            // Update validation
            validateStep3();
            updateWizardState();
        }

        function toggleYAxisDropdown(id) {
            const dropdown = document.getElementById(id + '-dropdown');
            const button = document.getElementById(id + '-btn');
            
            if (dropdown.classList.contains('hidden')) {
                // Close any other open dropdowns
                document.querySelectorAll('[id$="-dropdown"]').forEach(d => {
                    if (d !== dropdown) {
                        d.classList.add('hidden');
                    }
                });
                
                // Update dropdown options before showing
                updateYAxisDropdown(id);
                
                // Show this dropdown
                dropdown.classList.remove('hidden');
            } else {
                // Hide dropdown
                dropdown.classList.add('hidden');
            }
        }

        function updateYAxisList() {
            const listContainer = document.getElementById('y-axis-field-list');
            const removeAllBtn = document.getElementById('y-axis-field-remove-all');
            if (!listContainer) return;

            // Clear existing list
            listContainer.innerHTML = '';

            if (selectedYAxisFields.length === 0) {
                // Hide Remove All button
                if (removeAllBtn) {
                    removeAllBtn.classList.add('hidden');
                }
                return;
            }

            // Show Remove All button
            if (removeAllBtn) {
                removeAllBtn.classList.remove('hidden');
            }

            // Create list items
            selectedYAxisFields.forEach((field, index) => {
                const listItem = createYAxisListItem(field, index);
                listContainer.appendChild(listItem);
            });

            // Add drag and drop functionality
            makeYAxisListSortable(listContainer);
        }

        function createYAxisListItem(field, index) {
            const optionLabels = {
                'date': 'Date',
                'time': 'Time',
                'timestamp': 'Timestamp',
                'category': 'Category',
                'region': 'Region',
                'grid_id': 'Grid ID',
                'longitude': 'Longitude',
                'latitude': 'Latitude',
                'population_count': 'Population Count',
                'area_size_km2': 'Area Size (km)',
                'population_density': 'Population Density',
                'sales': 'Sales',
                'revenue': 'Revenue',
                'quantity': 'Quantity',
                'end_longitude': 'End Longitude',
                'end_latitude': 'End Latitude',
                'distance': 'Distance'
            };

            const itemDiv = document.createElement('div');
            itemDiv.className = 'y-axis-item flex items-center justify-between bg-gray-700 border border-gray-600 rounded-md px-3 py-2 cursor-move hover:bg-gray-600 transition duration-200';
            itemDiv.draggable = true;
            itemDiv.dataset.index = index;

            const dragHandle = document.createElement('span');
            dragHandle.className = 'material-symbols-outlined text-gray-400 text-sm mr-2 cursor-move';
            dragHandle.textContent = 'drag_indicator';

            const fieldLabel = document.createElement('span');
            fieldLabel.className = 'text-sm text-white flex-1';
            fieldLabel.textContent = optionLabels[field] || field;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'text-red-400 hover:text-red-300 transition duration-200';
            removeBtn.innerHTML = '<span class="material-symbols-outlined text-sm">close</span>';
            removeBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                selectedYAxisFields.splice(index, 1);
                updateYAxisList();
                validateStep3();
                updateWizardState();
            });

            itemDiv.appendChild(dragHandle);
            itemDiv.appendChild(fieldLabel);
            itemDiv.appendChild(removeBtn);

            return itemDiv;
        }

        function makeYAxisListSortable(container) {
            let draggedItem = null;
            let draggedIndex = null;

            // Add drag events to each item
            function addDragEvents(item) {
                item.addEventListener('dragstart', function(e) {
                    draggedItem = this;
                    draggedIndex = parseInt(this.dataset.index);
                    this.style.opacity = '0.5';
                    e.dataTransfer.effectAllowed = 'move';
                });

                item.addEventListener('dragend', function(e) {
                    this.style.opacity = '1';
                    draggedItem = null;
                    draggedIndex = null;
                });

                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                });

                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    if (draggedItem && draggedIndex !== null) {
                        const dropIndex = parseInt(this.dataset.index);
                        
                        if (dropIndex !== draggedIndex) {
                            // Reorder the array
                            const item = selectedYAxisFields[draggedIndex];
                            selectedYAxisFields.splice(draggedIndex, 1);
                            selectedYAxisFields.splice(dropIndex, 0, item);
                            
                            // Update the list
                            updateYAxisList();
                            validateStep3();
                            updateWizardState();
                        }
                    }
                });
            }

            // Add drag events to existing items
            container.querySelectorAll('.y-axis-item').forEach(addDragEvents);

            // Add container drop zone for dropping at the end
            container.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            container.addEventListener('drop', function(e) {
                e.preventDefault();
                
                if (draggedItem && draggedIndex !== null) {
                    const items = container.querySelectorAll('.y-axis-item');
                    const lastItem = items[items.length - 1];
                    
                    if (lastItem && e.clientY > lastItem.getBoundingClientRect().bottom) {
                        // Drop at the end
                        const item = selectedYAxisFields[draggedIndex];
                        selectedYAxisFields.splice(draggedIndex, 1);
                        selectedYAxisFields.push(item);
                        
                        // Update the list
                        updateYAxisList();
                        validateStep3();
                        updateWizardState();
                    }
                }
            });
        }

        function validateStep1() {
            const componentName = document.getElementById('component-name');
            const componentDescription = document.getElementById('component-description');
            const componentCategory = document.getElementById('component-category');
            
            if (componentName && componentDescription && componentCategory) {
                const isNameValid = componentName.value.trim() !== '';
                const isDescriptionValid = componentDescription.value.trim() !== '';
                const isCategoryValid = componentCategory.value !== '';
                
                const isStep1Valid = isNameValid && isDescriptionValid && isCategoryValid;
                
                // Update Next button state only if we're on step 1
                const nextStepBtn = document.getElementById('next-step-btn');
                if (nextStepBtn) {
                    nextStepBtn.disabled = !isStep1Valid;
                    nextStepBtn.classList.toggle('opacity-50', !isStep1Valid);
                    nextStepBtn.classList.toggle('cursor-not-allowed', !isStep1Valid);
                }
                
                // Update field borders based on validation
                componentName.classList.toggle('border-red-500', !isNameValid && componentName.value !== '');
                componentDescription.classList.toggle('border-red-500', !isDescriptionValid && componentDescription.value !== '');
                componentCategory.classList.toggle('border-red-500', !isCategoryValid && componentCategory.value !== '');
            }
        }

        function updateSelectedAiModelDisplay() {
            if (selectedAiModel) {
                const model = aiModels.find(m => m.id === selectedAiModel);
                if (model) {
                    const nameElement = document.getElementById('selected-ai-model-name');
                    const detailsElement = document.getElementById('selected-ai-model-description');
                    const iconElement = document.getElementById('selected-ai-model-icon');
                    const aiModelSelectionContainer = document.getElementById('ai-model-selection-container');
                    const selectedAiModelDisplay = document.getElementById('selected-ai-model-display');
                    
                    if (nameElement) nameElement.textContent = model.name;
                    if (detailsElement) detailsElement.textContent = model.description;
                    if (iconElement) iconElement.textContent = 'auto_awesome';
                    
                    if (aiModelSelectionContainer && selectedAiModelDisplay) {
                        aiModelSelectionContainer.classList.add('hidden');
                        selectedAiModelDisplay.classList.remove('hidden');
                    }
                }
            } else {
                const aiModelSelectionContainer = document.getElementById('ai-model-selection-container');
                const selectedAiModelDisplay = document.getElementById('selected-ai-model-display');
                if (aiModelSelectionContainer && selectedAiModelDisplay) {
                    aiModelSelectionContainer.classList.remove('hidden');
                    selectedAiModelDisplay.classList.add('hidden');
                }
            }
        }

        // Global wizard state function
        function updateWizardState() {
            const totalSteps = 5;

            // Update step indicators
            for (let i = 1; i <= totalSteps; i++) {
                const stepIndicator = document.getElementById(`step-${i}-indicator`);
                const stepTab = document.getElementById(`step-${i}-tab`);
                const stepLabel = stepTab ? stepTab.querySelector('span') : null;
                
                if (stepIndicator && stepTab) {
                    // Reset all classes first
                    stepIndicator.classList.remove('bg-blue-600', 'bg-green-600', 'bg-gray-600', 'text-white', 'text-gray-400');
                    stepTab.classList.remove('cursor-pointer', 'cursor-not-allowed', 'border-blue-500', 'border-transparent');
                    if (stepLabel) {
                        stepLabel.classList.remove('text-blue-400', 'text-green-400', 'text-gray-400');
                    }
                    
                    // Determine step state
                    let stepState = 'disabled'; // default state
                    
                    if (i === 1) {
                        // Step 1 is always enabled
                        stepState = i === currentStep ? 'current' : 'enabled';
                    } else if (i === 2) {
                        // Step 2 is enabled only if Step 1 is complete
                        const isStep1Complete = validateStep1Fields();
                        if (isStep1Complete) {
                            stepState = i === currentStep ? 'current' : 'enabled';
                        }
                    } else if (i === 3) {
                        // Step 3 is enabled only if Step 2 is complete
                        const isStep2Complete = validateStep2Fields();
                        if (isStep2Complete) {
                            stepState = i === currentStep ? 'current' : 'enabled';
                        }
                    } else if (i === 4) {
                        // Step 4 is enabled only if Step 3 is complete (including data mapping)
                        const isStep3Complete = validateStep3Fields() && validateStep3DataMapping();
                        if (isStep3Complete) {
                            stepState = i === currentStep ? 'current' : 'enabled';
                        }
                    } else if (i === 5) {
                        // Step 5 is enabled when Step 4 is valid (filters are optional or properly mapped)
                        const isStep3Complete = validateStep3Fields() && validateStep3DataMapping();
                        const isStep4Valid = validateStep4Fields();
                        if (isStep3Complete && isStep4Valid) {
                            stepState = i === currentStep ? 'current' : 'enabled';
                        }
                    }
                    
                    // Apply state-specific styling
                    if (stepState === 'current') {
                        // Current step - Blue indicator, blue text, blue bottom border, clickable
                        stepIndicator.classList.add('bg-blue-600', 'text-white');
                        stepTab.classList.add('cursor-pointer', 'border-blue-500');
                        stepTab.classList.remove('border-transparent');
                        if (stepLabel) {
                            stepLabel.classList.add('text-blue-400');
                        }
                    } else if (stepState === 'enabled') {
                        // Enabled step - Blue indicator, blue text, transparent border, clickable
                        stepIndicator.classList.add('bg-blue-600', 'text-white');
                        stepTab.classList.add('cursor-pointer', 'border-transparent');
                        stepTab.classList.remove('border-blue-500');
                        if (stepLabel) {
                            stepLabel.classList.add('text-blue-400');
                        }
                    } else {
                        // Disabled step - Gray indicator, gray text, transparent border, not clickable
                        stepIndicator.classList.add('bg-gray-600', 'text-gray-400');
                        stepTab.classList.add('cursor-not-allowed', 'border-transparent');
                        stepTab.classList.remove('border-blue-500');
                        if (stepLabel) {
                            stepLabel.classList.add('text-gray-400');
                        }
                    }
                }
            }

            // Update step content visibility and tab active states
            for (let i = 1; i <= totalSteps; i++) {
                const stepContent = document.getElementById(`step-${i}-content`);
                const stepTab = document.getElementById(`step-${i}-tab`);
                
                if (stepContent) {
                    if (i === currentStep) {
                        stepContent.classList.remove('hidden');
                        
                        // Initialize tabs when step 2 (Data Source) becomes visible
                        if (i === 2) {
                            setTimeout(() => {
                                initializeComponentQueryLanguageTabs();
                                initializeComponentQueryResultsTabs();
                            }, 100);
                        }
                    } else {
                        stepContent.classList.add('hidden');
                    }
                }
                
                if (stepTab) {
                    if (i === currentStep) {
                        stepTab.classList.add('active');
                    } else {
                        stepTab.classList.remove('active');
                    }
                }
            }

            // Update navigation buttons
            const prevStepBtn = document.getElementById('prev-step-btn');
            const nextStepBtn = document.getElementById('next-step-btn');
            const finishBtn = document.getElementById('finish-btn');

            if (prevStepBtn) {
                prevStepBtn.disabled = currentStep === 1;
                prevStepBtn.classList.toggle('opacity-50', currentStep === 1);
                prevStepBtn.classList.toggle('cursor-not-allowed', currentStep === 1);
            }

            if (nextStepBtn) {
                nextStepBtn.classList.toggle('hidden', currentStep === totalSteps);
                
                // Disable Next button based on current step validation
                if (currentStep === 1) {
                    const isStep1Complete = validateStep1Fields();
                    nextStepBtn.disabled = !isStep1Complete;
                    nextStepBtn.classList.toggle('opacity-50', !isStep1Complete);
                    nextStepBtn.classList.toggle('cursor-not-allowed', !isStep1Complete);
                } else if (currentStep === 2) {
                    const isStep2Complete = validateStep2Fields();
                    nextStepBtn.disabled = !isStep2Complete;
                    nextStepBtn.classList.toggle('opacity-50', !isStep2Complete);
                    nextStepBtn.classList.toggle('cursor-not-allowed', !isStep2Complete);
                } else if (currentStep === 3) {
                    const isStep3Complete = validateStep3Fields() && validateStep3DataMapping();
                    nextStepBtn.disabled = !isStep3Complete;
                    nextStepBtn.classList.toggle('opacity-50', !isStep3Complete);
                    nextStepBtn.classList.toggle('cursor-not-allowed', !isStep3Complete);
                } else if (currentStep === 4) {
                    const isStep4Complete = validateStep4Fields();
                    nextStepBtn.disabled = !isStep4Complete;
                    nextStepBtn.classList.toggle('opacity-50', !isStep4Complete);
                    nextStepBtn.classList.toggle('cursor-not-allowed', !isStep4Complete);
                } else if (currentStep === 5) {
                    // Step 5 (Access) is always valid since it's optional
                    nextStepBtn.disabled = false;
                    nextStepBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }

            if (finishBtn) {
                finishBtn.classList.toggle('hidden', currentStep !== totalSteps);
            }
        }

        // Create Component Modal Functionality
        document.addEventListener('DOMContentLoaded', function() {
            const createComponentModal = document.getElementById('create-component-modal');
            const createComponentBtn = document.getElementById('create-component-btn');
            const closeCreateComponentModal = document.getElementById('close-create-component-modal');
            const nextStepBtn = document.getElementById('next-step-btn');
            const prevStepBtn = document.getElementById('prev-step-btn');
            const finishBtn = document.getElementById('finish-btn');

            // Initialize wizard state
            const totalSteps = 5;







            // Close modal
            if (closeCreateComponentModal) {
                closeCreateComponentModal.addEventListener('click', function() {
                    if (createComponentModal) {
                        createComponentModal.classList.add('hidden');
                        document.body.style.overflow = '';
                    }
                });
            }



            // Navigation buttons
            if (nextStepBtn) {
                nextStepBtn.addEventListener('click', function() {
                    if (currentStep < totalSteps) {
                        // Validate current step before allowing progression
                        let canProceed = false;
                        
                        if (currentStep === 1) {
                            canProceed = validateStep1Fields();
                        } else if (currentStep === 2) {
                            canProceed = validateStep2Fields();
                        } else if (currentStep === 3) {
                            canProceed = validateStep3Fields() && validateStep3DataMapping();
                        } else if (currentStep === 4) {
                            canProceed = validateStep4Fields();
                        } else if (currentStep === 5) {
                            // Step 5 (Access) is always valid since it's optional
                            canProceed = true;
                        }
                        
                        if (canProceed) {
                            currentStep++;
                            updateWizardState();
                        }
                    }
                });
            }







            // Add event listeners for Step 1 validation
            const componentName = document.getElementById('component-name');
            const componentDescription = document.getElementById('component-description');
            const componentCategory = document.getElementById('component-category');

            if (componentName) {
                componentName.addEventListener('input', function() {
                    validateStep1();
                    updateWizardState();
                });
                componentName.addEventListener('blur', function() {
                    validateStep1();
                    updateWizardState();
                });
            }

            if (componentDescription) {
                componentDescription.addEventListener('input', function() {
                    validateStep1();
                    updateWizardState();
                });
                componentDescription.addEventListener('blur', function() {
                    validateStep1();
                    updateWizardState();
                });
            }

            if (componentCategory) {
                componentCategory.addEventListener('change', function() {
                    validateStep1();
                    updateWizardState();
                });
            }

            // Add event listeners for Step 4 validation (Configuration)
            const colorScheme = document.getElementById('color-scheme');
            if (colorScheme) {
                colorScheme.addEventListener('change', function() {
                    updateWizardState();
                });
            }



            // Data source option click handlers
            document.querySelectorAll('.data-source-option').forEach(option => {
                option.addEventListener('click', function() {
                    const dataType = this.getAttribute('data-type');
                    selectedDataSourceType = dataType;

                    // Hide query field when data source type changes
                    const queryField = document.getElementById('database-query-field');
                    if (queryField) {
                        queryField.classList.add('hidden');
                    }
                    
                    // Update selected state
                    document.querySelectorAll('.data-source-option').forEach(opt => {
                        opt.classList.remove('selected', 'border-blue-500');
                        opt.classList.add('border-gray-600');
                    });
                    this.classList.add('selected', 'border-blue-500');
                    this.classList.remove('border-gray-600');
                    
                    // Show sub-step 2
                    document.getElementById('data-source-substep-1').classList.add('hidden');
                    document.getElementById('data-source-substep-2').classList.remove('hidden');
                    
                    // Update header with selected type, icon, and label
                    const selectedTypeSpan = document.getElementById('selected-data-source-type');
                    const selectedIcon = document.getElementById('selected-data-source-icon');
                    const selectedLabel = document.getElementById('selected-data-source-label');
                    
                    if (selectedTypeSpan) {
                        selectedTypeSpan.textContent = dataType.charAt(0).toUpperCase() + dataType.slice(1);
                    }
                    
                    if (selectedIcon && selectedLabel) {
                        let iconName = '';
                        let labelText = '';
                        
                        if (dataType === 'database') {
                            iconName = 'storage';
                            labelText = 'Database';
                        } else if (dataType === 'api') {
                            iconName = 'api';
                            labelText = 'API';
                        } else if (dataType === 'file') {
                            iconName = 'upload_file';
                            labelText = 'File Upload';
                        } else if (dataType === 'ai-model') {
                            iconName = 'auto_awesome';
                            labelText = 'AI Model';
                        }
                        
                        selectedIcon.textContent = iconName;
                        selectedIcon.className = `material-symbols-outlined mr-3 text-xl ${dataType === 'database' ? 'text-blue-400' : dataType === 'api' ? 'text-green-400' : dataType === 'file' ? 'text-purple-400' : 'text-orange-400'}`;
                        selectedLabel.textContent = labelText;
                    }
                    
                    // Show appropriate configuration (only within Create Component modal)
                    document.querySelectorAll('#create-component-modal .data-source-config').forEach(config => {
                        config.classList.add('hidden');
                    });
                    
                    const configElement = document.getElementById(dataType + '-config');
                    if (configElement) {
                        configElement.classList.remove('hidden');
                        
                        // If AI Model is selected, reset selection and update display
                        if (dataType === 'ai-model') {
                            selectedAiModel = null;
                            updateSelectedAiModelDisplay();
                            validateStep2();
                            updateWizardState();
                        } else if (dataType === 'database') {
                            selectedDatabase = null;
                            updateSelectedDatabaseDisplay();
                            validateStep2();
                            updateWizardState();
                        } else if (dataType === 'api') {
                            selectedApi = null;
                            updateSelectedApiDisplay();
                            validateStep2();
                            updateWizardState();
                        }
                    }
                    
                                            // Set current step to 2 for Data Source
                        currentStep = 2;
                        
                        // Run validation and update wizard state
                        validateStep2();
                        updateWizardState();
                });
            });

            // Visualization subtype card click handlers
            document.querySelectorAll('.visualization-subtype-card').forEach(card => {
                card.addEventListener('click', function() {
                    const visualizationType = this.getAttribute('data-type');
                    const visualizationSubtype = this.getAttribute('data-subtype');
                    
                    selectedVisualizationType = visualizationType;
                    
                    // Set the appropriate subtype based on type
                    if (visualizationType === 'chart') {
                        selectedChartSubtype = visualizationSubtype;
                    } else if (visualizationType === 'map-layer') {
                        selectedMapLayerSubtype = visualizationSubtype;
                    } else if (visualizationType === 'kpi') {
                        selectedKpiSubtype = visualizationSubtype;
                    }
                    
                    // Update selected state
                    document.querySelectorAll('.visualization-subtype-card').forEach(card => {
                        card.classList.remove('selected', 'border-blue-500');
                        card.classList.add('border-gray-600');
                    });
                    this.classList.add('selected', 'border-blue-500');
                    this.classList.remove('border-gray-600');
                    
                    // Show sub-step 2
                    document.getElementById('visualization-substep-1').classList.add('hidden');
                    document.getElementById('visualization-substep-2').classList.remove('hidden');
                    
                    // Update header with selected subtype, icon, and label
                    const selectedIcon = document.getElementById('selected-visualization-icon');
                    const selectedLabel = document.getElementById('selected-visualization-label');
                    
                    if (selectedIcon && selectedLabel) {
                        let iconName = '';
                        let labelText = '';
                        
                        // Set subtype-specific icon and label
                        if (visualizationType === 'chart') {
                            switch (visualizationSubtype) {
                                case 'horizontal-bar':
                                    iconName = 'bar_chart';
                                    labelText = 'Horizontal Bar Chart';
                                    break;
                                case 'vertical-bar':
                                    iconName = 'bar_chart';
                                    labelText = 'Vertical Bar Chart';
                                    break;
                                case 'line':
                                    iconName = 'show_chart';
                                    labelText = 'Line Chart';
                                    break;
                                case 'area':
                                    iconName = 'area_chart';
                                    labelText = 'Area Chart';
                                    break;
                                case 'scatter-plot':
                                    iconName = 'scatter_plot';
                                    labelText = 'Scatter Plot';
                                    break;
                                case 'donut':
                                    iconName = 'donut_large';
                                    labelText = 'Donut Chart';
                                    break;
                                case 'radial':
                                    iconName = 'radar';
                                    labelText = 'Radial Chart';
                                    break;
                                default:
                            iconName = 'bar_chart';
                            labelText = 'Chart';
                            }
                        } else if (visualizationType === 'map-layer') {
                            switch (visualizationSubtype) {
                                case 'heatmap':
                                    iconName = 'gradient';
                                    labelText = 'Heatmap';
                                    break;
                                case 'area':
                                    iconName = 'landscape';
                                    labelText = 'Area Map';
                                    break;
                                case 'disc':
                                    iconName = 'circle';
                                    labelText = 'Disc Map';
                                    break;
                                case 'pillar':
                                    iconName = 'signal_cellular_alt_2_bar';
                                    labelText = 'Pillar Map';
                                    break;
                                case 'arcs':
                                    iconName = 'looks';
                                    labelText = 'Arcs Map';
                                    break;
                                default:
                            iconName = 'map';
                            labelText = 'Map Layer';
                            }
                        } else if (visualizationType === 'kpi') {
                            iconName = '1k';
                            labelText = 'KPI';
                        }
                        
                        selectedIcon.textContent = iconName;
                        // Add rotate-90 class for horizontal bar chart
                        const rotationClass = (visualizationType === 'chart' && visualizationSubtype === 'horizontal-bar') ? 'rotate-90' : '';
                        selectedIcon.className = `material-symbols-outlined mr-3 text-xl text-blue-400 ${rotationClass}`;
                        selectedLabel.textContent = labelText;
                    }
                    
                    // Show appropriate configuration (only within Create Component modal)
                    document.querySelectorAll('#create-component-modal .visualization-config').forEach(config => {
                        config.classList.add('hidden');
                    });
                    
                    const configElement = document.getElementById(visualizationType + '-config');
                    if (configElement) {
                        configElement.classList.remove('hidden');
                        
                        // Show data mapping immediately after subtype selection
                            const dataMappingConfig = document.getElementById('data-mapping-config');
                            if (dataMappingConfig) {
                                dataMappingConfig.classList.remove('hidden');
                                generateDataMappingFields();
                        }
                        
                        // Reset data mapping selections
                        selectedXAxisField = null;
                        selectedYAxisField = null;
                        selectedValueField = null;
                        selectedKpiField = null;
                        selectedSeriesFields = [];
                        selectedYAxisFields = [];
                        selectedLabelField = null;
                        
                        // Set current step to 3 for Visualization
                        currentStep = 3;
                        
                        // Run validation and update wizard state
                        validateStep3();
                        updateWizardState();
                    }
                });
            });

            // Change visualization button
            const changeVisualizationBtn = document.getElementById('change-visualization-btn');
            if (changeVisualizationBtn) {
                changeVisualizationBtn.addEventListener('click', function() {
                    // Go back to sub-step 1
                    document.getElementById('visualization-substep-2').classList.add('hidden');
                    document.getElementById('visualization-substep-1').classList.remove('hidden');
                    
                    // Clear selected state
                    document.querySelectorAll('.visualization-subtype-card').forEach(card => {
                        card.classList.remove('selected', 'border-blue-500');
                        card.classList.add('border-gray-600');
                    });
                    
                    selectedVisualizationType = null;
                    selectedChartSubtype = null;
                    selectedMapLayerSubtype = null;
                    selectedKpiSubtype = null;
                    selectedXAxisField = null;
                    selectedYAxisField = null;
                    selectedValueField = null;
                    selectedKpiField = null;
                    selectedSeriesFields = [];
                    selectedYAxisFields = [];
                    selectedLabelField = null;
                    
                    // Subtype selection now handled by cards - no dropdowns to reset
                    
                    validateStep3();
                    updateWizardState();
                });
            }

            // Subtype selection now handled by card clicks - no dropdown event listeners needed



            // Change data source button
            const changeDataSourceBtn = document.getElementById('change-data-source-btn');
            if (changeDataSourceBtn) {
                changeDataSourceBtn.addEventListener('click', function() {
                    // Go back to sub-step 1
                    document.getElementById('data-source-substep-2').classList.add('hidden');
                    document.getElementById('data-source-substep-1').classList.remove('hidden');
                    
                    // Clear selected state
                    document.querySelectorAll('.data-source-option').forEach(opt => {
                        opt.classList.remove('selected', 'border-blue-500');
                        opt.classList.add('border-gray-600');
                    });
                    
                    selectedDataSourceType = null;
                    selectedAiModel = null;
                    selectedDatabase = null;
                    selectedApi = null;
                    updateSelectedAiModelDisplay();
                    updateSelectedDatabaseDisplay();
                    updateSelectedApiDisplay();
                    validateStep2();
                    updateWizardState();
                });
            }

            // Add event listeners for Step 2 validation
            const databaseFields = ['database-type', 'database-host', 'database-port', 'database-name', 'database-username', 'database-password'];
            const apiFields = ['api-url', 'api-auth-method', 'api-token'];

            // Database field validation
            databaseFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        validateStep2();
                        updateWizardState();
                    });
                    field.addEventListener('blur', function() {
                        validateStep2();
                        updateWizardState();
                    });
                    field.addEventListener('change', function() {
                        validateStep2();
                        updateWizardState();
                    });
                }
            });

            // API field validation
            apiFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.addEventListener('input', function() {
                        validateStep2();
                        updateWizardState();
                    });
                    field.addEventListener('blur', function() {
                        validateStep2();
                        updateWizardState();
                    });
                    field.addEventListener('change', function() {
                        validateStep2();
                        updateWizardState();
                    });
                }
            });

            // API authentication method change handler
            const apiAuthMethod = document.getElementById('api-auth-method');
            if (apiAuthMethod) {
                apiAuthMethod.addEventListener('change', function() {
                    const apiAuthFields = document.getElementById('api-auth-fields');
                    if (apiAuthFields) {
                        if (this.value === 'none') {
                            apiAuthFields.classList.add('hidden');
                        } else {
                            apiAuthFields.classList.remove('hidden');
                        }
                    }
                    validateStep2();
                    updateWizardState();
                });
            }

            // Use global aiModels array instead of local one

            // Use global variables instead of redeclaring
            tempSelectedAiModel = selectedAiModel;

            // AI Model Modal Functionality
            const aiModelSelectionModal = document.getElementById('ai-model-selection-modal');
            const selectAiModelBtn = document.getElementById('select-ai-model-btn');
            const changeAiModelBtn = document.getElementById('change-ai-model-btn');
            const closeAiModelModal = document.getElementById('close-ai-model-modal');
            const cancelAiModelSelection = document.getElementById('cancel-ai-model-selection');
            const confirmAiModelSelection = document.getElementById('confirm-ai-model-selection');
            const aiModelSelectionContainer = document.getElementById('ai-model-selection-container');
            const selectedAiModelDisplay = document.getElementById('selected-ai-model-display');

            function openAiModelModal() {
                aiModelSelectionModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                tempSelectedAiModel = selectedAiModel;
                populateAiModelModalList();
                updateConfirmButton();
            }

            function closeAiModelModalFunction() {
                aiModelSelectionModal.classList.add('hidden');
                document.body.style.overflow = '';
                tempSelectedAiModel = selectedAiModel; // Reset to current selection
            }

            function populateAiModelModalList(models = aiModels) {
                const aiModelModalList = document.getElementById('ai-model-modal-list');
                if (!aiModelModalList) return;

                aiModelModalList.innerHTML = '';
                
                if (models.length === 0) {
                    aiModelModalList.innerHTML = '<div class="p-4 text-center text-gray-400">No models found</div>';
                    return;
                }

                models.forEach(model => {
                    const modelItem = document.createElement('div');
                    const isSelected = tempSelectedAiModel === model.id;
                    modelItem.className = `ai-model-modal-item p-3 cursor-pointer transition duration-200 border border-gray-600 rounded-md ${isSelected ? 'bg-blue-600 border-blue-500' : 'hover:bg-gray-800'}`;
                    modelItem.setAttribute('data-model-id', model.id);
                    
                    modelItem.innerHTML = `
                        <div class="flex items-center justify-between">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <h4 class="text-white font-medium">${model.name}</h4>
                                    <span class="text-xs px-2 py-1 rounded-full bg-gray-700 text-gray-300">${model.provider}</span>
                                    <span class="text-xs px-2 py-1 rounded-full bg-gray-700 text-gray-300">${model.type}</span>
                                </div>
                                <p class="text-sm mt-1 ${isSelected ? 'text-gray-300' : 'text-gray-400'}">${model.description}</p>
                            </div>
                            ${tempSelectedAiModel === model.id ? '<span class="material-symbols-outlined text-white">check_circle</span>' : ''}
                        </div>
                    `;
                    
                    modelItem.addEventListener('click', function() {
                        // Remove previous selection
                        document.querySelectorAll('.ai-model-modal-item').forEach(item => {
                            item.classList.remove('bg-blue-600', 'border-blue-500');
                            item.classList.add('hover:bg-gray-800');
                            // Reset description text color
                            const description = item.querySelector('p');
                            if (description) {
                                description.classList.remove('text-gray-300');
                                description.classList.add('text-gray-400');
                            }
                        });
                        
                        // Set new selection
                        tempSelectedAiModel = model.id;
                        this.classList.remove('hover:bg-gray-800');
                        this.classList.add('bg-blue-600', 'border-blue-500');
                        
                        // Update description text color for selected item
                        const selectedDescription = this.querySelector('p');
                        if (selectedDescription) {
                            selectedDescription.classList.remove('text-gray-400');
                            selectedDescription.classList.add('text-gray-300');
                        }
                        
                        // Update check mark
                        document.querySelectorAll('.ai-model-modal-item .material-symbols-outlined').forEach(icon => {
                            icon.style.display = 'none';
                        });
                        const checkIcon = this.querySelector('.material-symbols-outlined');
                        if (checkIcon) {
                            checkIcon.style.display = 'block';
                        }
                        
                        updateConfirmButton();
                    });
                    
                    aiModelModalList.appendChild(modelItem);
                });
            }

            function updateConfirmButton() {
                if (confirmAiModelSelection) {
                    if (tempSelectedAiModel) {
                        confirmAiModelSelection.disabled = false;
                        confirmAiModelSelection.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        confirmAiModelSelection.disabled = true;
                        confirmAiModelSelection.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            }



            // Event Listeners for AI Model Modal
            if (selectAiModelBtn) {
                selectAiModelBtn.addEventListener('click', openAiModelModal);
            }

            if (changeAiModelBtn) {
                changeAiModelBtn.addEventListener('click', openAiModelModal);
            }

            if (closeAiModelModal) {
                closeAiModelModal.addEventListener('click', closeAiModelModalFunction);
            }

            if (cancelAiModelSelection) {
                cancelAiModelSelection.addEventListener('click', closeAiModelModalFunction);
            }

            if (confirmAiModelSelection) {
                confirmAiModelSelection.addEventListener('click', function() {
                    if (tempSelectedAiModel) {
                        selectedAiModel = tempSelectedAiModel;
                        updateSelectedAiModelDisplay();
                        closeAiModelModalFunction();
                        
                        // Run validation and update wizard state
                        validateStep2();
                        updateWizardState();
                    }
                });
            }

            // AI Model Modal Search functionality
            const aiModelModalSearch = document.getElementById('ai-model-modal-search');
            if (aiModelModalSearch) {
                aiModelModalSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    filteredAiModels = aiModels.filter(model => 
                        model.name.toLowerCase().includes(searchTerm) ||
                        model.description.toLowerCase().includes(searchTerm) ||
                        model.provider.toLowerCase().includes(searchTerm) ||
                        model.type.toLowerCase().includes(searchTerm)
                    );
                    populateAiModelModalList(filteredAiModels);
                });
            }

            // AI Model Modal Filter functionality
            const aiModelModalFilterBtn = document.getElementById('ai-model-modal-filter-btn');
            const aiModelModalFilterDropdown = document.getElementById('ai-model-modal-filter-dropdown');
            
            if (aiModelModalFilterBtn && aiModelModalFilterDropdown) {
                aiModelModalFilterBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Toggle dropdown visibility
                    const isVisible = !aiModelModalFilterDropdown.classList.contains('hidden');
                    
                    if (isVisible) {
                        // Hide dropdown
                        aiModelModalFilterDropdown.classList.add('hidden');
                        if (aiModelModalFilterDropdown.parentNode === document.body) {
                            document.body.removeChild(aiModelModalFilterDropdown);
                        }
                    } else {
                        // Show dropdown
                        aiModelModalFilterDropdown.classList.remove('hidden');
                        
                        // Append to body if not already there
                        if (aiModelModalFilterDropdown.parentNode !== document.body) {
                            document.body.appendChild(aiModelModalFilterDropdown);
                        }
                        
                        // Position the dropdown relative to the button
                        const buttonRect = aiModelModalFilterBtn.getBoundingClientRect();
                        aiModelModalFilterDropdown.style.position = 'fixed';
                        aiModelModalFilterDropdown.style.top = (buttonRect.bottom + 5) + 'px';
                        aiModelModalFilterDropdown.style.right = (window.innerWidth - buttonRect.right) + 'px';
                        aiModelModalFilterDropdown.style.zIndex = '9999';
                    }
                });

                // Close filter dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!aiModelModalFilterBtn.contains(e.target) && !aiModelModalFilterDropdown.contains(e.target)) {
                        aiModelModalFilterDropdown.classList.add('hidden');
                        if (aiModelModalFilterDropdown.parentNode === document.body) {
                            document.body.removeChild(aiModelModalFilterDropdown);
                        }
                    }
                });

                // Filter checkboxes
                const filterCheckboxes = aiModelModalFilterDropdown.querySelectorAll('input[type="checkbox"]');
                filterCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const searchTerm = aiModelModalSearch ? aiModelModalSearch.value.toLowerCase() : '';
                        const selectedFilters = Array.from(filterCheckboxes)
                            .filter(cb => cb.checked)
                            .map(cb => cb.getAttribute('data-filter'));

                        if (selectedFilters.length === 0) {
                            // No filters selected, show all models
                            filteredAiModels = aiModels.filter(model => 
                                model.name.toLowerCase().includes(searchTerm) ||
                                model.description.toLowerCase().includes(searchTerm) ||
                                model.provider.toLowerCase().includes(searchTerm) ||
                                model.type.toLowerCase().includes(searchTerm)
                            );
                        } else {
                            // Apply filters
                            filteredAiModels = aiModels.filter(model => {
                                const matchesSearch = model.name.toLowerCase().includes(searchTerm) ||
                                    model.description.toLowerCase().includes(searchTerm) ||
                                    model.provider.toLowerCase().includes(searchTerm) ||
                                    model.type.toLowerCase().includes(searchTerm);
                                
                                const matchesFilter = selectedFilters.some(filter => 
                                    model.provider === filter || model.type === filter
                                );
                                
                                return matchesSearch && matchesFilter;
                            });
                        }
                        
                        populateAiModelModalList(filteredAiModels);
                    });
                });
            }

            // Initialize Step 1 validation when modal opens
            if (createComponentBtn) {
                createComponentBtn.addEventListener('click', function() {
                    if (createComponentModal) {
                        createComponentModal.classList.remove('hidden');
                        document.body.style.overflow = 'hidden';
                        currentStep = 1;
                        updateWizardState();
                        
                        // Initialize validation after a short delay to ensure DOM is ready
                        setTimeout(validateStep1, 100);
                        
                        // Initialize component tabs after a delay to ensure DOM is ready
                        setTimeout(() => {
                            initializeComponentQueryLanguageTabs();
                            initializeComponentQueryResultsTabs();
                        }, 200);
                    }
                });
            }

            if (prevStepBtn) {
                prevStepBtn.addEventListener('click', function() {
                    if (currentStep > 1) {
                        currentStep--;
                        updateWizardState();
                    }
                });
            }

            if (finishBtn) {
                finishBtn.addEventListener('click', function() {
                    // Handle component creation
                    if (createComponentModal) {
                        createComponentModal.classList.add('hidden');
                        document.body.style.overflow = '';
                        
                        // Clear all global variables to prevent interference with Component Details modal
                        selectedXAxisField = null;
                        selectedYAxisField = null;
                        selectedValueField = null;
                        selectedKpiField = null;
                        selectedSeriesFields = [];
                        selectedFilterFields = [];
                        selectedYAxisFields = [];
                        selectedLabelField = null;
                        
                        // Open Component Details modal after a short delay
                        setTimeout(() => {
                            openComponentModal();
                        }, 100);
                    }
                });
            }

            // Step tab navigation
            const wizardStepTabs = document.querySelectorAll('.wizard-step-tab');
            if (wizardStepTabs.length > 0) {
                wizardStepTabs.forEach(tab => {
                    tab.addEventListener('click', function() {
                        const stepNumber = parseInt(this.getAttribute('data-step'));
                        
                        // Only allow navigation to enabled steps
                        if (stepNumber === 1) {
                            // Step 1 is always enabled
                            currentStep = stepNumber;
                            updateWizardState();
                        } else if (stepNumber === 2) {
                            // Step 2 is only enabled if Step 1 is complete
                            if (validateStep1Fields()) {
                                currentStep = stepNumber;
                                updateWizardState();
                            }
                        } else if (stepNumber === 3) {
                            // Step 3 is only enabled if Step 2 is complete
                            if (validateStep2Fields()) {
                                currentStep = stepNumber;
                                updateWizardState();
                            }
                        } else if (stepNumber === 4) {
                            // Step 4 is only enabled if Step 3 is complete (including data mapping)
                            if (validateStep3Fields() && validateStep3DataMapping()) {
                                currentStep = stepNumber;
                                updateWizardState();
                            }
                        } else if (stepNumber === 5) {
                            // Step 5 is enabled when Step 4 is valid (filters are optional or properly mapped)
                            const isStep3Complete = validateStep3Fields() && validateStep3DataMapping();
                            const isStep4Valid = validateStep4Fields();
                            if (isStep3Complete && isStep4Valid) {
                                currentStep = stepNumber;
                                updateWizardState();
                            }
                        }
                    });
                });
            }
        });

        // Database and API Modal Functionality
        document.addEventListener('DOMContentLoaded', function() {

            // Database Modal Functionality
            const databaseSelectionModal = document.getElementById('database-selection-modal');
            const selectDatabaseBtn = document.getElementById('select-database-btn');
            const changeDatabaseBtn = document.getElementById('change-database-btn');
            const closeDatabaseModal = document.getElementById('close-database-modal');
            const cancelDatabaseSelection = document.getElementById('cancel-database-selection');
            const confirmDatabaseSelection = document.getElementById('confirm-database-selection');
            const databaseSelectionContainer = document.getElementById('database-selection-container');
            const selectedDatabaseDisplay = document.getElementById('selected-database-display');

            // Create Database Modal
            const createDatabaseModal = document.getElementById('create-database-modal');
            const createDatabaseBtn = document.getElementById('create-database-btn');
            const closeCreateDatabaseModal = document.getElementById('close-create-database-modal');
            const cancelCreateDatabase = document.getElementById('cancel-create-database');
            const confirmCreateDatabase = document.getElementById('confirm-create-database');

            function openDatabaseModal() {
                databaseSelectionModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                tempSelectedDatabase = selectedDatabase;
                populateDatabaseModalList();
                updateDatabaseConfirmButton();
            }

            function closeDatabaseModalFunction() {
                databaseSelectionModal.classList.add('hidden');
                document.body.style.overflow = '';
                tempSelectedDatabase = selectedDatabase;
            }

            function openCreateDatabaseModal() {
                createDatabaseModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeCreateDatabaseModalFunction() {
                createDatabaseModal.classList.add('hidden');
                document.body.style.overflow = '';
            }

            function populateDatabaseModalList(models = databases) {
                const databaseModalList = document.getElementById('database-modal-list');
                if (!databaseModalList) return;

                databaseModalList.innerHTML = '';
                
                if (models.length === 0) {
                    databaseModalList.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-400">No database connections found</td></tr>';
                    return;
                }

                models.forEach(db => {
                    const dbRow = document.createElement('tr');
                    const isSelected = tempSelectedDatabase === db.id;
                    dbRow.className = `database-modal-item transition duration-200 cursor-pointer ${isSelected ? 'bg-blue-600' : 'hover:bg-gray-700'}`;
                    dbRow.setAttribute('data-database-id', db.id);
                    
                    const typeColor = db.type === 'mysql' ? 'bg-blue-900 text-blue-300' :
                                    db.type === 'postgresql' ? 'bg-purple-900 text-purple-300' :
                                    db.type === 'sqlserver' ? 'bg-red-900 text-red-300' :
                                    db.type === 'oracle' ? 'bg-orange-900 text-orange-300' :
                                    db.type === 'sqlite' ? 'bg-green-900 text-green-300' : 'bg-gray-900 text-gray-300';
                    
                    dbRow.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div>
                                <div class="flex items-center space-x-2">
                                    <div class="text-sm font-medium text-white">${db.name}</div>
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${typeColor}">${db.type.toUpperCase()}</span>
                                </div>
                                <div class="mt-1 text-gray-400">
                                    <p class="text-sm">${db.description}</p>
                                    <p class="text-xs mt-1">${db.host}:${db.port} - ${db.dbname}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-300">
                            ${db.lastUpdated || '2 hours ago'}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="relative">
                                <button class="see-details-btn w-7 h-7 flex items-center justify-center text-gray-400 hover:text-white p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-red-400" data-database-id="${db.id}">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
                                </button>
                        </div>
                        </td>
                    `;
                    
                    dbRow.addEventListener('click', function(event) {
                        // Don't select if clicking on the See Details button
                        if (event.target.closest('.see-details-btn')) {
                            return;
                        }
                        
                        // Remove previous selection
                        document.querySelectorAll('.database-modal-item').forEach(row => {
                            row.classList.remove('bg-blue-600');
                            row.classList.add('hover:bg-gray-700');
                        });
                        
                        // Set new selection
                        tempSelectedDatabase = db.id;
                        this.classList.add('bg-blue-600');
                        this.classList.remove('hover:bg-gray-700');
                        
                        updateDatabaseConfirmButton();
                    });
                    
                    databaseModalList.appendChild(dbRow);
                });
            }

            function updateDatabaseConfirmButton() {
                if (confirmDatabaseSelection) {
                    if (tempSelectedDatabase) {
                        confirmDatabaseSelection.disabled = false;
                        confirmDatabaseSelection.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        confirmDatabaseSelection.disabled = true;
                        confirmDatabaseSelection.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            }



            // API Modal Functionality
            const apiSelectionModal = document.getElementById('api-selection-modal');
            const selectApiBtn = document.getElementById('select-api-btn');
            const changeApiBtn = document.getElementById('change-api-btn');
            const closeApiModal = document.getElementById('close-api-modal');
            const cancelApiSelection = document.getElementById('cancel-api-selection');
            const confirmApiSelection = document.getElementById('confirm-api-selection');
            const apiSelectionContainer = document.getElementById('api-selection-container');
            const selectedApiDisplay = document.getElementById('selected-api-display');

            // Create API Modal
            const createApiModal = document.getElementById('create-api-modal');
            const createApiBtn = document.getElementById('create-api-btn');
            const closeCreateApiModal = document.getElementById('close-create-api-modal');
            const cancelCreateApi = document.getElementById('cancel-create-api');
            const confirmCreateApi = document.getElementById('confirm-create-api');

            function openApiModal() {
                apiSelectionModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
                tempSelectedApi = selectedApi;
                populateApiModalList();
                updateApiConfirmButton();
            }

            function closeApiModalFunction() {
                apiSelectionModal.classList.add('hidden');
                document.body.style.overflow = '';
                tempSelectedApi = selectedApi;
            }

            function openCreateApiModal() {
                createApiModal.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }

            function closeCreateApiModalFunction() {
                createApiModal.classList.add('hidden');
                document.body.style.overflow = '';
            }

            function populateApiModalList() {
                const apiModalList = document.getElementById('api-modal-list');
                if (!apiModalList) return;

                apiModalList.innerHTML = '';
                
                if (apiCollections.length === 0) {
                    apiModalList.innerHTML = '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-400">No API collections found</td></tr>';
                    return;
                }

                apiCollections.forEach(collection => {
                    // Create collection row
                    const collectionRow = document.createElement('tr');
                    collectionRow.className = 'hover:bg-gray-700 transition duration-200 api-collection-row cursor-pointer';
                    collectionRow.setAttribute('data-collection-id', collection.id);
                    
                    collectionRow.innerHTML = `
                        <td class="px-6 py-4 pl-0 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="expand-collection-indicator p-1 pr-5 pl-5 text-gray-400 hover:text-white transition duration-200 h-12 flex items-center" data-collection="${collection.id}">
                                    <span class="material-symbols-outlined text-xlg" style="transition: transform 0.2s ease-in-out;">chevron_right</span>
                                </div>
                                <div>
                                    <div class="text-sm font-medium text-white">${collection.name}</div>
                                    <div class="mt-1 text-gray-400">
                                        <p class="text-sm">${collection.description}</p>
                                </div>
                            </div>
                        </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-300">
                            ${collection.lastUpdated}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="relative">
                                <button class="see-details-btn w-7 h-7 flex items-center justify-center text-gray-400 hover:text-white p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-red-400" data-collection-id="${collection.id}">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
                                </button>
                            </div>
                        </td>
                    `;
                    
                    // Add click event for collection row expansion
                    collectionRow.addEventListener('click', function(event) {
                        // Don't expand if clicking on the See Details button
                        if (event.target.closest('.see-details-btn')) {
                            return;
                        }
                        
                        const collectionId = this.getAttribute('data-collection-id');
                        toggleApiCollection(collectionId);
                    });
                    
                    apiModalList.appendChild(collectionRow);
                    
                    // Create request rows for this collection
                    collection.requests.forEach(request => {
                        const requestRow = document.createElement('tr');
                        const isSelected = tempSelectedApi === request.id;
                        requestRow.className = `transition duration-200 api-request-row hidden cursor-pointer ${isSelected ? 'bg-blue-600' : 'hover:bg-gray-700'}`;
                        requestRow.setAttribute('data-collection', collection.id);
                        requestRow.setAttribute('data-request-id', request.id);
                        
                        const methodColor = request.method === 'GET' ? 'bg-green-900 text-green-300' : 
                                          request.method === 'POST' ? 'bg-blue-900 text-blue-300' : 
                                          request.method === 'PUT' ? 'bg-yellow-900 text-yellow-300' : 
                                          request.method === 'DELETE' ? 'bg-red-900 text-red-300' : 'bg-gray-900 text-gray-300';
                        
                        requestRow.innerHTML = `
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-10"></div>
                                    <div class="h-10 w-10 rounded-md bg-gray-600 flex items-center justify-center mr-4">
                                        <span class="material-symbols-outlined text-white" style="font-size: 20px;">api</span>
                                    </div>
                                    <div>
                                <div class="flex items-center space-x-2">
                                            <div class="text-sm font-medium text-white">${request.name}</div>
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${methodColor}">${request.method}</span>
                                </div>
                                        <div class="mt-1 text-gray-400">
                                            <p class="text-sm">${request.description}</p>
                                            <div class="flex items-center mt-1">
                                                <span class="material-symbols-outlined text-[16px] mr-1">link</span>
                                                <span class="text-xs">${request.url}</span>
                                            </div>
                                </div>
                            </div>
                        </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-300">
                                ${request.lastUpdated}
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <button class="see-details-btn text-gray-400 hover:text-white p-1 rounded-full focus:outline-none focus:ring-2 focus:ring-red-400" data-request-id="${request.id}">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">visibility</span>
                                </button>
                            </td>
                        `;
                        
                        // Add click event for request selection
                        requestRow.addEventListener('click', function(event) {
                            // Don't select if clicking on the See Details button
                            if (event.target.closest('.see-details-btn')) {
                                return;
                            }
                            
                            // Remove previous selection
                            document.querySelectorAll('.api-request-row').forEach(row => {
                                row.classList.remove('bg-blue-600');
                                row.classList.add('hover:bg-gray-700');
                        });
                        
                        // Set new selection
                            tempSelectedApi = request.id;
                            this.classList.add('bg-blue-600');
                            this.classList.remove('hover:bg-gray-700');
                        
                        updateApiConfirmButton();
                    });
                    
                        apiModalList.appendChild(requestRow);
                    });
                });
            }

            function toggleApiCollection(collectionId) {
                const expandIndicator = document.querySelector(`[data-collection="${collectionId}"].expand-collection-indicator`);
                const requestRows = document.querySelectorAll(`[data-collection="${collectionId}"].api-request-row`);
                const chevron = expandIndicator.querySelector('.material-symbols-outlined');
                
                // Check if currently expanded (any request row is visible)
                const isExpanded = Array.from(requestRows).some(row => !row.classList.contains('hidden'));
                
                if (isExpanded) {
                    // Collapse collection
                    requestRows.forEach(row => row.classList.add('hidden'));
                    // Rotate chevron back to right
                    if (chevron) {
                        chevron.style.transform = 'rotate(0deg)';
                    }
                } else {
                    // Expand collection
                    requestRows.forEach(row => row.classList.remove('hidden'));
                    // Rotate chevron down
                    if (chevron) {
                        chevron.style.transform = 'rotate(90deg)';
                    }
                }
            }

            function updateApiConfirmButton() {
                if (confirmApiSelection) {
                    if (tempSelectedApi) {
                        confirmApiSelection.disabled = false;
                        confirmApiSelection.classList.remove('opacity-50', 'cursor-not-allowed');
                    } else {
                        confirmApiSelection.disabled = true;
                        confirmApiSelection.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }
            }

            // Database Modal Filter functionality
            const databaseModalFilterBtn = document.getElementById('database-modal-filter-btn');
            const databaseModalFilterDropdown = document.getElementById('database-modal-filter-dropdown');
            
            if (databaseModalFilterBtn && databaseModalFilterDropdown) {
                databaseModalFilterBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Toggle dropdown visibility
                    const isVisible = !databaseModalFilterDropdown.classList.contains('hidden');
                    
                    if (isVisible) {
                        // Hide dropdown
                        databaseModalFilterDropdown.classList.add('hidden');
                        if (databaseModalFilterDropdown.parentNode === document.body) {
                            document.body.removeChild(databaseModalFilterDropdown);
                        }
                    } else {
                        // Show dropdown
                        databaseModalFilterDropdown.classList.remove('hidden');
                        
                        // Append to body if not already there
                        if (databaseModalFilterDropdown.parentNode !== document.body) {
                            document.body.appendChild(databaseModalFilterDropdown);
                        }
                        
                        // Position the dropdown relative to the button
                        const buttonRect = databaseModalFilterBtn.getBoundingClientRect();
                        databaseModalFilterDropdown.style.position = 'fixed';
                        databaseModalFilterDropdown.style.top = (buttonRect.bottom + 5) + 'px';
                        databaseModalFilterDropdown.style.right = (window.innerWidth - buttonRect.right) + 'px';
                        databaseModalFilterDropdown.style.zIndex = '9999';
                    }
                });

                // Close filter dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!databaseModalFilterBtn.contains(e.target) && !databaseModalFilterDropdown.contains(e.target)) {
                        databaseModalFilterDropdown.classList.add('hidden');
                        if (databaseModalFilterDropdown.parentNode === document.body) {
                            document.body.removeChild(databaseModalFilterDropdown);
                        }
                    }
                });

                // Filter checkboxes
                const databaseFilterCheckboxes = databaseModalFilterDropdown.querySelectorAll('input[type="checkbox"]');
                databaseFilterCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const searchTerm = document.getElementById('database-modal-search') ? document.getElementById('database-modal-search').value.toLowerCase() : '';
                        const selectedFilters = Array.from(databaseFilterCheckboxes)
                            .filter(cb => cb.checked)
                            .map(cb => cb.getAttribute('data-filter'));

                        if (selectedFilters.length === 0) {
                            // No filters selected, show all databases
                            filteredDatabases = databases.filter(db => 
                                db.name.toLowerCase().includes(searchTerm) ||
                                db.description.toLowerCase().includes(searchTerm) ||
                                db.type.toLowerCase().includes(searchTerm)
                            );
                        } else {
                            // Apply filters
                            filteredDatabases = databases.filter(db => {
                                const matchesSearch = db.name.toLowerCase().includes(searchTerm) ||
                                    db.description.toLowerCase().includes(searchTerm) ||
                                    db.type.toLowerCase().includes(searchTerm);
                                
                                const matchesFilter = selectedFilters.some(filter => 
                                    db.type === filter
                                );
                                
                                return matchesSearch && matchesFilter;
                            });
                        }
                        
                        populateDatabaseModalList(filteredDatabases);
                    });
                });
            }

            // API Modal Filter functionality
            const apiModalFilterBtn = document.getElementById('api-modal-filter-btn');
            const apiModalFilterDropdown = document.getElementById('api-modal-filter-dropdown');
            
            if (apiModalFilterBtn && apiModalFilterDropdown) {
                apiModalFilterBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    
                    // Toggle dropdown visibility
                    const isVisible = !apiModalFilterDropdown.classList.contains('hidden');
                    
                    if (isVisible) {
                        // Hide dropdown
                        apiModalFilterDropdown.classList.add('hidden');
                        if (apiModalFilterDropdown.parentNode === document.body) {
                            document.body.removeChild(apiModalFilterDropdown);
                        }
                    } else {
                        // Show dropdown
                        apiModalFilterDropdown.classList.remove('hidden');
                        
                        // Append to body if not already there
                        if (apiModalFilterDropdown.parentNode !== document.body) {
                            document.body.appendChild(apiModalFilterDropdown);
                        }
                        
                        // Position the dropdown relative to the button
                        const buttonRect = apiModalFilterBtn.getBoundingClientRect();
                        apiModalFilterDropdown.style.position = 'fixed';
                        apiModalFilterDropdown.style.top = (buttonRect.bottom + 5) + 'px';
                        apiModalFilterDropdown.style.right = (window.innerWidth - buttonRect.right) + 'px';
                        apiModalFilterDropdown.style.zIndex = '9999';
                    }
                });

                // Close filter dropdown when clicking outside
                document.addEventListener('click', function(e) {
                    if (!apiModalFilterBtn.contains(e.target) && !apiModalFilterDropdown.contains(e.target)) {
                        apiModalFilterDropdown.classList.add('hidden');
                        if (apiModalFilterDropdown.parentNode === document.body) {
                            document.body.removeChild(apiModalFilterDropdown);
                        }
                    }
                });

                // Filter checkboxes
                const apiFilterCheckboxes = apiModalFilterDropdown.querySelectorAll('input[type="checkbox"]');
                apiFilterCheckboxes.forEach(checkbox => {
                    checkbox.addEventListener('change', function() {
                        const searchTerm = document.getElementById('api-modal-search') ? document.getElementById('api-modal-search').value.toLowerCase() : '';
                        const selectedFilters = Array.from(apiFilterCheckboxes)
                            .filter(cb => cb.checked)
                            .map(cb => cb.getAttribute('data-filter'));

                        if (selectedFilters.length === 0) {
                            // No filters selected, show all APIs
                            filteredApis = apis.filter(api => 
                                api.name.toLowerCase().includes(searchTerm) ||
                                api.description.toLowerCase().includes(searchTerm) ||
                                api.method.toLowerCase().includes(searchTerm) ||
                                api.auth.toLowerCase().includes(searchTerm)
                            );
                        } else {
                            // Apply filters
                            filteredApis = apis.filter(api => {
                                const matchesSearch = api.name.toLowerCase().includes(searchTerm) ||
                                    api.description.toLowerCase().includes(searchTerm) ||
                                    api.method.toLowerCase().includes(searchTerm) ||
                                    api.auth.toLowerCase().includes(searchTerm);
                                
                                const matchesFilter = selectedFilters.some(filter => 
                                    api.method === filter || api.auth === filter
                                );
                                
                                return matchesSearch && matchesFilter;
                            });
                        }
                        
                        populateApiModalList(filteredApis);
                    });
                });
            }

            // Database Modal Search functionality
            const databaseModalSearch = document.getElementById('database-modal-search');
            if (databaseModalSearch) {
                databaseModalSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const selectedFilters = databaseModalFilterDropdown ? Array.from(databaseModalFilterDropdown.querySelectorAll('input[type="checkbox"]:checked'))
                        .map(cb => cb.getAttribute('data-filter')) : [];

                    if (selectedFilters.length === 0) {
                        // No filters selected, show all databases
                        filteredDatabases = databases.filter(db => 
                            db.name.toLowerCase().includes(searchTerm) ||
                            db.description.toLowerCase().includes(searchTerm) ||
                            db.type.toLowerCase().includes(searchTerm)
                        );
                    } else {
                        // Apply filters
                        filteredDatabases = databases.filter(db => {
                            const matchesSearch = db.name.toLowerCase().includes(searchTerm) ||
                                db.description.toLowerCase().includes(searchTerm) ||
                                db.type.toLowerCase().includes(searchTerm);
                            
                            const matchesFilter = selectedFilters.some(filter => 
                                db.type === filter
                            );
                            
                            return matchesSearch && matchesFilter;
                        });
                    }
                    
                    populateDatabaseModalList(filteredDatabases);
                });
            }

            // Database Modal Table event handlers
            const databaseModalTable = document.getElementById('database-modal-table');
            if (databaseModalTable) {
                databaseModalTable.addEventListener('click', function(event) {
                    // Handle See Details buttons
                    const seeDetailsBtn = event.target.closest('.see-details-btn');
                    if (seeDetailsBtn) {
                        event.stopPropagation();
                        const databaseId = seeDetailsBtn.getAttribute('data-database-id');
                        
                        if (databaseId) {
                            // Database details
                            console.log('View database details:', databaseId);
                            // TODO: Implement database details modal
                        }
                        return;
                    }
                });
            }

            // API Modal Search functionality
            const apiModalSearch = document.getElementById('api-modal-search');
            if (apiModalSearch) {
                apiModalSearch.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const selectedFilters = apiModalFilterDropdown ? Array.from(apiModalFilterDropdown.querySelectorAll('input[type="checkbox"]:checked'))
                        .map(cb => cb.getAttribute('data-filter')) : [];

                    if (selectedFilters.length === 0) {
                        // No filters selected, show all APIs
                        filteredApis = apis.filter(api => 
                            api.name.toLowerCase().includes(searchTerm) ||
                            api.description.toLowerCase().includes(searchTerm) ||
                            api.method.toLowerCase().includes(searchTerm) ||
                            api.auth.toLowerCase().includes(searchTerm)
                        );
                    } else {
                        // Apply filters
                        filteredApis = apis.filter(api => {
                            const matchesSearch = api.name.toLowerCase().includes(searchTerm) ||
                                api.description.toLowerCase().includes(searchTerm) ||
                                api.method.toLowerCase().includes(searchTerm) ||
                                api.auth.toLowerCase().includes(searchTerm);
                            
                            const matchesFilter = selectedFilters.some(filter => 
                                api.method === filter || api.auth === filter
                            );
                            
                            return matchesSearch && matchesFilter;
                        });
                    }
                    
                    populateApiModalList(filteredApis);
                });
            }

            // Event Listeners for Database Modal
            if (selectDatabaseBtn) {
                selectDatabaseBtn.addEventListener('click', openDatabaseModal);
            }

            if (changeDatabaseBtn) {
                changeDatabaseBtn.addEventListener('click', function() {
                    // Hide the query field when changing database connection
                    const queryField = document.getElementById('database-query-field');
                    if (queryField) {
                        queryField.classList.add('hidden');
                    }
                    openDatabaseModal();
                });
            }

            if (closeDatabaseModal) {
                closeDatabaseModal.addEventListener('click', closeDatabaseModalFunction);
            }

            if (cancelDatabaseSelection) {
                cancelDatabaseSelection.addEventListener('click', closeDatabaseModalFunction);
            }

            if (confirmDatabaseSelection) {
                confirmDatabaseSelection.addEventListener('click', function() {
                    if (tempSelectedDatabase) {
                        selectedDatabase = tempSelectedDatabase;
                        updateSelectedDatabaseDisplay();
                        closeDatabaseModalFunction();
                        
                        // Show connection status
                        showDatabaseConnectionStatus();
                        
                        // Run validation and update wizard state
                        validateStep2();
                        updateWizardState();
                    }
                });
            }

            // Event Listeners for Create Database Modal
            if (createDatabaseBtn) {
                createDatabaseBtn.addEventListener('click', openCreateDatabaseModal);
            }

            if (closeCreateDatabaseModal) {
                closeCreateDatabaseModal.addEventListener('click', closeCreateDatabaseModalFunction);
            }

            if (cancelCreateDatabase) {
                cancelCreateDatabase.addEventListener('click', closeCreateDatabaseModalFunction);
            }

            if (confirmCreateDatabase) {
                confirmCreateDatabase.addEventListener('click', function() {
                    // Get form values
                    const name = document.getElementById('new-database-name').value;
                    const type = document.getElementById('new-database-type').value;
                    const host = document.getElementById('new-database-host').value;
                    const port = document.getElementById('new-database-port').value;
                    const dbname = document.getElementById('new-database-dbname').value;
                    const username = document.getElementById('new-database-username').value;
                    const password = document.getElementById('new-database-password').value;

                    if (name && type && host && port && dbname && username && password) {
                        // Create new database connection
                        const newDb = {
                            id: `db-${Date.now()}`,
                            name: name,
                            type: type,
                            host: host,
                            port: port,
                            dbname: dbname,
                            username: username,
                            description: `${type} database at ${host}:${port}`
                        };

                        // Add to databases array
                        databases.push(newDb);
                        filteredDatabases = [...databases];

                        // Select the new database
                        selectedDatabase = newDb.id;
                        tempSelectedDatabase = newDb.id;

                        // Update displays
                        updateSelectedDatabaseDisplay();
                        populateDatabaseModalList();

                        // Close modals
                        closeCreateDatabaseModalFunction();
                        closeDatabaseModalFunction();

                        // Run validation and update wizard state
                        validateStep2();
                        updateWizardState();
                    }
                });
            }

            // Event Listeners for API Modal
            if (selectApiBtn) {
                selectApiBtn.addEventListener('click', openApiModal);
            }

            if (changeApiBtn) {
                changeApiBtn.addEventListener('click', openApiModal);
            }

            if (closeApiModal) {
                closeApiModal.addEventListener('click', closeApiModalFunction);
            }

            if (cancelApiSelection) {
                cancelApiSelection.addEventListener('click', closeApiModalFunction);
            }

            if (confirmApiSelection) {
                confirmApiSelection.addEventListener('click', function() {
                    if (tempSelectedApi) {
                        selectedApi = tempSelectedApi;
                        updateSelectedApiDisplay();
                        closeApiModalFunction();
                        
                        // Run validation and update wizard state
                        validateStep2();
                        updateWizardState();
                    }
                });
            }

            // API Tree Table Functionality
            const apiModalTable = document.getElementById('api-modal-table');
            if (apiModalTable) {
                // Handle See Details buttons
                apiModalTable.addEventListener('click', (event) => {
                    const seeDetailsBtn = event.target.closest('.see-details-btn');
                    if (seeDetailsBtn) {
                        event.stopPropagation();
                        const collectionId = seeDetailsBtn.getAttribute('data-collection-id');
                        const requestId = seeDetailsBtn.getAttribute('data-request-id');
                        
                        if (collectionId) {
                            // Collection details
                            console.log('View collection details:', collectionId);
                            // TODO: Implement collection details modal
                        } else if (requestId) {
                            // Request details
                            console.log('View request details:', requestId);
                            // TODO: Implement request details modal
                        }
                        return;
                    }
                });
            }

            // Event Listeners for Create API Modal
            if (createApiBtn) {
                createApiBtn.addEventListener('click', openCreateApiModal);
            }

            if (closeCreateApiModal) {
                closeCreateApiModal.addEventListener('click', closeCreateApiModalFunction);
            }

            if (cancelCreateApi) {
                cancelCreateApi.addEventListener('click', closeCreateApiModalFunction);
            }

            if (confirmCreateApi) {
                confirmCreateApi.addEventListener('click', function() {
                    // Get form values
                    const name = document.getElementById('new-api-name').value;
                    const url = document.getElementById('new-api-url').value;
                    const auth = document.getElementById('new-api-auth-method').value;
                    const method = document.getElementById('new-api-method').value;

                    if (name && url && method) {
                        // Create new API connection
                        const newApi = {
                            id: `api-${Date.now()}`,
                            name: name,
                            url: url,
                            auth: auth,
                            method: method,
                            description: `${method} API at ${url}`
                        };

                        // Add to apis array
                        apis.push(newApi);
                        filteredApis = [...apis];

                        // Select the new API
                        selectedApi = newApi.id;
                        tempSelectedApi = newApi.id;

                        // Update displays
                        updateSelectedApiDisplay();
                        populateApiModalList();

                        // Close modals
                        closeCreateApiModalFunction();
                        closeApiModalFunction();

                        // Run validation and update wizard state
                        validateStep2();
                        updateWizardState();
                    }
                });
            }

            // API Authentication method change handler for Create API Modal
            const newApiAuthMethod = document.getElementById('new-api-auth-method');
            if (newApiAuthMethod) {
                newApiAuthMethod.addEventListener('change', function() {
                    const newApiAuthFields = document.getElementById('new-api-auth-fields');
                    if (newApiAuthFields) {
                        if (this.value === 'none') {
                            newApiAuthFields.classList.add('hidden');
                        } else {
                            newApiAuthFields.classList.remove('hidden');
                        }
                    }
                });
            }
        });

        // Edit Component Modal Function (placeholder)
        function openEditComponentModal() {
            // TODO: Implement Edit Component modal
        }

        // Component Actions Dropdown Function
        function initializeComponentActionDropdown() {
            const componentDropdownBtn = document.getElementById('component-actions-dropdown-btn');
            const componentDropdown = document.getElementById('component-actions-dropdown');
            
            if (componentDropdownBtn && componentDropdown) {
                // Remove any existing event listener to avoid duplicates
                componentDropdownBtn.removeEventListener('click', handleComponentDropdownClick);
                
                // Add the event listener
                componentDropdownBtn.addEventListener('click', handleComponentDropdownClick);
            }
        }

        // Separate function for component dropdown click handler
        function handleComponentDropdownClick(event) {
            event.stopPropagation();
            
            const componentDropdown = document.getElementById('component-actions-dropdown');
            if (componentDropdown) {
                document.querySelectorAll('[id$="-dropdown"]').forEach(dropdown => {
                    if (dropdown.id !== 'component-actions-dropdown') {
                        dropdown.classList.add('hidden');
                    }
                });
                
                componentDropdown.classList.toggle('hidden');
            }
        }

        // Make functions global
        window.openEditComponentModal = openEditComponentModal;
        window.initializeComponentActionDropdown = initializeComponentActionDropdown;
    </script>

    <!-- Create Component Modal -->
    <div id="create-component-modal" class="fixed inset-0 p-10 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-xl w-11/12 h-full max-w-[1520px] flex flex-col">
            <!-- Modal Header -->
            <div class="py-4 px-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-white">Create Component</h2>
                    <button id="close-create-component-modal" class="flex items-center text-gray-400 hover:text-white transition duration-200">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
            </div>

            <!-- Wizard Steps Indicator -->
            <div class="px-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-6 user-select-none">
                        <div id="step-1-tab" class="wizard-step-tab flex flex-col items-center cursor-pointer py-3 border-b-2 border-blue-500" data-step="1">
                            <div id="step-1-indicator" class="w-8 h-8 rounded-full bg-blue-600 text-white flex items-center justify-center text-sm font-medium mb-1">1</div>
                            <span class="text-blue-400 text-xs text-center">General Info</span>
                        </div>
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-gray-600 text-lg">arrow_forward</span>
                        </div>
                        
                        <div id="step-2-tab" class="wizard-step-tab flex flex-col items-center cursor-not-allowed py-3 border-b-2 border-transparent" data-step="2">
                            <div id="step-2-indicator" class="w-8 h-8 rounded-full bg-gray-600 text-gray-400 flex items-center justify-center text-sm font-medium mb-1">2</div>
                            <span class="text-gray-400 text-xs text-center">Data Source</span>
                        </div>
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-gray-600 text-lg">arrow_forward</span>
                        </div>
                        
                        <div id="step-3-tab" class="wizard-step-tab flex flex-col items-center cursor-not-allowed py-3 border-b-2 border-transparent" data-step="3">
                            <div id="step-3-indicator" class="w-8 h-8 rounded-full bg-gray-600 text-gray-400 flex items-center justify-center text-sm font-medium mb-1">3</div>
                            <span class="text-gray-400 text-xs text-center">Visualization & Mapping</span>
                        </div>
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-gray-600 text-lg">arrow_forward</span>
                        </div>
                        
                        <div id="step-4-tab" class="wizard-step-tab flex flex-col items-center cursor-not-allowed py-3 border-b-2 border-transparent" data-step="4">
                            <div id="step-4-indicator" class="w-8 h-8 rounded-full bg-gray-600 text-gray-400 flex items-center justify-center text-sm font-medium mb-1">4</div>
                            <span class="text-gray-400 text-xs text-center">Filters</span>
                        </div>
                        <div class="flex items-center">
                            <span class="material-symbols-outlined text-gray-600 text-lg">arrow_forward</span>
                        </div>
                        
                        <div id="step-5-tab" class="wizard-step-tab flex flex-col items-center cursor-not-allowed py-3 border-b-2 border-transparent" data-step="5">
                            <div id="step-5-indicator" class="w-8 h-8 rounded-full bg-gray-600 text-gray-400 flex items-center justify-center text-sm font-medium mb-1">5</div>
                            <span class="text-gray-400 text-xs text-center">Access</span>
                        </div>

                    </div>
                </div>
            </div>

            <!-- Step Content -->
            <div class="flex flex-1 overflow-hidden">
                <!-- Left Column - Step Content -->
                <div class="w-7/12 flex flex-col">
                    <div class="flex-1 overflow-y-auto">
                <!-- Step 1: General Info -->
                <div id="step-1-content" class="wizard-step-content h-full">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-white mb-4">General Info</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Component Name <span class="text-red-400">*</span></label>
                                <input type="text" id="component-name" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter name" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Description <span class="text-red-400">*</span></label>
                                <textarea id="component-description" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" rows="3" placeholder="Enter description" required style="display: block;"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-300 mb-2">Category <span class="text-red-400">*</span></label>
                                <div class="relative">
                                    <select id="component-category" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none" required>
                                        <option value="">Select category</option>
                                        <option value="sales">Sales</option>
                                        <option value="marketing">Marketing</option>
                                        <option value="finance">Finance</option>
                                        <option value="operations">Operations</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                        <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Data Source -->
                <div id="step-2-content" class="wizard-step-content h-full hidden">
                    <!-- Sub-step 1: Select Data Source Type -->
                    <div id="data-source-substep-1" class="data-source-substep flex flex-col h-full">
                        <div class="p-6">
                            <h3 class="text-lg font-semibold text-white mb-4">Select Data Source Type</h3>
                            <div class="space-y-3">
                                <div class="data-source-option bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="database">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="material-symbols-outlined text-blue-400 mr-3 text-xl">storage</span>
                                            <div>
                                                <h4 class="text-white font-medium">Database</h4>
                                                <p class="text-gray-400 text-sm">Connect to SQL, PostgreSQL, MySQL, or other databases</p>
                                            </div>
                                        </div>
                                        <span class="material-symbols-outlined text-gray-400">arrow_forward</span>
                                    </div>
                                </div>
                                
                                <div class="data-source-option bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="api">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="material-symbols-outlined text-green-400 mr-3 text-xl">api</span>
                                            <div>
                                                <h4 class="text-white font-medium">API</h4>
                                                <p class="text-gray-400 text-sm">Connect to REST APIs, GraphQL, or web services</p>
                                            </div>
                                        </div>
                                        <span class="material-symbols-outlined text-gray-400">arrow_forward</span>
                                    </div>
                                </div>
                                
                                <div class="data-source-option bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="file">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="material-symbols-outlined text-purple-400 mr-3 text-xl">upload_file</span>
                                            <div>
                                                <h4 class="text-white font-medium">File Upload</h4>
                                                <p class="text-gray-400 text-sm">Upload CSV, Excel, JSON, or other file formats</p>
                                            </div>
                                        </div>
                                        <span class="material-symbols-outlined text-gray-400">arrow_forward</span>
                                    </div>
                                </div>
                                
                                <div class="data-source-option bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="ai-model">
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center">
                                            <span class="material-symbols-outlined text-orange-400 mr-3 text-xl">auto_awesome</span>
                                            <div>
                                                <h4 class="text-white font-medium">AI Model</h4>
                                                <p class="text-gray-400 text-sm">Select from available AI models for data processing</p>
                                            </div>
                                        </div>
                                        <span class="material-symbols-outlined text-gray-400">arrow_forward</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-step 2: Configure Selected Data Source -->
                    <div id="data-source-substep-2" class="data-source-substep flex flex-col h-full hidden">
                        <div class="p-6 pt-4">
                            <h3 class="text-sm font-medium text-gray-400 mb-2">Selected Data Source Type</h3>
                            <div class="flex items-center justify-between bg-gray-800 border border-gray-600 rounded-lg p-3">
                                <div class="flex items-center">
                                    <span id="selected-data-source-icon" class="material-symbols-outlined mr-3 text-xl"></span>
                                    <span id="selected-data-source-label" class="text-white font-medium"></span>
                                </div>
                                <button id="change-data-source-btn" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition duration-200">
                                    Change
                                </button>
                            </div>
                        </div>
                        
                        <!-- Database Configuration -->
                        <div id="database-config" class="data-source-config pb-6 hidden">
                            <div id="database-selection-container" class="px-6">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Database Connection <span class="text-red-400">*</span></label>
                                <button id="select-database-btn" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-gray-400 hover:bg-gray-700 transition duration-200 text-left flex items-center">
                                    <span class="material-symbols-outlined text-xl mr-3">storage</span>
                                    <span class="text-blue-400">Select Database Connection</span>
                                </button>
                            </div>
                            
                            <div id="selected-database-display" class="px-6 hidden">
                                <label class="block text-sm font-medium text-gray-300 mb-2">Database Connection</label>
                                <div class="flex items-center justify-between bg-gray-800 border border-gray-600 rounded-md px-3 py-2">
                                    <div class="flex items-center">
                                        <span id="selected-database-icon" class="material-symbols-outlined text-xl mr-3 text-blue-400">storage</span>
                                        <div>
                                            <div id="selected-database-name" class="text-sm text-white font-medium"></div>
                                            <div id="selected-database-details" class="text-xs text-gray-400"></div>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <div id="database-connection-status" class="hidden">
                                            <div id="database-loading-status" class="flex items-center space-x-2 text-yellow-400">
                                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-yellow-400"></div>
                                                <span class="text-sm">Connecting...</span>
                                            </div>
                                            <div id="database-success-status" class="flex items-center space-x-2 text-green-400 hidden">
                                                <span class="material-symbols-outlined text-sm">check_circle</span>
                                                <span class="text-sm">Connection established</span>
                                            </div>
                                        </div>
                                        <button id="change-database-btn" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition duration-200">
                                            Change
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Query Field (appears after successful database connection) -->
                            <div id="database-query-field" class="flex-1 flex flex-col overflow-hidden hidden">
                                <!-- Query Field -->
            
                                <div class="px-6 pt-4">
            
                                    <h3 class="font-medium text-gray-300 mb-4">Query</h3>
                                    
                                    <!-- Query Language Tabs -->
                                    <div class="flex items-center justify-between border-b border-gray-700">
                                        <nav class="flex space-x-6">
                                            <button class="query-language-tab pb-2 px-1 border-b-2 border-red-500 text-white font-medium text-sm" data-query-language-tab="sql">
                                                SQL
                                            </button>
                                            <button class="query-language-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-query-language-tab="python">
                                                Python
                                            </button>
                                        </nav>
                                        <button class="bg-red-600 hover:bg-red-700 text-white pr-4 pl-3 py-1.5 rounded-md transition duration-200 text-sm flex items-center" style="margin-top:-2.25rem;">
                                            <span class="material-symbols-outlined mr-2">play_arrow</span>
                                            Run Query
                                        </button>
                                        </div>
            
                                    </div>
            
                                <div class="px-6 pt-4 pb-6 flex-1 flex flex-col overflow-hidden">
            
                                    <div class="flex-1 overflow-y-auto">
                                
                                        <!-- SQL Query Content -->
                                        <div id="sql-query-content" class="query-language-tab-content">
                                            <div class="bg-gray-800 rounded-lg p-4 relative">
                                    <pre class="text-sm text-gray-300 font-mono">
<code>SELECT 
    g.grid_id,
    g.longitude,
    g.latitude,
    g.area_size_km2,
    p.population_count,
    p.population_count / g.area_size_km2 as population_density
FROM grid g
JOIN population_data p ON g.grid_id = p.grid_id
WHERE g.district_name = 'Abu Dhabi Island'
    AND p.date BETWEEN '2024-04-10 00:00:00' 
    AND '2024-04-12 23:59:59'
ORDER BY population_density DESC;</code></pre>
                                        </div>
                                </div>
                                    
                                    <!-- Python Query Content -->
                                    <div id="python-query-content" class="query-language-tab-content hidden">
                                        <div class="bg-gray-800 rounded-lg p-4 relative">
                                            <pre class="text-sm text-gray-300 font-mono">
<code>import pandas as pd
import sqlalchemy as sa

# Database connection
engine = sa.create_engine('mysql://app_user:secure_password_123@population-analytics-db.company.com:3306/population_analytics_db')

# Query data
query = """
SELECT 
    g.grid_id,
    g.longitude,
    g.latitude,
    g.area_size_km2,
    p.population_count,
    p.population_count / g.area_size_km2 as population_density
FROM grid g
JOIN population_data p ON g.grid_id = p.grid_id
WHERE g.district_name = 'Abu Dhabi Island'
    AND p.date BETWEEN '2024-04-10 00:00:00' 
    AND '2024-04-12 23:59:59'
ORDER BY population_density DESC
"""

df = pd.read_sql(query, engine)
print(df.head())</code></pre>
                                            </div>
                                        </div>
            
                                    </div>
                                </div>
            
                                <div class="border-b border-gray-700"></div>
            
                                <div class="h-[50%] flex flex-col overflow-hidden">
            
                                    <div class="px-6 pt-4">
            
                                        <h3 class="font-medium text-gray-300 mb-4">Results</h3>
                                
                                <!-- Database Query Results Tabs -->
                                        <div>
                                            <nav class="flex space-x-6 border-b border-gray-700">
                                                <button class="test-query-results-tab pb-2 px-1 border-b-2 border-red-500 text-white font-medium text-sm" data-test-query-results-tab="test-query-result">
                                                    Query Results
                                                </button>
                                                <button class="test-query-results-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-test-query-results-tab="test-datapoints-summary">
                                                    Datapoints Summary
                                                </button>
                                            </nav>
                                    </div>
            
                                </div>
            
                                    <div class="px-6 pt-4 flex-1 overflow-y-auto">
                                    
                                    <!-- Database Query Result Tab Content -->
                                        <div id="test-query-result-content" class="test-query-results-tab-content">
                                        <div class="bg-gray-800 rounded-lg overflow-x-auto">
                                        <table class="w-full">
                                            <thead class="border-b border-gray-700">
                                                <tr>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-300 flex items-center">
                                                        grid_id
                                                        <span class="material-symbols-outlined text-sm ml-1 text-blue-400">arrow_upward</span>
                                                    </th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-300">longitude</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-300">latitude</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-300">area_size_km2</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-300">population_count</th>
                                                    <th class="px-4 py-2 text-left text-xs font-medium text-gray-300">population_density</th>
                                                </tr>
                                            </thead>
                                            <tbody class="divide-y divide-gray-700">
                                                <tr class="hover:bg-gray-700">
                                                    <td class="px-4 py-2 text-sm text-gray-300">1</td>
                                                    <td class="px-4 py-2 text-sm text-gray-300">54.363716</td>
                                                    <td class="px-4 py-2 text-sm text-gray-300">24.488927</td>
                                                    <td class="px-4 py-2 text-sm text-gray-300">11.1</td>
                                                    <td class="px-4 py-2 text-sm text-gray-300">120,000</td>
                                                    <td class="px-4 py-2 text-sm text-gray-300">10,810</td>
                                                </tr>
                                                <tr class="hover:bg-gray-700">
                                                    <td class="px-4 py-2 text-sm text-gray-300">2</td>
                                                    <td class="px-4 py-2 text-sm text-gray-300">54.369329</td>
                                                    <td class="px-4 py-2 text-sm text-gray-300">24.481558</td>
                                                    <td class="px-4 py-2 text-sm text-gray-300">13.4</td>
                                                        <td class="px-4 py-2 text-sm text-gray-300">145,000</td>
                                                        <td class="px-4 py-2 text-sm text-gray-300">10,821</td>
                                                </tr>
                                                <tr class="hover:bg-gray-700">
                                                    <td class="px-4 py-2 text-sm text-gray-300">3</td>
                                                        <td class="px-4 py-2 text-sm text-gray-300">54.375942</td>
                                                        <td class="px-4 py-2 text-sm text-gray-300">24.474189</td>
                                                        <td class="px-4 py-2 text-sm text-gray-300">9.8</td>
                                                        <td class="px-4 py-2 text-sm text-gray-300">98,000</td>
                                                        <td class="px-4 py-2 text-sm text-gray-300">10,000</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- Database Datapoints Summary Tab Content -->
                                        <div id="test-datapoints-summary-content" class="test-query-results-tab-content hidden">
                                            <!-- Combined Data Section -->
                                            <div>
                                                <div class="grid grid-cols-4 gap-4">
                                            <!-- grid_id -->
                                                    <div class="bg-gray-800 rounded-lg p-4">
                                                <div class="text-sm font-medium text-white mb-2">grid_id</div>
                                                <div class="inline-block bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full mb-3">INT</div>
                                                <div class="grid grid-cols-3 gap-4 text-xs">
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Count</div>
                                                                <div class="text-gray-300">3</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Missing</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Zeroes</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Min</div>
                                                        <div class="text-gray-300">1</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Max</div>
                                                                <div class="text-gray-300">3</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Median</div>
                                                                <div class="text-gray-300">2.0</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- longitude -->
                                                    <div class="bg-gray-800 rounded-lg p-4">
                                                <div class="text-sm font-medium text-white mb-2">longitude</div>
                                                <div class="inline-block bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full mb-3">FLOAT</div>
                                                <div class="grid grid-cols-3 gap-4 text-xs">
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Count</div>
                                                                <div class="text-gray-300">3</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Missing</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Zeroes</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Min</div>
                                                                <div class="text-gray-300">54.364</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Max</div>
                                                                <div class="text-gray-300">54.376</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Median</div>
                                                                <div class="text-gray-300">54.369</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- latitude -->
                                                    <div class="bg-gray-800 rounded-lg p-4">
                                                <div class="text-sm font-medium text-white mb-2">latitude</div>
                                                <div class="inline-block bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full mb-3">FLOAT</div>
                                                <div class="grid grid-cols-3 gap-4 text-xs">
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Count</div>
                                                                <div class="text-gray-300">3</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Missing</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Zeroes</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Min</div>
                                                                <div class="text-gray-300">24.474</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Max</div>
                                                                <div class="text-gray-300">24.489</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Median</div>
                                                                <div class="text-gray-300">24.481</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- area_size_km2 -->
                                                    <div class="bg-gray-800 rounded-lg p-4">
                                                <div class="text-sm font-medium text-white mb-2">area_size_km2</div>
                                                <div class="inline-block bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full mb-3">FLOAT</div>
                                                <div class="grid grid-cols-3 gap-4 text-xs">
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Count</div>
                                                                <div class="text-gray-300">3</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Missing</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Zeroes</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Min</div>
                                                                <div class="text-gray-300">9.8</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Max</div>
                                                                <div class="text-gray-300">13.4</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Median</div>
                                                                <div class="text-gray-300">11.1</div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- population_count -->
                                                    <div class="bg-gray-800 rounded-lg p-4">
                                                <div class="text-sm font-medium text-white mb-2">population_count</div>
                                                <div class="inline-block bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full mb-3">INT</div>
                                                <div class="grid grid-cols-3 gap-4 text-xs">
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Count</div>
                                                                <div class="text-gray-300">3</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Missing</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Zeroes</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Min</div>
                                                                <div class="text-gray-300">98,000</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Max</div>
                                                                <div class="text-gray-300">145,000</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Median</div>
                                                                <div class="text-gray-300">120,000</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                                    <!-- population_density -->
                                                    <div class="bg-gray-800 rounded-lg p-4">
                                                        <div class="text-sm font-medium text-white mb-2">population_density</div>
                                                        <div class="inline-block bg-gray-700 text-gray-300 text-xs px-2 py-1 rounded-full mb-3">FLOAT</div>
                                                <div class="grid grid-cols-3 gap-4 text-xs">
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Count</div>
                                                                <div class="text-gray-300">3</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Missing</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Zeroes</div>
                                                        <div class="text-gray-300">0.0%</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Min</div>
                                                                <div class="text-gray-300">10,000</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Max</div>
                                                                <div class="text-gray-300">10,821</div>
                                                    </div>
                                                    <div class="space-y-1">
                                                        <div class="text-gray-400">Median</div>
                                                                <div class="text-gray-300">10,810</div>
                                                            </div>
                                                    </div>
                                                </div>
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                                    </div>
                                                </div>
                                            </div>
                                            
                        <!-- API Configuration -->
                        <div id="api-config" class="data-source-config pb-6 hidden">
                            <div id="api-selection-container" class="px-6">
                                <label class="block text-sm font-medium text-gray-300 mb-2">API Request <span class="text-red-400">*</span></label>
                                <button id="select-api-btn" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-gray-400 hover:bg-gray-700 transition duration-200 text-left flex items-center">
                                    <span class="material-symbols-outlined text-xl mr-3">api</span>
                                    <span class="text-blue-400">Select API Request</span>
                                </button>
                                                    </div>
                            
                            <div id="selected-api-display" class=" px-6 hidden">
                                <label class="block text-sm font-medium text-gray-300 mb-2">API Request</label>
                                <div class="flex items-center justify-between bg-gray-800 border border-gray-600 rounded-md px-3 py-2">
                                    <div class="flex items-center">
                                        <span id="selected-api-icon" class="material-symbols-outlined text-xl mr-3 text-blue-400">api</span>
                                        <div>
                                            <div id="selected-api-name" class="text-sm text-white font-medium"></div>
                                            <div id="selected-api-details" class="text-xs text-gray-400"></div>
                                                    </div>
                                                    </div>
                                    <div class="flex items-center space-x-4">
                                        <button class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition duration-200 text-sm flex items-center disabled:bg-gray-800 disabled:text-gray-500 disabled:cursor-not-allowed" disabled="">
                                            <span class="material-symbols-outlined mr-2" style="font-size: 18px;">refresh</span>
                                            Reset
                                        </button>
                                        <button id="change-api-btn" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition duration-200">
                                            Change
                                        </button>
                                                    </div>
                                                    </div>
                                                    </div>
                            
                            <!-- API Parameters Field (appears when API connection is selected) -->
                            <div id="api-parameters-field" class="hidden mt-6">
                                <div class="border-b border-gray-700"></div>

                                <!-- Method, URL and Send Request Bar -->
                                <div class="px-6 py-4 border-b border-gray-700 mb-4">
                                    <div class="flex items-center space-x-4">
                                        <!-- Method Dropdown -->
                                        <div class="relative">
                                            <select class="bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none min-w-[100px]">
                                                <option value="GET" selected>GET</option>
                                                <option value="POST">POST</option>
                                                <option value="PUT">PUT</option>
                                                <option value="PATCH">PATCH</option>
                                                <option value="DELETE">DELETE</option>
                                                <option value="HEAD">HEAD</option>
                                                <option value="OPTIONS">OPTIONS</option>
                                            </select>
                                            <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                                <span class="material-symbols-outlined text-gray-400 text-sm">expand_more</span>
                                                </div>
                                            </div>
                                            
                                        <!-- URL Input -->
                                        <div class="flex-1">
                                            <input type="text" value="https://weather.secureclient.com/api/v1/current?location=New York&units=metric" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter request URL">
                                                    </div>
                                        
                                        <!-- Send Request Button -->
                                        <button class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md transition duration-200 text-sm flex items-center whitespace-nowrap">
                                            <span class="material-symbols-outlined mr-2" style="font-size: 18px;">send</span>
                                            Send
                                        </button>
                                                    </div>
                                                    </div>
                                
                                <!-- Request and Response Section -->
                                <!-- Request Section -->
                                
                                
                                <!-- Request Tabs Navigation -->
                                <div class="px-6">
                                    <div class="mb-4">
                                        <h3 class="font-medium text-gray-300">Request</h3>
                                                    </div>
                                    <nav class="flex space-x-6 border-b border-gray-700">
                                        <button class="create-test-request-tab pb-2 px-1 border-b-2 border-red-500 text-white font-medium text-sm" data-create-test-request-tab="params">
                                            Parameters
                                        </button>
                                        <button class="create-test-request-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-create-test-request-tab="auth">
                                            Authentication
                                        </button>
                                        <button class="create-test-request-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-create-test-request-tab="headers">
                                            Headers
                                        </button>
                                        <button class="create-test-request-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-create-test-request-tab="body">
                                            Body
                                        </button>
                                        <button class="create-test-request-tab pb-2 px-1 border-b-2 border-transparent text-gray-400 hover:text-white font-medium text-sm" data-create-test-request-tab="script">
                                            Scripts
                                        </button>
                                    </nav>
                                                    </div>
                                    
                                <!-- Request Configuration Tabs -->
                                <div class="flex-1 overflow-y-auto p-6">
                                    
                                    <!-- Parameters Tab Content -->
                                    <div id="test-request-params-content" class="create-test-request-tab-content" data-create-test-request-tab="params">
                                        <div class="space-y-4">
                                            <!-- Query Params -->
                                            <div>
                                                <div class="flex items-center justify-between mb-2">
                                                    <h3 class="text-sm text-gray-500">Query Params</h3>
                                                    </div>
                                                <div class="space-y-2 border border-gray-700 p-3 rounded-md">
                                                    <div class="flex items-center space-x-2" data-index="0">
                                                        <div class="drag-handle w-6"></div>
                                                        <div class="w-9"></div>
                                                        <div class="flex-1 text-sm text-gray-500">Key</div>
                                                        <div class="flex-1 text-sm text-gray-500">Value</div>
                                                        <div class="w-8"> </div>
                                                </div>
                                                    <div class="flex items-center space-x-2 draggable-row drop-zone" data-index="0" draggable="true">
                                                        <div class="w-9 h-8 flex items-center">
                                                            <label class="toggle-switch">
                                                                <input type="checkbox" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                            </div>
                                                        <input type="text" placeholder="Key" value="location" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                        <input type="text" placeholder="Value" value="New York" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                        <div class="w-8 h-8 flex items-center">
                                                            <button class="text-red-400 hover:text-red-300 p-1 flex items-center">
                                                                <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                                                            </button>
                                            </div>
                                        </div>
                                                    <div class="flex items-center space-x-2 draggable-row drop-zone" data-index="1" draggable="true">
                                                        <div class="w-9 h-8 flex items-center">
                                                            <label class="toggle-switch">
                                                                <input type="checkbox" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                    </div>
                                                        <input type="text" placeholder="Key" value="units" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                        <input type="text" placeholder="Value" value="metric" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                        <div class="w-8 h-8 flex items-center">
                                                            <button class="text-red-400 hover:text-red-300 p-1 flex items-center">
                                                                <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                                                            </button>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center space-x-2 non-draggable" data-index="2">
                                                        <div class="drag-handle w-6 h-8 flex items-center">
                                                            <span class="material-symbols-outlined hidden" style="font-size: 20px;">drag_indicator</span>
                                                        </div>
                                                        <div class="w-9 h-8 flex items-center">
                                                            <label class="toggle-switch hidden">
                                                                <input type="checkbox" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </div>
                                                        <input type="text" placeholder="Key" value="" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                        <input type="text" placeholder="Value" value="" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                        <div class="w-8 h-8 flex items-center">
                                                            <button class="text-red-400 hover:text-red-300 p-1 flex items-center hidden">
                                                                <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                                                            </button>
                                                        </div>
                                </div>
                            </div>
                        </div>

                                            <!-- Path Variables -->
                                            <div>
                                                <div class="flex items-center justify-between mb-2">
                                                    <h3 class="text-sm text-gray-500">Path Variables</h3>
                                                        </div>
                                                <div class="space-y-2 border border-gray-700 p-3 rounded-md">
                                                    <div class="flex items-center space-x-2" data-index="0">
                                                        <div class="flex-1 text-sm text-gray-500">Key</div>
                                                        <div class="flex-1 text-sm text-gray-500">Value</div>
                                                        <div class="w-8"> </div>
                                                        </div>
                                                    <div class="flex items-center space-x-2">
                                                        <input type="text" placeholder="Key" value="" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                        <input type="text" placeholder="Value" value="" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                        <div class="w-8 h-8 flex items-center">
                                                            <button class="text-red-400 hover:text-red-300 p-1 flex items-center hidden">
                                                                <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                                </button>
                                                        </div>
                                                        </div>
                                                        </div>
                                                        </div>
                                                    </div>
                            </div>
                            
                                    <!-- Authentication Tab Content -->
                                    <div id="test-request-auth-content" class="create-test-request-tab-content hidden" data-create-test-request-tab="auth">
                                        <div class="space-y-4">
                                        <div>
                                                <label class="block text-sm text-gray-500 mb-2">Type</label>
                                                <div class="relative">
                                                    <select class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                                        <option value="inherit" selected>Inherit from Collection</option>
                                                        <option value="none">No Authentication</option>
                                                        <option value="basic">Basic Authentication</option>
                                                        <option value="apikey">API Key</option>
                                                        <option value="bearer">Bearer Token</option>
                                                        <option value="oauth2">OAuth 2.0</option>
                                                    </select>
                                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                        <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                        </div>
                                    </div>
                                            </div>
                                            <div class="text-sm text-gray-400">
                                                Currently inheriting API Key authentication from Weather Services collection.
                                            </div>
                                        </div>
                                                        </div>
                                    
                                    <!-- Headers Tab Content -->
                                    <div id="test-request-headers-content" class="create-test-request-tab-content hidden" data-create-test-request-tab="headers">
                                        <div class="border border-gray-700 p-3 rounded-md">
                                            <div class="space-y-2">
                                                <div class="flex items-center space-x-2" data-index="0">
                                                    <div class="w-6"></div>
                                                    <div class="w-9"></div>
                                                    <div class="flex-1 text-sm text-gray-500">Key</div>
                                                    <div class="flex-1 text-sm text-gray-500">Value</div>
                                                    <div class="w-8"> </div>
                                                </div>
                                                <div class="flex items-center space-x-2 draggable-row drop-zone" data-index="0" draggable="true">
                                                    <div class="w-9 h-8 flex items-center">
                                                        <label class="toggle-switch">
                                                            <input type="checkbox" checked>
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                                    </div>
                                                    <input type="text" placeholder="Key" value="User-Agent" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                    <input type="text" placeholder="Value" value="Llumen-API-Client/1.0" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                    <div class="w-8 h-8 flex items-center">
                                                        <button class="text-red-400 hover:text-red-300 p-1 flex items-center">
                                                            <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                                        </button>
                                    </div>
                                </div>
                                                <div class="flex items-center space-x-2 non-draggable" data-index="1">
                                                    <div class="drag-handle w-6 h-8 flex items-center">
                                                        <span class="material-symbols-outlined hidden" style="font-size: 20px;">drag_indicator</span>
                            </div>
                                                    <div class="w-9 h-8 flex items-center">
                                                        <label class="toggle-switch hidden">
                                                            <input type="checkbox" checked>
                                                            <span class="toggle-slider"></span>
                                                        </label>
                                        </div>
                                                    <input type="text" placeholder="Key" value="" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                    <input type="text" placeholder="Value" value="" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                    <div class="w-8 h-8 flex items-center">
                                                        <button class="text-red-400 hover:text-red-300 p-1 flex items-center hidden">
                                                            <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                                        </button>
                                        </div>
                                    </div>
                                </div>
                                    </div>
                                </div>
                                    
                                    <!-- Body Tab Content -->
                                    <div id="test-request-body-content" class="create-test-request-tab-content hidden" data-create-test-request-tab="body">
                                        <div class="space-y-4">
                                            <div>
                                                <div class="relative inline-flex">
                                                    <select class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                                        <option value="none">None</option>
                                                        <option value="form-data" selected>Form Data</option>
                                                        <option value="x-www-form-urlencoded">x-www-form-urlencoded</option>
                                                        <option value="raw">Raw</option>
                                                        <option value="binary">Binary</option>
                                                    </select>
                                                    <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                        <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                        </div>
                                    </div>
                                                        </div>
                                            <div class="border border-gray-700 p-3 rounded-md">
                                                <div class="space-y-2">
                                                    <div class="flex items-center space-x-2" data-index="0">
                                                        <div class="w-6"></div>
                                                        <div class="w-9"></div>
                                                        <div class="flex-1 text-sm text-gray-500">Key</div>
                                                        <div class="flex-1 text-sm text-gray-500">Value</div>
                                                        <div class="w-8"> </div>
                                                        </div>
                                                    <div class="flex items-center space-x-2 draggable-row drop-zone" data-index="0" draggable="true">
                                                        <div class="w-9 h-8 flex items-center">
                                                            <label class="toggle-switch">
                                                                <input type="checkbox" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </div>
                                                        <div class="flex-1 flex items-center space-x-2">
                                                            <input type="text" placeholder="Key" value="location" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                            <div class="relative">
                                                                <select class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-12 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                                                    <option value="text" selected>Text</option>
                                                                    <option value="file" >File</option>
                                                                </select>
                                                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                                    <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                        </div>
                                                        </div>
                                                        </div>
                                                        <div class="flex-1 flex items-center space-x-2">
                                                            <input type="text" placeholder="Value" value="New York" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                    </div>
                                                        <div class="w-8 h-8 flex items-center">
                                                            <button class="text-red-400 hover:text-red-300 p-1 flex items-center">
                                                                <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                                                            </button>
                                                </div>
                                                        </div>
                                                    <div class="flex items-center space-x-2 non-draggable" data-index="1">
                                                        <div class="drag-handle w-6 h-8 flex items-center">
                                                            <span class="material-symbols-outlined hidden" style="font-size: 20px;">drag_indicator</span>
                                                        </div>
                                                        <div class="w-9 h-8 flex items-center">
                                                            <label class="toggle-switch hidden">
                                                                <input type="checkbox" checked>
                                                                <span class="toggle-slider"></span>
                                                            </label>
                                                        </div>
                                                        <div class="flex-1 flex items-center space-x-2">
                                                            <input type="text" placeholder="Key" value="" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                            <div class="relative">
                                                                <select class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-12 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                                                    <option value="text" selected>Text</option>
                                                                    <option value="file" >File</option>
                                                                </select>
                                                                <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                                                    <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                                                        </div>
                                                        </div>
                                                        </div>
                                                        <div class="flex-1 flex items-center space-x-2">
                                                            <input type="text" placeholder="Value" value="" class="flex-1 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm">
                                                    </div>
                                                        <div class="w-8 h-8 flex items-center">
                                                            <button class="text-red-400 hover:text-red-300 p-1 flex items-center hidden">
                                                                <span class="material-symbols-outlined" style="font-size: 20px;">delete</span>
                                                            </button>
                                                </div>
                                                        </div>
                                                        </div>
                                                        </div>
                                                        </div>
                                                        </div>
                                                
                                    <!-- Pre-Request Script Tab Content -->
                                    <div id="test-request-script-content" class="create-test-request-tab-content hidden" data-create-test-request-tab="script">
                                        <div class="flex border border-gray-700 rounded-lg h-full overflow-hidden" style="min-height: 240px;">
                                            <!-- Script Property Tabs -->
                                            <div class="flex flex-col w-52 p-3 bg-gray-800 border-r border-gray-700">
                                                <div class="flex-1 space-y-2">
                                                    <div class="test-script-inner-tab flex items-center py-2 px-3 bg-blue-600 text-white rounded-lg transition duration-200 cursor-pointer" data-test-script-inner-tab="pre-request">
                                                        <span class="text-sm font-medium">Pre-Request</span>
                                                        </div>
                                                    <div class="test-script-inner-tab flex items-center py-2 px-3 bg-gray-700 hover:bg-gray-600 text-gray-300 rounded-lg cursor-pointer transition duration-200" data-test-script-inner-tab="post-request">
                                                        <span class="text-sm font-medium">Post-Request</span>
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                            <!-- Script Tab Content -->
                                            <div class="flex-1 p-4 overflow-auto">
                                                <!-- Pre-Request Script Content -->
                                                <div id="test-script-pre-request-content" class="test-script-inner-tab-content">
                                                    <div class="flex">
                                                        <textarea 
                                                            class="w-full h-64 bg-gray-800 border border-gray-600 rounded-md p-4 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm font-mono resize-none"
                                                            placeholder="// Access to 'llumen' object available in Llumen sandbox environment&#10;// Example:&#10;// llumen.setVariable('timestamp', Date.now());&#10;// llumen.log('Pre-request script executed');"
                                                        >// Set dynamic location based on user input
llumen.setVariable('location', 'New York');

// Log request details
llumen.log('Making weather request for: ' + llumen.getVariable('location'));
                                                        </textarea>
                                                        </div>
                                                        </div>
                                                
                                                <!-- Post-Request Script Content -->
                                                <div id="test-script-post-request-content" class="test-script-inner-tab-content hidden">
                                                    <div class="flex">
                                                        <textarea 
                                                            class="w-full h-64 bg-gray-800 border border-gray-600 rounded-md p-4 focus:outline-none focus:ring-2 focus:ring-red-500 text-sm font-mono resize-none"
                                                            placeholder="// Access to 'llumen' object available in Llumen sandbox environment&#10;// Example:&#10;// llumen.setVariable('responseTime', Date.now() - requestStartTime);&#10;// llumen.log('Post-request script executed');"
                                                        >// Process response data
const responseTime = Date.now() - llumen.getVariable('requestStartTime');
llumen.setVariable('responseTime', responseTime);

// Log response details
llumen.log('Post-request script executed. Response time: ' + responseTime + 'ms');
                                                        </textarea>
                                                        </div>
                                                        </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                
                                <!-- Response Section -->
                                <div class="border-t border-gray-700 h-[40%] flex flex-col overflow-hidden">
                                    <div class="flex items-center justify-between px-6 py-4">
                                        <h3 class="font-medium text-gray-300">Response</h3>
                                        
                                        <!-- Response Metadata -->
                                        <div class="flex items-center space-x-6 text-xs">
                                            <div class="flex items-center space-x-1">
                                                <span class="text-gray-500">Status:</span>
                                                <span class="text-green-400 font-medium">200 OK</span>
                                        </div>
                                            <div class="flex items-center space-x-1">
                                                <span class="text-gray-500">Time:</span>
                                                <span class="text-gray-300">245ms</span>
                                            </div>
                                            <div class="flex items-center space-x-1">
                                                <span class="text-gray-500">Size:</span>
                                                <span class="text-gray-300">1.2 KB</span>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Response Body -->
                                    <div class="px-6 pb-4 flex-1 flex flex-col overflow-hidden">
                                        <div class="bg-gray-800 border border-gray-600 rounded-md p-4 flex-1  overflow-y-auto">
 <pre class="text-sm text-gray-300 overflow-x-auto"><code>{
    "location": "New York",
    "temperature": 22.5,
    "humidity": 65,
    "description": "Partly cloudy",
    "wind_speed": 12.3,
    "timestamp": "2024-01-15T14:30:00Z"
}</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- File Upload Configuration -->
                        <div id="file-config" class="data-source-config hidden">
                            <div class="px-6 pb-6 space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-300 mb-2">Upload File <span class="text-red-400">*</span></label>
                                    <div class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center hover:border-gray-500 transition duration-200">
                                        <span class="material-symbols-outlined text-gray-400 text-3xl mb-2">cloud_upload</span>
                                        <p class="text-gray-400 mb-4">Drag and drop your file here, or</p>
                                        <div class="flex justify-center">
                                            <button type="button" class="flex items-center space-x-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white hover:bg-gray-700 transition duration-200 h-[38px]">
                                                <span class="material-symbols-outlined text-lg">add</span>
                                                <span class="text-sm">Select File</span>
                                            </button>
                                        </div>
                                        <p class="text-gray-500 text-sm mt-4">Maximum file size: 20MB</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Model Configuration -->
                        <div id="ai-model-config" class="data-source-config px-6 pb-6 hidden">
                            <div id="ai-model-selection-container">
                                <label class="block text-sm font-medium text-gray-300 mb-2">AI Model <span class="text-red-400">*</span></label>
                                <button id="select-ai-model-btn" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-gray-400 hover:bg-gray-700 transition duration-200 text-left flex items-center">
                                    <span class="material-symbols-outlined text-xl mr-3">auto_awesome</span>
                                    <span class="text-blue-400">Select AI Model</span>
                                </button>
                            </div>
                            
                            <div id="selected-ai-model-display" class="hidden">
                                <label class="block text-sm font-medium text-gray-300 mb-2">AI Model</label>
                                <div class="flex items-center justify-between bg-gray-800 border border-gray-600 rounded-md px-3 py-2">
                                    <div class="flex items-center">
                                        <span id="selected-ai-model-icon" class="material-symbols-outlined text-xl mr-3 text-blue-400">auto_awesome</span>
                                        <div>
                                            <div id="selected-ai-model-name" class="text-sm text-white font-medium"></div>
                                            <div id="selected-ai-model-description" class="text-xs text-gray-400"></div>
                                        </div>
                                    </div>
                                    <button id="change-ai-model-btn" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition duration-200">
                                        Change
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Visualization -->
                <div id="step-3-content" class="wizard-step-content h-full hidden">
                    <!-- Sub-step 1: Select Visualization Type -->
                    <div id="visualization-substep-1" class="visualization-substep flex flex-col h-full">
                        <div class="p-6 overflow-y-auto">
                            <h3 class="text-lg font-semibold text-white mb-6">Select Visualization Type</h3>
                            
                            <!-- Chart Section -->
                            <div class="mb-8">
                                <div class="flex items-center mb-4">
                                            <span class="material-symbols-outlined text-xl mr-3 text-blue-400">bar_chart</span>
                                    <h4 class="text-md font-semibold text-white">Chart</h4>
                                            </div>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="chart" data-subtype="horizontal-bar">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl rotate-90">bar_chart</span>
                                        </div>
                                        <div class="text-white font-medium text-sm text-center">Horizontal Bar</div>
                                    </div>
                                    
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="chart" data-subtype="vertical-bar">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">bar_chart</span>
                                        </div>
                                        <div class="text-white font-medium text-sm text-center">Vertical Bar</div>
                                </div>
                                
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="chart" data-subtype="line">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">show_chart</span>
                                            </div>
                                        <div class="text-white font-medium text-sm text-center">Line Chart</div>
                                        </div>
                                    
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="chart" data-subtype="area">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">area_chart</span>
                                    </div>
                                        <div class="text-white font-medium text-sm text-center">Area Chart</div>
                                </div>
                                
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="chart" data-subtype="scatter-plot">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">scatter_plot</span>
                                            </div>
                                        <div class="text-white font-medium text-sm text-center">Scatter Plot</div>
                                        </div>
                                    
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="chart" data-subtype="donut">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">donut_large</span>
                                    </div>
                                        <div class="text-white font-medium text-sm text-center">Donut Chart</div>
                                </div>
                                    
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="chart" data-subtype="radial">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">radar</span>
                                        </div>
                                        <div class="text-white font-medium text-sm text-center">Radial Chart</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Map Layer Section -->
                            <div class="mb-8">
                                <div class="flex items-center mb-4">
                                    <span class="material-symbols-outlined text-xl mr-3 text-blue-400">map</span>
                                    <h4 class="text-md font-semibold text-white">Map Layer</h4>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="map-layer" data-subtype="heatmap">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">gradient</span>
                                        </div>
                                        <div class="text-white font-medium text-sm text-center">Heatmap</div>
                                    </div>
                                    
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="map-layer" data-subtype="area">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">landscape</span>
                                        </div>
                                        <div class="text-white font-medium text-sm text-center">Area</div>
                                    </div>
                                    
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="map-layer" data-subtype="disc">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">circle</span>
                                        </div>
                                        <div class="text-white font-medium text-sm text-center">Disc</div>
                                    </div>
                                    
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="map-layer" data-subtype="pillar">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">signal_cellular_alt_2_bar</span>
                                        </div>
                                        <div class="text-white font-medium text-sm text-center">Pillar</div>
                                    </div>
                                    
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="map-layer" data-subtype="arcs">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">looks</span>
                                        </div>
                                        <div class="text-white font-medium text-sm text-center">Arcs</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- KPI Section -->
                            <div class="mb-8">
                                <div class="flex items-center mb-4">
                                    <span class="material-symbols-outlined text-xl mr-3 text-blue-400">1k</span>
                                    <h4 class="text-md font-semibold text-white">KPI</h4>
                                </div>
                                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <div class="visualization-subtype-card bg-gray-800 border border-gray-600 rounded-lg p-4 hover:bg-gray-700 transition duration-200 cursor-pointer" data-type="kpi" data-subtype="single">
                                        <div class="w-full h-20 bg-gray-900 rounded mb-3 flex items-center justify-center">
                                            <span class="material-symbols-outlined text-blue-400 text-4xl">1k</span>
                                        </div>
                                        <div class="text-white font-medium text-sm text-center">KPI</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Sub-step 2: Configure Selected Visualization Type -->
                    <div id="visualization-substep-2" class="visualization-substep flex flex-col h-full hidden">
                        <div class="p-6">
                            <h3 class="text-sm font-medium text-gray-400 mb-2">Selected Visualization Type</h3>
                            <div class="flex items-center justify-between bg-gray-800 border border-gray-600 rounded-lg p-3">
                                <div class="flex items-center">
                                    <span id="selected-visualization-icon" class="material-symbols-outlined mr-3 text-xl"></span>
                                    <span id="selected-visualization-label" class="text-white font-medium"></span>
                                </div>
                                <button id="change-visualization-btn" class="text-blue-400 hover:text-blue-300 text-sm font-medium transition duration-200">
                                    Change
                                </button>
                            </div>
                        </div>
                        
                        <!-- Chart Configuration -->
                        <div id="chart-config" class="visualization-config hidden">
                            <!-- Chart subtype selection removed - now handled in card selection -->
                        </div>
                        
                        <!-- Map Layer Configuration -->
                        <div id="map-layer-config" class="visualization-config hidden">
                            <!-- Map layer subtype selection removed - now handled in card selection -->
                        </div>
                        
                        <!-- KPI Configuration (no subtype needed) -->
                        <div id="kpi-config" class="visualization-config hidden">
                            
                        </div>
                        
                        <!-- Data Mapping Configuration (appears after subtype selection) -->
                        <div id="data-mapping-config" class="visualization-config px-6 pb-6 hidden">
                            <div>
                                <h4 class="text-md font-medium text-white mb-4">Mapping & Customization</h4>
                                <div id="data-mapping-fields" class="space-y-4">
                                    <!-- Dynamic fields will be populated here based on visualization type/subtype -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>



                <!-- Step 4: Configuration -->
                <div id="step-4-content" class="wizard-step-content h-full hidden">
                    <div class="p-6">
                        <div class="space-y-6">
                            <!-- Create the Add Filter field structure -->
                            <div class="relative">
                                <!-- Header with label and remove all button -->
                                <div class="flex items-center justify-between mb-3">
                                    <label class="text-lg font-semibold text-white">Filters</label>
                                    <button id="filter-field-remove-all" class="text-red-400 hover:text-red-300 text-xs font-medium transition duration-200 hidden">
                                        Remove All
                                    </button>
                                </div>
                                
                                <!-- Filter list container -->
                                <div id="filter-field-list" class="space-y-2 mb-3">
                                    <!-- Dynamic filter items will be added here -->
                                </div>
                                
                                <!-- Add Filter dropdown button -->
                                <button id="filter-field-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-2 rounded-md transition duration-200 flex items-center space-x-2 text-sm">
                                    <span class="material-symbols-outlined" style="font-size: 20px;">add</span>
                                    <span>Add Filter</span>
                                </button>
                                
                                <!-- Dropdown container -->
                                <div id="filter-field-dropdown" class="absolute z-50 bg-gray-800 border border-gray-600 rounded-md shadow-lg max-h-60 overflow-y-auto hidden mt-2" style="width: 100%; max-width: 400px;">
                                    <!-- Dynamic filter options will be added here -->
                                </div>
                                
                                <script>
                                    // Initialize filter functionality when step 4 is shown
                                    document.addEventListener('DOMContentLoaded', function() {
                                        const filterBtn = document.getElementById('filter-field-btn');
                                        const filterDropdown = document.getElementById('filter-field-dropdown');
                                        const removeAllBtn = document.getElementById('filter-field-remove-all');
                                        
                                        if (filterBtn && filterDropdown) {
                                            // Store filter options with rich metadata
                                            const filterOptions = [
                                                {
                                                    id: 'date_range_filter',
                                                    name: 'Date Range Filter',
                                                    type: 'DateRange',
                                                    icon: 'date_range',
                                                    namespace: 'date_range_filter',
                                                    description: 'Allows users to select date ranges for filtering data across time periods.'
                                                },
                                                {
                                                    id: 'location_filter',
                                                    name: 'Location Filter',
                                                    type: 'Lookup',
                                                    icon: 'location_on',
                                                    namespace: 'location_filter',
                                                    description: 'Filter data based on geographic location and coordinates.'
                                                },
                                                {
                                                    id: 'category_filter',
                                                    name: 'Category Filter',
                                                    type: 'Dropdown',
                                                    icon: 'category',
                                                    namespace: 'category_filter',
                                                    description: 'Filter data by predefined categories and classifications.'
                                                },
                                                {
                                                    id: 'range_slider_filter',
                                                    name: 'Range Slider Filter',
                                                    type: 'Slider',
                                                    icon: 'tune',
                                                    namespace: 'range_slider_filter',
                                                    description: 'Filter data using a range slider for numeric values.'
                                                },
                                                {
                                                    id: 'user_filter',
                                                    name: 'User Filter',
                                                    type: 'Text',
                                                    icon: 'person',
                                                    namespace: 'user_filter',
                                                    description: 'Filter data based on user input and text search.'
                                                }
                                            ];
                                            filterDropdown.dataset.options = JSON.stringify(filterOptions);
                                            
                                            // Add click event to filter button
                                            filterBtn.addEventListener('click', function(e) {
                                                e.stopPropagation();
                                                toggleFilterDropdown('filter-field');
                                            });
                                            
                                            // Add click event to remove all button
                                            if (removeAllBtn) {
                                                                                            removeAllBtn.addEventListener('click', function() {
                                                selectedFilterFields = [];
                                                updateFilterList();
                                                validateStep4Fields();
                                                updateWizardState();
                                            });
                                            }
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 5: Access -->
                <div id="step-5-content" class="wizard-step-content h-full hidden">
                    <div class="p-6">

                        <h3 class="text-lg font-semibold text-white mb-4">Access</h3>

                        <div class="flex items-center space-x-3 mb-6">
                            <div class="flex-1">
                                <input type="text" placeholder="Add workspaces or people" class="w-full px-3 py-1.5 h-9 bg-gray-800 border border-gray-600 rounded-md text-white text-sm placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent">
                            </div>
                            <button class="flex items-center space-x-1 px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white text-sm rounded-md transition-colors duration-200">
                                <span class="material-symbols-outlined text-[20px]">add</span>
                                <span>Invite</span>
                            </button>
                        </div>

                        <div class="space-y-4">
                            <!-- Planning Section -->
                            <div>
                                <h3 class="text-sm font-medium text-gray-300 mb-3">Planning</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <img class="h-8 w-8 rounded-full" src="https://placehold.co/32x32/555/fff?text=JD" alt="">
                                            <div>
                                                <div class="text-sm font-medium text-white flex items-center space-x-2">
                                                    <span>John Doe</span>
                                                    <span class="text-xs bg-gray-900 text-gray-300 px-2 py-1 rounded">Admin</span>
                                                </div>
                                                <div class="text-xs text-gray-400">john.doe@company.com</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-400">Full access</span>
                                            <span class="material-symbols-outlined text-gray-400 text-[20px]">expand_more</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <img class="h-8 w-8 rounded-full" src="https://placehold.co/32x32/555/fff?text=JS" alt="">
                                            <div>
                                                <div class="text-sm font-medium text-white">Jane Smith</div>
                                                <div class="text-xs text-gray-400">jane.smith@company.com</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-400">Limited access</span>
                                            <span class="material-symbols-outlined text-gray-400 text-[20px]">expand_more</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Chairman Office Section -->
                            <div>
                                <h3 class="text-sm font-medium text-gray-300 mb-3">Chairman Office</h3>
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <img class="h-8 w-8 rounded-full" src="https://placehold.co/32x32/555/fff?text=MB" alt="">
                                            <div>
                                                <div class="text-sm font-medium text-white">Mike Brown</div>
                                                <div class="text-xs text-gray-400">mike.brown@company.com</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-400">Limited access</span>
                                            <span class="material-symbols-outlined text-gray-400 text-[20px]">expand_more</span>
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg">
                                        <div class="flex items-center space-x-3">
                                            <img class="h-8 w-8 rounded-full" src="https://placehold.co/32x32/555/fff?text=SW" alt="">
                                            <div>
                                                <div class="text-sm font-medium text-white">Sarah Wilson</div>
                                                <div class="text-xs text-gray-400">sarah.wilson@company.com</div>
                                            </div>
                                        </div>
                                        <div class="flex items-center space-x-2">
                                            <span class="text-sm text-gray-400">View only</span>
                                            <span class="material-symbols-outlined text-gray-400 text-[20px]">expand_more</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                    </div>
                </div>

                <!-- Right Column - Component Preview -->
                <div class="w-5/12 bg-gray-800 p-6">
                    <h3 class="text-md font-semibold text-white mb-4">Component Preview</h3>
                    <div class="bg-gray-700 rounded-lg p-4">
                        <div class="h-48 relative">
                            <svg class="w-full h-full" viewBox="0 0 200 100">
                                <path d="M0,80 L50,20 L100,70 L150,30 L200,60" stroke="#14b8a6" stroke-width="2" fill="none"/>
                                <circle cx="50" cy="20" r="2" fill="#14b8a6"/>
                                <circle cx="100" cy="70" r="2" fill="#14b8a6"/>
                                <circle cx="150" cy="30" r="2" fill="#14b8a6"/>
                                <circle cx="200" cy="60" r="2" fill="#14b8a6"/>
                            </svg>
                            <div class="absolute bottom-0 left-0 right-0 flex justify-between text-xs text-gray-400">
                                <span>12:00 am</span>
                                <span>6:00 am</span>
                                <span>12:00 pm</span>
                                <span>6:00 pm</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-700">
                <div class="flex items-center justify-between">
                    <button id="prev-step-btn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                        Previous
                    </button>
                    <div class="flex items-center space-x-3">
                        <button id="next-step-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200">
                            Next
                        </button>
                        <button id="finish-btn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200 hidden">
                            Create Component
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Model Selection Modal -->
    <div id="ai-model-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-xl w-11/12 h-5/6 max-w-4xl flex flex-col">
            <!-- Modal Header -->
            <div class="py-4 px-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-white">Select AI Model</h2>
                    <button id="close-ai-model-modal" class="flex items-center text-gray-400 hover:text-white transition duration-200">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- Search and Filter Bar -->
                <div class="p-6 border-b border-gray-700">
                    <div class="flex items-center space-x-3">
                        <div class="flex-1 relative">
                            <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg">search</span>
                            <input type="text" id="ai-model-modal-search" class="w-full bg-gray-800 border border-gray-600 rounded-md pl-10 pr-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Search AI models...">
                        </div>
                        <div class="relative">
                            <button id="ai-model-modal-filter-btn" class="flex items-center space-x-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white hover:bg-gray-700 transition duration-200 h-[38px]">
                                <span class="material-symbols-outlined text-lg">filter_list</span>
                                <span class="text-sm">Filter</span>
                            </button>
                            <div id="ai-model-modal-filter-dropdown" class="bg-gray-800 border border-gray-600 rounded-md shadow-lg hidden min-w-48 max-h-80 overflow-auto">
                                <div class="p-3 space-y-2">
                                    <div>
                                        <label class="block text-xs font-medium text-gray-400 mb-2">Model Type</label>
                                        <div class="space-y-1">
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="predictive"> Predictive
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="nlp"> NLP
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="simulation"> Simulation
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="optimization"> Optimization
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="anomaly"> Anomaly Detection
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="diagnostic"> Diagnostic
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="computer-vision"> Computer Vision
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="analytics"> Analytics
                                            </label>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-gray-400 mb-2">Industry</label>
                                        <div class="space-y-1">
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="utility"> Utility
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="retail"> Retail
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="municipal"> Municipal
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="logistics"> Logistics
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="finance"> Finance
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="agriculture"> Agriculture
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="healthcare"> Healthcare
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="manufacturing"> Manufacturing
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="real-estate"> Real Estate
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="telecom"> Telecom
                                            </label>
                                            <label class="flex items-center text-sm">
                                                <input type="checkbox" class="mr-2" data-filter="insurance"> Insurance
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI Models List -->
                <div class="flex-1 overflow-y-auto p-6">
                    <div id="ai-model-modal-list" class="space-y-2 user-select-none">
                        <!-- AI Model items will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-700">
                <div class="flex items-center justify-end space-x-3">
                    <button id="cancel-ai-model-selection" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-ai-model-selection" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Select Model
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Database Selection Modal -->
    <div id="database-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-xl w-11/12 h-5/6 max-w-4xl flex flex-col">
            <!-- Modal Header -->
            <div class="py-4 px-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-white">Select Database Connection</h2>
                    <button id="close-database-modal" class="flex items-center text-gray-400 hover:text-white transition duration-200">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- Header with Create Button -->
                <div class="p-6 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <div class="flex-1 relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg">search</span>
                                    <input type="text" id="database-modal-search" class="w-full bg-gray-800 border border-gray-600 rounded-md pl-10 pr-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Search connections...">
                                </div>
                                <div class="relative">
                                    <button id="database-modal-filter-btn" class="flex items-center space-x-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white hover:bg-gray-700 transition duration-200 h-[38px]">
                                        <span class="material-symbols-outlined text-lg">filter_list</span>
                                        <span class="text-sm">Filter</span>
                                    </button>
                                    <div id="database-modal-filter-dropdown" class="bg-gray-800 border border-gray-600 rounded-md shadow-lg hidden min-w-48 max-h-80 overflow-auto">
                                        <div class="p-3 space-y-2">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-400 mb-2">Database Type</label>
                                                <div class="space-y-1">
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="mysql"> MySQL
                                                    </label>
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="postgresql"> PostgreSQL
                                                    </label>
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="sqlserver"> SQL Server
                                                    </label>
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="oracle"> Oracle
                                                    </label>
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="sqlite"> SQLite
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button id="create-database-btn" class="flex items-center space-x-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white hover:bg-gray-700 transition duration-200 h-[38px] ml-4">
                            <span class="material-symbols-outlined text-lg">add</span>
                            <span class="text-sm">New Connection</span>
                        </button>
                    </div>
                </div>

                <!-- Database Connections Table -->
                <div class="flex-1 overflow-hidden">
                    <div class="overflow-x-auto h-full">
                        <table id="database-modal-table" class="w-full relative overflow-y-auto">
                            <thead class="border-b border-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap w-full sticky top-0 bg-gray-900">Database Connections</th>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap sticky top-0 bg-gray-900">Last Updated</th>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap sticky top-0 bg-gray-900"></th>
                                </tr>
                            </thead>
                            <tbody id="database-modal-list" class="bg-gray-800 divide-y divide-gray-700">
                        <!-- Database connection items will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-700">
                <div class="flex items-center justify-end space-x-3">
                    <button id="cancel-database-selection" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-database-selection" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Select Connection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create Database Modal -->
    <div id="create-database-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-xl w-11/12 h-4/6 max-w-2xl flex flex-col">
            <!-- Modal Header -->
            <div class="py-4 px-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-white">Create Database Connection</h2>
                    <button id="close-create-database-modal" class="flex items-center text-gray-400 hover:text-white transition duration-200">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Connection Name <span class="text-red-400">*</span></label>
                        <input type="text" id="new-database-name" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter connection name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Database Type <span class="text-red-400">*</span></label>
                        <div class="relative">
                            <select id="new-database-type" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none" required>
                                <option value="">Select database type</option>
                                <option value="mysql">MySQL</option>
                                <option value="postgresql">PostgreSQL</option>
                                <option value="sqlserver">SQL Server</option>
                                <option value="oracle">Oracle</option>
                                <option value="sqlite">SQLite</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Host <span class="text-red-400">*</span></label>
                        <input type="text" id="new-database-host" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="localhost" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Port <span class="text-red-400">*</span></label>
                        <input type="number" id="new-database-port" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="3306" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Database Name <span class="text-red-400">*</span></label>
                        <input type="text" id="new-database-dbname" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter database name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Username <span class="text-red-400">*</span></label>
                        <input type="text" id="new-database-username" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter username" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Password <span class="text-red-400">*</span></label>
                        <input type="password" id="new-database-password" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter password" required>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-700">
                <div class="flex items-center justify-end space-x-3">
                    <button id="cancel-create-database" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-create-database" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200">
                        Create Connection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Selection Modal -->
    <div id="api-selection-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-xl w-11/12 h-5/6 max-w-[1080px] flex flex-col">
            <!-- Modal Header -->
            <div class="py-4 px-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-white">Select API Request</h2>
                    <button id="close-api-modal" class="flex items-center text-gray-400 hover:text-white transition duration-200">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-hidden flex flex-col">
                <!-- Header with Create Button -->
                <div class="p-6 border-b border-gray-700">
                    <div class="flex items-center justify-between">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <div class="flex-1 relative">
                                    <span class="material-symbols-outlined absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-lg">search</span>
                                    <input type="text" id="api-modal-search" class="w-full bg-gray-800 border border-gray-600 rounded-md pl-10 pr-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Search collections and requests...">
                                </div>
                                <div class="relative">
                                    <button id="api-modal-filter-btn" class="flex items-center space-x-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white hover:bg-gray-700 transition duration-200 h-[38px]">
                                        <span class="material-symbols-outlined text-lg">filter_list</span>
                                        <span class="text-sm">Filter</span>
                                    </button>
                                    <div id="api-modal-filter-dropdown" class="bg-gray-800 border border-gray-600 rounded-md shadow-lg hidden min-w-48 max-h-80 overflow-auto">
                                        <div class="p-3 space-y-2">
                                            <div>
                                                <label class="block text-xs font-medium text-gray-400 mb-2">Authentication</label>
                                                <div class="space-y-1">
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="none"> No Authentication
                                                    </label>
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="bearer"> Bearer Token
                                                    </label>
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="basic"> Basic Auth
                                                    </label>
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="api-key"> API Key
                                                    </label>
                                                </div>
                                            </div>
                                            <div>
                                                <label class="block text-xs font-medium text-gray-400 mb-2">Method</label>
                                                <div class="space-y-1">
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="GET"> GET
                                                    </label>
                                                    <label class="flex items-center text-sm">
                                                        <input type="checkbox" class="mr-2" data-filter="POST"> POST
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <button id="create-api-btn" class="flex items-center space-x-2 bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-white hover:bg-gray-700 transition duration-200 h-[38px] ml-4">
                            <span class="material-symbols-outlined text-lg">add</span>
                            <span class="text-sm">New Collection</span>
                        </button>
                    </div>
                </div>

                <!-- API Requests Tree Table -->
                <div class="flex-1 overflow-hidden">
                    <div class="overflow-x-auto h-full">
                        <table id="api-modal-table" class="w-full relative overflow-y-auto">
                            <thead class="border-b border-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap w-full sticky top-0 bg-gray-900">API Collections & Requests</th>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap sticky top-0 bg-gray-900">Last Updated</th>
                                    <th class="px-6 py-3 text-left text-sm font-medium text-gray-300 tracking-wider whitespace-nowrap sticky top-0 bg-gray-900"></th>
                                </tr>
                            </thead>
                            <tbody id="api-modal-list" class="bg-gray-800 divide-y divide-gray-700">
                                <!-- API Collections and Connections will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-700">
                <div class="flex items-center justify-end space-x-3">
                    <button id="cancel-api-selection" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-api-selection" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200 disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                        Select Request
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Create API Modal -->
    <div id="create-api-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-gray-900 rounded-lg shadow-xl w-11/12 h-4/6 max-w-2xl flex flex-col">
            <!-- Modal Header -->
            <div class="py-4 px-6 border-b border-gray-700">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-semibold text-white">Create API Collection</h2>
                    <button id="close-create-api-modal" class="flex items-center text-gray-400 hover:text-white transition duration-200">
                        <span class="material-symbols-outlined text-2xl">close</span>
                    </button>
                </div>
            </div>

            <!-- Modal Content -->
            <div class="flex-1 overflow-y-auto p-6">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Connection Name <span class="text-red-400">*</span></label>
                        <input type="text" id="new-api-name" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter connection name" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">API URL <span class="text-red-400">*</span></label>
                        <input type="url" id="new-api-url" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="https://api.example.com/data" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Authentication Method</label>
                        <div class="relative">
                            <select id="new-api-auth-method" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="none">No Authentication</option>
                                <option value="bearer">Bearer Token</option>
                                <option value="basic">Basic Auth</option>
                                <option value="api-key">API Key</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                    <div id="new-api-auth-fields" class="space-y-4 hidden">
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-2">API Key/Token</label>
                            <input type="password" id="new-api-token" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500" placeholder="Enter API key or token">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-300 mb-2">Request Method</label>
                        <div class="relative">
                            <select id="new-api-method" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2 pr-8 text-sm text-white focus:outline-none focus:ring-2 focus:ring-red-500 appearance-none">
                                <option value="GET">GET</option>
                                <option value="POST">POST</option>
                            </select>
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <span class="material-symbols-outlined text-gray-400 text-md">expand_more</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-6 border-t border-gray-700">
                <div class="flex items-center justify-end space-x-3">
                    <button id="cancel-create-api" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-md transition duration-200">
                        Cancel
                    </button>
                    <button id="confirm-create-api" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md transition duration-200">
                        Create Connection
                    </button>
                </div>
            </div>
        </div>
    </div>

</body>
</html> 